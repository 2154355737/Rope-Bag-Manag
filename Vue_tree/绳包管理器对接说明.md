# 绳包管理器后端对接说明

## 📋 对接概述

本文档说明如何将Vue_tree管理后台模板与绳包管理器后端进行对接，实现统一的登录认证和用户管理功能。

## 🔧 已完成的配置修改

### 1. Vite代理配置

**文件**: `vite.config.ts`

已修改开发服务器配置，添加了对绳包管理器后端的代理：

```typescript
server: {
  proxy: {
    // API代理 - 匹配 /api 开头的所有请求
    '/api': {
      target: 'http://127.0.0.1:15201',
      changeOrigin: true,
      rewrite: (path) => path
    },
    // 文件上传/下载代理 - 匹配 /uploads 开头的所有请求
    '/uploads': {
      target: 'http://127.0.0.1:15201',
      changeOrigin: true,
      rewrite: (path) => path
    }
  }
}
```

### 2. API路径更新

**文件**: `src/api/sys/user.ts`

更新了API路径以匹配绳包管理器后端：

```typescript
enum Api {
  Login = '/api/v1/auth/login',        // 登录接口
  Logout = '/api/v1/auth/logout',      // 退出接口
  GetUserInfo = '/api/v1/auth/user-info', // 获取用户信息接口
}
```

### 3. 用户数据模型适配

**文件**: `src/api/sys/model/userModel.ts`

扩展了用户模型以兼容绳包管理器的数据结构：

```typescript
export interface LoginResultModel {
  userId: string | number
  token: string
  role: RoleInfo
  user?: {
    id: number
    username: string
    email: string
    nickname?: string
    role: string
    star: number
    ban_status: string
    created_at: string
    updated_at: string
  }
}
```

### 4. 用户Store适配

**文件**: `src/store/modules/user.ts`

修改了登录和获取用户信息的逻辑，以处理绳包管理器后端的响应格式：

- 登录响应格式：`{ code: 0, message: "登录成功", data: { token, user } }`
- 用户信息响应格式：`{ code: 0, message: "success", data: { 用户信息 } }`

### 5. HTTP响应处理

**文件**: `src/utils/http/axios/index.ts`

修改了HTTP响应处理逻辑，兼容绳包管理器的响应格式：

```typescript
// 兼容绳包管理器后端的响应格式 (code: 0 表示成功)
const hasSuccess = data && Reflect.has(data, 'code') && (code === ResultEnum.SUCCESS || code === 0)
if (hasSuccess) {
  // 绳包管理器后端使用 data 字段，原模板使用 result 字段
  return data.data || result || data
}
```

## 🚀 使用方法

### 1. 启动绳包管理器后端

```bash
cd rope-manager-backend
cargo run
```

确保后端服务运行在 `http://127.0.0.1:15201`

### 2. 启动Vue_tree前端

```bash
cd Vue_tree
npm install  # 首次运行需要安装依赖
npm run dev
```

### 3. 登录测试

1. 访问前端地址（通常是 `http://localhost:3100`）
2. 使用绳包管理器的用户账号登录
3. 系统将自动处理认证和用户信息获取

## 🔐 认证流程

### 登录流程
1. 用户在前端输入用户名和密码
2. 前端调用 `/api/v1/auth/login` 接口
3. 后端验证用户凭据，返回JWT token和用户信息
4. 前端保存token到localStorage和Cookie
5. 自动跳转到管理后台主页

### 权限处理
- 绳包管理器支持的角色：`admin`、`elder`、`moderator`、`user`
- 前端会根据用户角色自动设置权限和菜单显示

## 📊 数据映射

### 绳包管理器用户 → Vue_tree用户模型

| 绳包管理器字段 | Vue_tree字段 | 说明 |
|-------------|-------------|------|
| id | userId | 用户ID |
| username | username | 用户名 |
| nickname | realName | 显示名称 |
| email | - | 邮箱地址 |
| role | roles | 用户角色 |
| star | - | 用户星级 |
| ban_status | - | 封禁状态 |

## 🐛 故障排除

### 常见问题

1. **CORS错误**
   - 确保绳包管理器后端已配置允许前端域名的CORS
   - 检查 `config.toml` 中的CORS设置

2. **登录失败**
   - 检查后端服务是否正常运行
   - 查看浏览器网络面板确认API调用
   - 检查用户名密码是否正确

3. **代理不生效**
   - 确保在开发模式下运行
   - 检查vite.config.ts中的代理配置
   - 重启前端开发服务器

### 调试技巧

1. **查看网络请求**
   ```javascript
   // 在浏览器控制台查看请求详情
   console.log('API请求:', response)
   ```

2. **查看用户状态**
   ```javascript
   // 在浏览器控制台查看用户状态
   console.log('用户信息:', userStore.getUserInfo)
   console.log('Token:', userStore.getToken)
   ```

## 📈 下一步计划

- [ ] 添加用户管理页面对接
- [ ] 添加资源包管理页面对接  
- [ ] 添加系统设置页面对接
- [ ] 添加数据统计图表对接

## 🤝 技术支持

如遇问题，请检查：
1. 后端日志：`rope-manager-backend/logs/`
2. 前端控制台错误信息
3. 网络请求响应状态

---

**对接完成日期**: 2024年1月27日  
**维护者**: AI助手 