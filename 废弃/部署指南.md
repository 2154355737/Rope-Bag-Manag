# 绳包管理器部署指南

## 📋 部署概述

本指南将帮助您在不同环境中部署绳包管理器系统。系统支持开发环境、测试环境和生产环境的部署，提供了多种部署方式以满足不同需求。

## 🏗️ 部署架构

### 标准部署架构
```
┌─────────────────┐    ┌─────────────────┐      ┌─────────────────┐
│       Nginx 反向代理│    │   Vue 前端应用   │    │   Rust 后端服务  │
│   (端口: 80)    │────│  (静态文件)      │────│  (端口: 15201)   │
│                 │    │                 │      │                 │
└─────────────────┘    └─────────────────┘      └─────────────────┘
                                │                       │
                                │                       │
                         ┌─────────────────┐    ┌─────────────────┐
                         │   静态资源文件    │    │   SQLite 数据库  │
                         │   (html/)        │    │   (data.db)     │
                         └─────────────────┘    └─────────────────┘
```

## 🚀 快速部署

### ⚡ 一键部署（推荐）

适用于开发和测试环境的快速部署：

```bash
# 1. 克隆项目
git clone <项目地址>
cd 绳包管理器

# 2. 一键启动全栈服务
start_fullstack.bat

# 3. 访问应用
# 开发环境: http://localhost:5173
# 生产环境: http://localhost
```

### 🔧 手动部署

如需更细粒度的控制，可以手动部署各个组件：

#### 步骤 1: 后端部署
```bash
cd rope-manager-backend

# 编译项目
cargo build --release

# 配置环境
copy config.example.toml config.toml
# 编辑 config.toml 设置数据库、邮件等配置

# 启动服务
target/release/rope-manager-backend
# 或开发模式: cargo run
```

#### 步骤 2: 前端构建
```bash
cd Rust_Vue

# 安装依赖
npm install

# 构建生产版本
npm run build
# 输出到 dist/ 目录
```

#### 步骤 3: Nginx部署
```bash
cd nginx-1.28.0

# 部署前端文件
deploy_frontend.bat

# 启动nginx
nginx_manager.bat start
```

## 🔧 环境配置

### 开发环境

#### 后端配置 (config.toml)
```toml
[server]
host = "127.0.0.1"
port = 15201
database_url = "data.db"

[auth]
jwt_secret = "dev-secret-key-change-in-production"
jwt_expiration = 86400

[mail]
smtp_enabled = false
smtp_server = "smtp.example.com"
smtp_port = 587
smtp_username = ""
smtp_password = ""
```

#### 前端配置 (.env.development)
```bash
VITE_API_BASE_URL=/api
VITE_APP_TITLE=绳包管理器 - 开发环境
VITE_DEBUG_API=true
```

### 生产环境

#### 后端配置 (config.toml)
```toml
[server]
host = "127.0.0.1"
port = 15201
database_url = "data.db"

[auth]
jwt_secret = "super-secure-production-secret-key"
jwt_expiration = 86400

[mail]
smtp_enabled = true
smtp_server = "smtp.your-domain.com"
smtp_port = 587
smtp_username = "noreply@your-domain.com"
smtp_password = "your-smtp-password"
smtp_from = "绳包管理器 <noreply@your-domain.com>"

[logging]
level = "info"
file = "logs/app.log"

[security]
cors_origins = ["http://your-domain.com"]
max_file_size = 104857600  # 100MB
```

#### 前端配置 (.env.production)
```bash
VITE_API_BASE_URL=/api
VITE_APP_TITLE=绳包管理器
VITE_DEBUG_API=false
```

#### Nginx配置优化
```nginx
# nginx.conf
worker_processes auto;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    # 基础配置
    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    
    # Gzip压缩
    gzip on;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    
    # 安全配置
    server_tokens off;
    client_max_body_size 100M;
    
    server {
        listen 80;
        server_name your-domain.com;
        
        # 安全头
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        
        # 静态文件
        location / {
            root html;
            index index.html;
            try_files $uri $uri/ /index.html;
            
            # 缓存配置
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }
        
        # API代理
        location /api/ {
            proxy_pass http://127.0.0.1:15201;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 超时配置
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # 文件上传
        location /uploads/ {
            proxy_pass http://127.0.0.1:15201;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # 文件传输优化
            proxy_request_buffering off;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
        
        # 健康检查
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
```

## 🗄️ 数据库设置

### 初始化数据库

```bash
# 使用提供的初始化脚本
cd rope-manager-backend
sqlite3 data.db < ../complete_database_init.sql

# 或者启动应用自动初始化
cargo run
```

### 数据库备份

```bash
# 手动备份
cp data.db "backup/data_$(date +%Y%m%d_%H%M%S).db"

# 使用内置备份功能
curl -X POST http://127.0.0.1:15201/api/v1/admin/backup \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"backup_type":"manual","description":"手动备份"}'
```

### 数据迁移

```bash
# 检查数据库结构
cargo run --bin check_db_schema

# 执行迁移脚本
sqlite3 data.db < sql/migrate_xxx.sql
```

## 🔒 安全配置

### SSL/HTTPS配置

#### 1. 获取SSL证书

**使用Let's Encrypt (推荐):**
```bash
# 安装certbot
# Windows: 下载certbot-auto
# Linux: apt-get install certbot

# 获取证书
certbot certonly --standalone -d your-domain.com
```

**自签名证书 (测试用):**
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout nginx.key -out nginx.crt
```

#### 2. Nginx SSL配置
```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    # 其他配置...
}
```

### 防火墙配置

```bash
# Windows防火墙
netsh advfirewall firewall add rule name="Rope Manager Backend" dir=in action=allow protocol=TCP localport=15201
netsh advfirewall firewall add rule name="Nginx HTTP" dir=in action=allow protocol=TCP localport=80
netsh advfirewall firewall add rule name="Nginx HTTPS" dir=in action=allow protocol=TCP localport=443

# Linux iptables
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
iptables -A INPUT -p tcp --dport 15201 -s 127.0.0.1 -j ACCEPT
```

## 🎯 性能优化

### 后端优化

#### 1. 编译优化
```toml
# Cargo.toml
[profile.release]
lto = true
codegen-units = 1
panic = 'abort'
```

#### 2. 数据库优化
```sql
-- 添加索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_packages_category ON packages(category);
CREATE INDEX idx_packages_status ON packages(status);
CREATE INDEX idx_comments_package_id ON comments(package_id);
CREATE INDEX idx_user_actions_user_id ON user_actions(user_id);

-- 定期维护
VACUUM;
REINDEX;
```

#### 3. 内存配置
```toml
# config.toml
[performance]
max_connections = 100
worker_threads = 4
keep_alive_timeout = 30
```

### 前端优化

#### 1. 构建优化
```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vue-vendor': ['vue', 'vue-router', 'pinia'],
          'element-plus': ['element-plus'],
          'echarts': ['echarts', 'vue-echarts'],
          'utils': ['axios', 'lucide-vue-next']
        }
      }
    },
    chunkSizeWarningLimit: 1000
  }
})
```

#### 2. CDN配置
```html
<!-- 使用CDN加速 -->
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">
<link rel="preconnect" href="//cdn.jsdelivr.net">
```

### Nginx优化

```nginx
# 工作进程优化
worker_processes auto;
worker_connections 2048;

# 缓存配置
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m;

location /api/ {
    proxy_cache api_cache;
    proxy_cache_valid 200 10m;
    proxy_cache_key $scheme$request_method$host$request_uri;
}

# 静态文件缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    gzip_static on;
}
```

## 🐳 Docker部署

### Docker Compose配置

```yaml
# docker-compose.yml
version: '3.8'

services:
  backend:
    build:
      context: ./rope-manager-backend
      dockerfile: Dockerfile
    ports:
      - "15201:15201"
    volumes:
      - ./data:/app/data
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    environment:
      - RUST_LOG=info
    restart: unless-stopped

  frontend:
    build:
      context: ./Rust_Vue
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./certs:/etc/nginx/certs
    depends_on:
      - backend
    restart: unless-stopped
```

### Dockerfile示例

#### 后端Dockerfile
```dockerfile
# rope-manager-backend/Dockerfile
FROM rust:1.70-slim as builder

WORKDIR /app
COPY . .
RUN cargo build --release

FROM debian:bullseye-slim
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY --from=builder /app/target/release/rope-manager-backend /usr/local/bin/
COPY --from=builder /app/config.toml .

EXPOSE 15201
CMD ["rope-manager-backend"]
```

#### 前端Dockerfile
```dockerfile
# Rust_Vue/Dockerfile
FROM node:18-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

## 📊 监控与维护

### 系统监控

#### 1. 日志监控
```bash
# 实时查看日志
tail -f rope-manager-backend/logs/app.log
tail -f nginx-1.28.0/logs/access.log
tail -f nginx-1.28.0/logs/error.log

# 日志轮转配置
# /etc/logrotate.d/rope-manager
/path/to/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
}
```

#### 2. 性能监控
```bash
# 系统资源监控
htop
iotop
netstat -tlnp

# 应用监控
ps aux | grep rope-manager
ps aux | grep nginx
```

#### 3. 健康检查
```bash
# API健康检查
curl http://localhost/health
curl http://127.0.0.1:15201/api/health

# 数据库检查
sqlite3 data.db ".schema"
```

### 定期维护

#### 1. 数据库维护
```bash
# 每周执行数据库优化
sqlite3 data.db "VACUUM; REINDEX;"

# 清理过期数据
sqlite3 data.db "DELETE FROM user_actions WHERE created_at < datetime('now', '-30 days');"
```

#### 2. 日志清理
```bash
# 清理旧日志
find logs/ -name "*.log" -mtime +30 -delete

# 清理nginx日志
nginx_manager.bat logs clean
```

#### 3. 备份计划
```bash
# 每日备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
cp data.db "backups/data_${DATE}.db"
find backups/ -name "*.db" -mtime +7 -delete
```

## 🚨 故障排除

### 常见问题

#### 1. 端口冲突
```bash
# 检查端口占用
netstat -ano | find "15201"
netstat -ano | find ":80"

# 解决方法
# - 关闭占用端口的程序
# - 修改配置文件中的端口号
```

#### 2. 权限问题
```bash
# 检查文件权限
ls -la data.db
ls -la uploads/

# 修复权限
chmod 644 data.db
chmod -R 755 uploads/
```

#### 3. 内存不足
```bash
# 检查内存使用
free -h
ps aux --sort=-%mem | head

# 优化配置
# 减少worker_connections
# 启用swap
```

#### 4. 数据库锁定
```bash
# 检查数据库连接
lsof data.db

# 解决方法
# 重启应用
# 检查长时间运行的查询
```

### 调试技巧

#### 1. 开启详细日志
```bash
# 后端详细日志
RUST_LOG=debug cargo run

# Nginx调试
nginx -t  # 测试配置
nginx -s reload  # 重载配置
```

#### 2. API测试
```bash
# 测试API连通性
curl -v http://127.0.0.1:15201/api/health

# 测试认证
curl -X POST http://127.0.0.1:15201/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

## 📞 技术支持

### 获取帮助

1. **查看日志**: 首先检查系统日志文件
2. **运行诊断**: 使用提供的管理脚本进行诊断
3. **查阅文档**: 参考开发文档和API文档
4. **社区支持**: 在项目仓库提交Issue

### 联系方式

- **项目仓库**: [GitHub链接]
- **技术文档**: [文档链接]
- **邮件支持**: support@your-domain.com

---

**部署指南版本**: v1.0  
**最后更新**: 2024年1月20日  
**维护者**: 绳包管理器开发团队 