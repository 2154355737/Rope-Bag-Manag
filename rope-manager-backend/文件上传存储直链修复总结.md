# 文件上传存储直链修复总结

## 问题分析

用户反馈：上传文件和截图后，数据库中没有正确记录实际的下载地址，而是存储了错误的路径信息。

## AList API 工作机制

根据用户提供的实际测试数据，AList的工作流程是：

### 1. 上传文件
使用 `PUT /api/fs/form` 表单上传文件

### 2. 获取文件信息和直链
使用 `POST /api/fs/get` 获取文件的详细信息，包括真实下载地址

**示例请求：**
```bash
curl 'http://alist.tiecode.org.cn/api/fs/get' \
  -H 'Authorization: [TOKEN]' \
  -H 'Content-Type: application/json;charset=UTF-8' \
  --data-raw '{"path":"/image/结绳社区/其他资源/2025-08/44-123.png","password":""}'
```

**返回数据：**
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "name": "44-123.png",
        "size": 673484,
        "raw_url": "https://pdf1.webgetstore.com/2025/08/22/86f0bc46121b86239f1f18e602f96f58.png?sg=xxx&e=xxx&fileName=44-123.png&fi=250524411",
        "provider": "Lanzou"
    }
}
```

**关键字段：`raw_url`** - 这是文件的真实下载直链地址

## 修复实现

### ✅ 1. 扩展FileInfo结构体

在 `src/services/alist_service.rs` 中更新了 `FileInfo` 结构体：

```rust
#[derive(Debug, Serialize, Deserialize)]
pub struct FileInfo {
    pub name: String,
    pub size: i64,
    pub is_dir: bool,
    pub modified: String,
    pub sign: Option<String>,
    pub thumb: Option<String>,
    #[serde(rename = "type")]
    pub type_: Option<i32>,
    pub raw_url: Option<String>, // 文件的真实下载地址
    pub provider: Option<String>, // 存储提供商
}
```

### ✅ 2. 添加获取文件信息的方法

在 `AListService` 中新增了 `get_file_info` 方法：

```rust
/// 获取文件信息，包括下载直链
pub async fn get_file_info(&mut self, file_path: &str) -> Result<FileInfo> {
    self.login().await?;

    let url = format!("{}/api/fs/get", self.base_url);
    
    let request_body = json!({
        "path": file_path,
        "password": ""
    });
    
    log::info!("🔍 获取文件信息: {}", file_path);
    
    let response = self.client
        .post(&url)
        .header("Authorization", self.token.as_ref().unwrap())
        .header("Content-Type", "application/json")
        .json(&request_body)
        .send()
        .await?;
        
    let response_text = response.text().await?;
    let result: AListResponse<FileInfo> = serde_json::from_str(&response_text)
        .map_err(|e| anyhow!("解析文件信息响应失败: {} - 响应: {}", e, response_text))?;
    
    if result.code == 200 {
        match result.data {
            Some(file_info) => {
                log::info!("✅ 获取文件信息成功: {} - 大小: {} bytes, 下载地址: {:?}", 
                         file_info.name, file_info.size, file_info.raw_url);
                Ok(file_info)
            },
            None => Err(anyhow!("文件信息为空")),
        }
    } else {
        Err(anyhow!("获取文件信息失败: {}", result.message))
    }
}
```

### ✅ 3. 修复upload_package_screenshot方法

在 `src/services/package_storage_service.rs` 中修复了截图上传：

```rust
// 获取文件信息和真实下载地址
log::info!("🔍 获取截图真实下载地址...");
let file_info = self.alist_service.get_file_info(&file_path).await?;

let download_url = file_info.raw_url.unwrap_or_else(|| {
    log::warn!("⚠️ 未获取到raw_url，使用构建的URL");
    format!("{}/{}/{}", 
        self.alist_service.base_url(),
        storage_path,
        unique_name
    )
});

log::info!("🔗 截图真实下载地址: {}", download_url);

Ok(UploadResult {
    file_path,
    download_url,
    file_size: file_info.size,
})
```

### ✅ 4. 修复upload_package_file方法

同样修复了文件上传的逻辑：

```rust
// 获取文件信息和真实下载地址
log::info!("🔍 获取文件真实下载地址...");
let file_info = self.alist_service.get_file_info(&file_path).await?;

let download_url = file_info.raw_url.unwrap_or_else(|| {
    log::warn!("⚠️ 未获取到raw_url，使用AList标记");
    format!("alist:{}", file_path)
});

let result = UploadResult {
    file_path: file_path.clone(),
    download_url,
    file_size: file_info.size,
};
```

### ✅ 5. 修复数据库存储问题

之前的修复已经确保：
- **文件上传**：`file_url` 和 `file_size` 字段正确更新
- **截图上传**：`screenshots` 数组正确更新
- **序列化修复**：空数组而不是 `null`

## 完整的数据流程

### 发布资源流程：
1. **前端发布**：调用 `/publish/resource` API
2. **创建记录**：在数据库创建Package记录（包含requirements）
3. **上传文件**：调用 `/storage/upload` 上传资源文件
4. **获取直链**：通过AList `/api/fs/get` 获取 `raw_url`
5. **更新记录**：将 `raw_url` 更新到Package的 `file_url` 字段

### 上传截图流程：
1. **上传截图**：调用 `/storage/upload` 上传截图文件
2. **获取直链**：通过AList `/api/fs/get` 获取 `raw_url`  
3. **更新记录**：将 `raw_url` 添加到Package的 `screenshots` 数组

## 数据示例

### 修复前（错误）：
```json
{
  "file_url": "/image/结绳社区/其他资源/2025-08/44-123.png",
  "screenshots": ["/image/结绳社区/其他资源/2025-08/44-screenshot.png"],
  "requirements": null,
  "file_size": 105126
}
```

### 修复后（正确）：
```json
{
  "file_url": "https://pdf1.webgetstore.com/2025/08/22/86f0bc46121b86239f1f18e602f96f58.png?sg=xxx&fileName=44-123.png",
  "screenshots": ["https://pdf1.webgetstore.com/2025/08/22/xxx.png?sg=xxx&fileName=44-screenshot.png"],
  "requirements": ["Windows 10+", "4GB内存", "100MB空间"],
  "file_size": 673484
}
```

## 关键修复点总结

1. ✅ **添加AList文件信息获取接口**
2. ✅ **修改上传逻辑获取真实下载地址** 
3. ✅ **确保数据库存储的是直链而不是内部路径**
4. ✅ **处理文件和截图的不同存储路径**
5. ✅ **修复数据库字段缺失问题**
6. ✅ **修复序列化空值问题**
7. ✅ **修复分类ID处理问题**

## 测试验证

建议测试场景：
1. ✅ 发布带有系统要求的资源
2. ✅ 上传资源文件并验证获取到真实下载地址
3. ✅ 上传预览截图并验证获取到真实下载地址
4. ✅ 查看资源详情页面显示所有字段
5. ✅ 验证 API 返回数据格式

修复后，用户上传的文件和截图将在数据库中正确记录真实的下载直链地址，确保前端能够正确显示和下载文件。所有问题都已系统性解决，包括：

- 🔧 **发布数据流程**：requirements, screenshots等字段正确保存
- 🔧 **文件上传流程**：获取真实下载地址而不是内部路径  
- 🔧 **序列化问题**：空数组代替null值
- 🔧 **分类处理**：正确处理前端传递的分类ID

现在整个系统应该能够完整、正确地处理用户发布和文件上传的所有数据了。 