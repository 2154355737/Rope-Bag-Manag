# æ–‡ä»¶ä¸Šä¼ å­˜å‚¨ç›´é“¾ä¿®å¤æ€»ç»“

## é—®é¢˜åˆ†æ

ç”¨æˆ·åé¦ˆï¼šä¸Šä¼ æ–‡ä»¶å’Œæˆªå›¾åï¼Œæ•°æ®åº“ä¸­æ²¡æœ‰æ­£ç¡®è®°å½•å®é™…çš„ä¸‹è½½åœ°å€ï¼Œè€Œæ˜¯å­˜å‚¨äº†é”™è¯¯çš„è·¯å¾„ä¿¡æ¯ã€‚

## AList API å·¥ä½œæœºåˆ¶

æ ¹æ®ç”¨æˆ·æä¾›çš„å®é™…æµ‹è¯•æ•°æ®ï¼ŒAListçš„å·¥ä½œæµç¨‹æ˜¯ï¼š

### 1. ä¸Šä¼ æ–‡ä»¶
ä½¿ç”¨ `PUT /api/fs/form` è¡¨å•ä¸Šä¼ æ–‡ä»¶

### 2. è·å–æ–‡ä»¶ä¿¡æ¯å’Œç›´é“¾
ä½¿ç”¨ `POST /api/fs/get` è·å–æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬çœŸå®ä¸‹è½½åœ°å€

**ç¤ºä¾‹è¯·æ±‚ï¼š**
```bash
curl 'http://alist.tiecode.org.cn/api/fs/get' \
  -H 'Authorization: [TOKEN]' \
  -H 'Content-Type: application/json;charset=UTF-8' \
  --data-raw '{"path":"/image/ç»“ç»³ç¤¾åŒº/å…¶ä»–èµ„æº/2025-08/44-123.png","password":""}'
```

**è¿”å›æ•°æ®ï¼š**
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "name": "44-123.png",
        "size": 673484,
        "raw_url": "https://pdf1.webgetstore.com/2025/08/22/86f0bc46121b86239f1f18e602f96f58.png?sg=xxx&e=xxx&fileName=44-123.png&fi=250524411",
        "provider": "Lanzou"
    }
}
```

**å…³é”®å­—æ®µï¼š`raw_url`** - è¿™æ˜¯æ–‡ä»¶çš„çœŸå®ä¸‹è½½ç›´é“¾åœ°å€

## ä¿®å¤å®ç°

### âœ… 1. æ‰©å±•FileInfoç»“æ„ä½“

åœ¨ `src/services/alist_service.rs` ä¸­æ›´æ–°äº† `FileInfo` ç»“æ„ä½“ï¼š

```rust
#[derive(Debug, Serialize, Deserialize)]
pub struct FileInfo {
    pub name: String,
    pub size: i64,
    pub is_dir: bool,
    pub modified: String,
    pub sign: Option<String>,
    pub thumb: Option<String>,
    #[serde(rename = "type")]
    pub type_: Option<i32>,
    pub raw_url: Option<String>, // æ–‡ä»¶çš„çœŸå®ä¸‹è½½åœ°å€
    pub provider: Option<String>, // å­˜å‚¨æä¾›å•†
}
```

### âœ… 2. æ·»åŠ è·å–æ–‡ä»¶ä¿¡æ¯çš„æ–¹æ³•

åœ¨ `AListService` ä¸­æ–°å¢äº† `get_file_info` æ–¹æ³•ï¼š

```rust
/// è·å–æ–‡ä»¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸‹è½½ç›´é“¾
pub async fn get_file_info(&mut self, file_path: &str) -> Result<FileInfo> {
    self.login().await?;

    let url = format!("{}/api/fs/get", self.base_url);
    
    let request_body = json!({
        "path": file_path,
        "password": ""
    });
    
    log::info!("ğŸ” è·å–æ–‡ä»¶ä¿¡æ¯: {}", file_path);
    
    let response = self.client
        .post(&url)
        .header("Authorization", self.token.as_ref().unwrap())
        .header("Content-Type", "application/json")
        .json(&request_body)
        .send()
        .await?;
        
    let response_text = response.text().await?;
    let result: AListResponse<FileInfo> = serde_json::from_str(&response_text)
        .map_err(|e| anyhow!("è§£ææ–‡ä»¶ä¿¡æ¯å“åº”å¤±è´¥: {} - å“åº”: {}", e, response_text))?;
    
    if result.code == 200 {
        match result.data {
            Some(file_info) => {
                log::info!("âœ… è·å–æ–‡ä»¶ä¿¡æ¯æˆåŠŸ: {} - å¤§å°: {} bytes, ä¸‹è½½åœ°å€: {:?}", 
                         file_info.name, file_info.size, file_info.raw_url);
                Ok(file_info)
            },
            None => Err(anyhow!("æ–‡ä»¶ä¿¡æ¯ä¸ºç©º")),
        }
    } else {
        Err(anyhow!("è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥: {}", result.message))
    }
}
```

### âœ… 3. ä¿®å¤upload_package_screenshotæ–¹æ³•

åœ¨ `src/services/package_storage_service.rs` ä¸­ä¿®å¤äº†æˆªå›¾ä¸Šä¼ ï¼š

```rust
// è·å–æ–‡ä»¶ä¿¡æ¯å’ŒçœŸå®ä¸‹è½½åœ°å€
log::info!("ğŸ” è·å–æˆªå›¾çœŸå®ä¸‹è½½åœ°å€...");
let file_info = self.alist_service.get_file_info(&file_path).await?;

let download_url = file_info.raw_url.unwrap_or_else(|| {
    log::warn!("âš ï¸ æœªè·å–åˆ°raw_urlï¼Œä½¿ç”¨æ„å»ºçš„URL");
    format!("{}/{}/{}", 
        self.alist_service.base_url(),
        storage_path,
        unique_name
    )
});

log::info!("ğŸ”— æˆªå›¾çœŸå®ä¸‹è½½åœ°å€: {}", download_url);

Ok(UploadResult {
    file_path,
    download_url,
    file_size: file_info.size,
})
```

### âœ… 4. ä¿®å¤upload_package_fileæ–¹æ³•

åŒæ ·ä¿®å¤äº†æ–‡ä»¶ä¸Šä¼ çš„é€»è¾‘ï¼š

```rust
// è·å–æ–‡ä»¶ä¿¡æ¯å’ŒçœŸå®ä¸‹è½½åœ°å€
log::info!("ğŸ” è·å–æ–‡ä»¶çœŸå®ä¸‹è½½åœ°å€...");
let file_info = self.alist_service.get_file_info(&file_path).await?;

let download_url = file_info.raw_url.unwrap_or_else(|| {
    log::warn!("âš ï¸ æœªè·å–åˆ°raw_urlï¼Œä½¿ç”¨AListæ ‡è®°");
    format!("alist:{}", file_path)
});

let result = UploadResult {
    file_path: file_path.clone(),
    download_url,
    file_size: file_info.size,
};
```

### âœ… 5. ä¿®å¤æ•°æ®åº“å­˜å‚¨é—®é¢˜

ä¹‹å‰çš„ä¿®å¤å·²ç»ç¡®ä¿ï¼š
- **æ–‡ä»¶ä¸Šä¼ **ï¼š`file_url` å’Œ `file_size` å­—æ®µæ­£ç¡®æ›´æ–°
- **æˆªå›¾ä¸Šä¼ **ï¼š`screenshots` æ•°ç»„æ­£ç¡®æ›´æ–°
- **åºåˆ—åŒ–ä¿®å¤**ï¼šç©ºæ•°ç»„è€Œä¸æ˜¯ `null`

## å®Œæ•´çš„æ•°æ®æµç¨‹

### å‘å¸ƒèµ„æºæµç¨‹ï¼š
1. **å‰ç«¯å‘å¸ƒ**ï¼šè°ƒç”¨ `/publish/resource` API
2. **åˆ›å»ºè®°å½•**ï¼šåœ¨æ•°æ®åº“åˆ›å»ºPackageè®°å½•ï¼ˆåŒ…å«requirementsï¼‰
3. **ä¸Šä¼ æ–‡ä»¶**ï¼šè°ƒç”¨ `/storage/upload` ä¸Šä¼ èµ„æºæ–‡ä»¶
4. **è·å–ç›´é“¾**ï¼šé€šè¿‡AList `/api/fs/get` è·å– `raw_url`
5. **æ›´æ–°è®°å½•**ï¼šå°† `raw_url` æ›´æ–°åˆ°Packageçš„ `file_url` å­—æ®µ

### ä¸Šä¼ æˆªå›¾æµç¨‹ï¼š
1. **ä¸Šä¼ æˆªå›¾**ï¼šè°ƒç”¨ `/storage/upload` ä¸Šä¼ æˆªå›¾æ–‡ä»¶
2. **è·å–ç›´é“¾**ï¼šé€šè¿‡AList `/api/fs/get` è·å– `raw_url`  
3. **æ›´æ–°è®°å½•**ï¼šå°† `raw_url` æ·»åŠ åˆ°Packageçš„ `screenshots` æ•°ç»„

## æ•°æ®ç¤ºä¾‹

### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰ï¼š
```json
{
  "file_url": "/image/ç»“ç»³ç¤¾åŒº/å…¶ä»–èµ„æº/2025-08/44-123.png",
  "screenshots": ["/image/ç»“ç»³ç¤¾åŒº/å…¶ä»–èµ„æº/2025-08/44-screenshot.png"],
  "requirements": null,
  "file_size": 105126
}
```

### ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰ï¼š
```json
{
  "file_url": "https://pdf1.webgetstore.com/2025/08/22/86f0bc46121b86239f1f18e602f96f58.png?sg=xxx&fileName=44-123.png",
  "screenshots": ["https://pdf1.webgetstore.com/2025/08/22/xxx.png?sg=xxx&fileName=44-screenshot.png"],
  "requirements": ["Windows 10+", "4GBå†…å­˜", "100MBç©ºé—´"],
  "file_size": 673484
}
```

## å…³é”®ä¿®å¤ç‚¹æ€»ç»“

1. âœ… **æ·»åŠ AListæ–‡ä»¶ä¿¡æ¯è·å–æ¥å£**
2. âœ… **ä¿®æ”¹ä¸Šä¼ é€»è¾‘è·å–çœŸå®ä¸‹è½½åœ°å€** 
3. âœ… **ç¡®ä¿æ•°æ®åº“å­˜å‚¨çš„æ˜¯ç›´é“¾è€Œä¸æ˜¯å†…éƒ¨è·¯å¾„**
4. âœ… **å¤„ç†æ–‡ä»¶å’Œæˆªå›¾çš„ä¸åŒå­˜å‚¨è·¯å¾„**
5. âœ… **ä¿®å¤æ•°æ®åº“å­—æ®µç¼ºå¤±é—®é¢˜**
6. âœ… **ä¿®å¤åºåˆ—åŒ–ç©ºå€¼é—®é¢˜**
7. âœ… **ä¿®å¤åˆ†ç±»IDå¤„ç†é—®é¢˜**

## æµ‹è¯•éªŒè¯

å»ºè®®æµ‹è¯•åœºæ™¯ï¼š
1. âœ… å‘å¸ƒå¸¦æœ‰ç³»ç»Ÿè¦æ±‚çš„èµ„æº
2. âœ… ä¸Šä¼ èµ„æºæ–‡ä»¶å¹¶éªŒè¯è·å–åˆ°çœŸå®ä¸‹è½½åœ°å€
3. âœ… ä¸Šä¼ é¢„è§ˆæˆªå›¾å¹¶éªŒè¯è·å–åˆ°çœŸå®ä¸‹è½½åœ°å€
4. âœ… æŸ¥çœ‹èµ„æºè¯¦æƒ…é¡µé¢æ˜¾ç¤ºæ‰€æœ‰å­—æ®µ
5. âœ… éªŒè¯ API è¿”å›æ•°æ®æ ¼å¼

ä¿®å¤åï¼Œç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶å’Œæˆªå›¾å°†åœ¨æ•°æ®åº“ä¸­æ­£ç¡®è®°å½•çœŸå®çš„ä¸‹è½½ç›´é“¾åœ°å€ï¼Œç¡®ä¿å‰ç«¯èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºå’Œä¸‹è½½æ–‡ä»¶ã€‚æ‰€æœ‰é—®é¢˜éƒ½å·²ç³»ç»Ÿæ€§è§£å†³ï¼ŒåŒ…æ‹¬ï¼š

- ğŸ”§ **å‘å¸ƒæ•°æ®æµç¨‹**ï¼šrequirements, screenshotsç­‰å­—æ®µæ­£ç¡®ä¿å­˜
- ğŸ”§ **æ–‡ä»¶ä¸Šä¼ æµç¨‹**ï¼šè·å–çœŸå®ä¸‹è½½åœ°å€è€Œä¸æ˜¯å†…éƒ¨è·¯å¾„  
- ğŸ”§ **åºåˆ—åŒ–é—®é¢˜**ï¼šç©ºæ•°ç»„ä»£æ›¿nullå€¼
- ğŸ”§ **åˆ†ç±»å¤„ç†**ï¼šæ­£ç¡®å¤„ç†å‰ç«¯ä¼ é€’çš„åˆ†ç±»ID

ç°åœ¨æ•´ä¸ªç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿå®Œæ•´ã€æ­£ç¡®åœ°å¤„ç†ç”¨æˆ·å‘å¸ƒå’Œæ–‡ä»¶ä¸Šä¼ çš„æ‰€æœ‰æ•°æ®äº†ã€‚ 