# 数据库初始化脚本调整建议

## 📋 调整概要

基于重构分析报告，数据库初始化脚本需要进行以下调整：

## ❌ 需要删除的表

### 1. announcements 表
**原因**: 公告管理功能确认不会开发
```sql
-- 删除以下内容：
-- 公告表
CREATE TABLE IF NOT EXISTS announcements (
    -- ... 整个表定义
);
CREATE INDEX IF NOT EXISTS idx_announcements_enabled ON announcements(enabled);
CREATE INDEX IF NOT EXISTS idx_announcements_time ON announcements(start_time, end_time);
```

### 2. forbidden_words 表  
**原因**: 违禁词管理功能确认不会开发
```sql
-- 删除以下内容：
-- 违禁词表
CREATE TABLE IF NOT EXISTS forbidden_words (
    -- ... 整个表定义
);
```

## ➕ 需要添加的表

### 1. posts 表
**原因**: 前端App和后台管理都使用帖子功能，但当前数据库缺少posts表

```sql
-- 帖子表
CREATE TABLE IF NOT EXISTS posts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    author_id INTEGER NOT NULL,
    like_count INTEGER DEFAULT 0,
    view_count INTEGER DEFAULT 0,
    comment_count INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'published' NOT NULL CHECK (status IN ('draft', 'published', 'archived', 'banned')),
    is_featured BOOLEAN DEFAULT 0,
    is_pinned BOOLEAN DEFAULT 0,
    tags JSON DEFAULT '[]',
    images JSON DEFAULT '[]',
    code_snippet TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 帖子表索引
CREATE INDEX IF NOT EXISTS idx_posts_author_id ON posts(author_id);
CREATE INDEX IF NOT EXISTS idx_posts_status ON posts(status);
CREATE INDEX IF NOT EXISTS idx_posts_created_at ON posts(created_at);
CREATE INDEX IF NOT EXISTS idx_posts_featured ON posts(is_featured);
CREATE INDEX IF NOT EXISTS idx_posts_pinned ON posts(is_pinned);

-- 帖子全文搜索索引（SQLite FTS5）
CREATE VIRTUAL TABLE IF NOT EXISTS posts_fts USING fts5(
    title,
    content,
    content='posts',
    content_rowid='id'
);

-- 帖子FTS5触发器
CREATE TRIGGER IF NOT EXISTS posts_fts_insert AFTER INSERT ON posts
BEGIN
    INSERT INTO posts_fts(rowid, title, content) VALUES (new.id, new.title, new.content);
END;

CREATE TRIGGER IF NOT EXISTS posts_fts_delete AFTER DELETE ON posts
BEGIN
    INSERT INTO posts_fts(posts_fts, rowid, title, content) VALUES ('delete', old.id, old.title, old.content);
END;

CREATE TRIGGER IF NOT EXISTS posts_fts_update AFTER UPDATE ON posts
BEGIN
    INSERT INTO posts_fts(posts_fts, rowid, title, content) VALUES ('delete', old.id, old.title, old.content);
    INSERT INTO posts_fts(rowid, title, content) VALUES (new.id, new.title, new.content);
END;
```

### 2. post_tags 表（可选）
**原因**: 如果帖子需要标签关联功能（类似packages）

```sql
-- 帖子标签关联表
CREATE TABLE IF NOT EXISTS post_tags (
    post_id INTEGER NOT NULL,
    tag_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (post_id, tag_id),
    FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);
```

## 🔄 需要调整的表

### 1. packages 表字段调整
**原因**: 需要与resource领域模型字段对应

```sql
-- 在packages表中添加缺少的字段：
ALTER TABLE packages ADD COLUMN file_path VARCHAR(500);
ALTER TABLE packages ADD COLUMN file_size INTEGER DEFAULT 0;
ALTER TABLE packages ADD COLUMN download_count INTEGER DEFAULT 0;
ALTER TABLE packages ADD COLUMN like_count INTEGER DEFAULT 0;
ALTER TABLE packages ADD COLUMN view_count INTEGER DEFAULT 0;
ALTER TABLE packages ADD COLUMN comment_count INTEGER DEFAULT 0;
ALTER TABLE packages ADD COLUMN rating REAL DEFAULT 0.0;
ALTER TABLE packages ADD COLUMN is_featured BOOLEAN DEFAULT 0;
ALTER TABLE packages ADD COLUMN is_pinned BOOLEAN DEFAULT 0;
ALTER TABLE packages ADD COLUMN requirements JSON DEFAULT '[]';
ALTER TABLE packages ADD COLUMN screenshots JSON DEFAULT '[]';

-- 添加相应索引
CREATE INDEX IF NOT EXISTS idx_packages_featured ON packages(is_featured);
CREATE INDEX IF NOT EXISTS idx_packages_pinned ON packages(is_pinned);
CREATE INDEX IF NOT EXISTS idx_packages_rating ON packages(rating DESC);
CREATE INDEX IF NOT EXISTS idx_packages_download_count ON packages(download_count DESC);
CREATE INDEX IF NOT EXISTS idx_packages_like_count ON packages(like_count DESC);
```

### 2. comments 表字段调整
**原因**: 需要支持帖子评论

```sql
-- comments表的target_type已经支持'post'，无需调整
-- 但可能需要添加一些字段来匹配领域模型：
ALTER TABLE comments ADD COLUMN helpful_count INTEGER DEFAULT 0;
ALTER TABLE comments ADD COLUMN is_helpful BOOLEAN DEFAULT 0;
```

## ✅ 保留的表

以下表格完全保留，无需调整：
- **users** - 用户管理（前端+后台使用）
- **categories** - 分类管理（前端+后台使用）
- **tags** - 标签管理（前端+后台使用）
- **package_files** - 文件管理（核心功能）
- **package_tags** - 包标签关联（核心功能）
- **likes** - 点赞功能（前端使用）
- **favorites** - 收藏功能（前端使用）
- **downloads** - 下载记录（统计功能）
- **user_actions** - 用户行为记录（后台使用+规划功能）
- **email_verifications** - 邮件验证（认证功能）
- **notifications** - 通知系统（前端+后台使用）
- **subscriptions** - 订阅功能（规划中功能）
- **mail_settings** - 邮件设置（规划中功能）
- **system_settings** - 系统设置（系统运行必需）
- **ip_bans** - IP封禁（后台安全管理使用）
- **download_security** - 下载安全（后台安全管理使用）

## 📝 实施步骤

### 步骤1: 创建新的数据库迁移文件
```bash
# 创建新的迁移文件
touch APP_HouDuan/migrations/002_refactor_adjustments.sql
```

### 步骤2: 在迁移文件中添加调整内容
- 删除announcements表
- 删除forbidden_words表  
- 添加posts表及相关索引和触发器
- 调整packages表字段
- 调整comments表字段

### 步骤3: 更新初始化脚本
修改`APP_HouDuan/migrations/001_initial.sql`，移除不需要的表定义

### 步骤4: 测试迁移
```bash
# 在新后端中测试数据库迁移
cd APP_HouDuan
cargo run
```

## ⚠️ 注意事项

1. **数据迁移**: 如果旧后端有数据需要迁移，需要创建数据迁移脚本
2. **向后兼容**: 确保API接口的响应格式保持兼容
3. **索引优化**: 新增字段的索引可能需要根据实际查询模式调优
4. **FTS搜索**: posts表的全文搜索需要与packages表保持一致的搜索体验

## 🎯 预期效果

调整后的数据库将：
- ✅ 支持所有前端App使用的功能
- ✅ 支持所有后台管理使用的功能  
- ✅ 为规划中的功能预留空间
- ❌ 移除确认不会开发的功能
- 🚀 更加精简和专注于核心业务

这个调整确保了数据库结构与重构分析报告完全一致，为新后端的DDD架构提供了坚实的数据基础。 