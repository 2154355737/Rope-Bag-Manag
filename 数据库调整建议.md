# æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬è°ƒæ•´å»ºè®®

## ğŸ“‹ è°ƒæ•´æ¦‚è¦

åŸºäºé‡æ„åˆ†ææŠ¥å‘Šï¼Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬éœ€è¦è¿›è¡Œä»¥ä¸‹è°ƒæ•´ï¼š

## âŒ éœ€è¦åˆ é™¤çš„è¡¨

### 1. announcements è¡¨
**åŸå› **: å…¬å‘Šç®¡ç†åŠŸèƒ½ç¡®è®¤ä¸ä¼šå¼€å‘
```sql
-- åˆ é™¤ä»¥ä¸‹å†…å®¹ï¼š
-- å…¬å‘Šè¡¨
CREATE TABLE IF NOT EXISTS announcements (
    -- ... æ•´ä¸ªè¡¨å®šä¹‰
);
CREATE INDEX IF NOT EXISTS idx_announcements_enabled ON announcements(enabled);
CREATE INDEX IF NOT EXISTS idx_announcements_time ON announcements(start_time, end_time);
```

### 2. forbidden_words è¡¨  
**åŸå› **: è¿ç¦è¯ç®¡ç†åŠŸèƒ½ç¡®è®¤ä¸ä¼šå¼€å‘
```sql
-- åˆ é™¤ä»¥ä¸‹å†…å®¹ï¼š
-- è¿ç¦è¯è¡¨
CREATE TABLE IF NOT EXISTS forbidden_words (
    -- ... æ•´ä¸ªè¡¨å®šä¹‰
);
```

## â• éœ€è¦æ·»åŠ çš„è¡¨

### 1. posts è¡¨
**åŸå› **: å‰ç«¯Appå’Œåå°ç®¡ç†éƒ½ä½¿ç”¨å¸–å­åŠŸèƒ½ï¼Œä½†å½“å‰æ•°æ®åº“ç¼ºå°‘postsè¡¨

```sql
-- å¸–å­è¡¨
CREATE TABLE IF NOT EXISTS posts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    author_id INTEGER NOT NULL,
    like_count INTEGER DEFAULT 0,
    view_count INTEGER DEFAULT 0,
    comment_count INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'published' NOT NULL CHECK (status IN ('draft', 'published', 'archived', 'banned')),
    is_featured BOOLEAN DEFAULT 0,
    is_pinned BOOLEAN DEFAULT 0,
    tags JSON DEFAULT '[]',
    images JSON DEFAULT '[]',
    code_snippet TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE
);

-- å¸–å­è¡¨ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_posts_author_id ON posts(author_id);
CREATE INDEX IF NOT EXISTS idx_posts_status ON posts(status);
CREATE INDEX IF NOT EXISTS idx_posts_created_at ON posts(created_at);
CREATE INDEX IF NOT EXISTS idx_posts_featured ON posts(is_featured);
CREATE INDEX IF NOT EXISTS idx_posts_pinned ON posts(is_pinned);

-- å¸–å­å…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆSQLite FTS5ï¼‰
CREATE VIRTUAL TABLE IF NOT EXISTS posts_fts USING fts5(
    title,
    content,
    content='posts',
    content_rowid='id'
);

-- å¸–å­FTS5è§¦å‘å™¨
CREATE TRIGGER IF NOT EXISTS posts_fts_insert AFTER INSERT ON posts
BEGIN
    INSERT INTO posts_fts(rowid, title, content) VALUES (new.id, new.title, new.content);
END;

CREATE TRIGGER IF NOT EXISTS posts_fts_delete AFTER DELETE ON posts
BEGIN
    INSERT INTO posts_fts(posts_fts, rowid, title, content) VALUES ('delete', old.id, old.title, old.content);
END;

CREATE TRIGGER IF NOT EXISTS posts_fts_update AFTER UPDATE ON posts
BEGIN
    INSERT INTO posts_fts(posts_fts, rowid, title, content) VALUES ('delete', old.id, old.title, old.content);
    INSERT INTO posts_fts(rowid, title, content) VALUES (new.id, new.title, new.content);
END;
```

### 2. post_tags è¡¨ï¼ˆå¯é€‰ï¼‰
**åŸå› **: å¦‚æœå¸–å­éœ€è¦æ ‡ç­¾å…³è”åŠŸèƒ½ï¼ˆç±»ä¼¼packagesï¼‰

```sql
-- å¸–å­æ ‡ç­¾å…³è”è¡¨
CREATE TABLE IF NOT EXISTS post_tags (
    post_id INTEGER NOT NULL,
    tag_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (post_id, tag_id),
    FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);
```

## ğŸ”„ éœ€è¦è°ƒæ•´çš„è¡¨

### 1. packages è¡¨å­—æ®µè°ƒæ•´
**åŸå› **: éœ€è¦ä¸resourceé¢†åŸŸæ¨¡å‹å­—æ®µå¯¹åº”

```sql
-- åœ¨packagesè¡¨ä¸­æ·»åŠ ç¼ºå°‘çš„å­—æ®µï¼š
ALTER TABLE packages ADD COLUMN file_path VARCHAR(500);
ALTER TABLE packages ADD COLUMN file_size INTEGER DEFAULT 0;
ALTER TABLE packages ADD COLUMN download_count INTEGER DEFAULT 0;
ALTER TABLE packages ADD COLUMN like_count INTEGER DEFAULT 0;
ALTER TABLE packages ADD COLUMN view_count INTEGER DEFAULT 0;
ALTER TABLE packages ADD COLUMN comment_count INTEGER DEFAULT 0;
ALTER TABLE packages ADD COLUMN rating REAL DEFAULT 0.0;
ALTER TABLE packages ADD COLUMN is_featured BOOLEAN DEFAULT 0;
ALTER TABLE packages ADD COLUMN is_pinned BOOLEAN DEFAULT 0;
ALTER TABLE packages ADD COLUMN requirements JSON DEFAULT '[]';
ALTER TABLE packages ADD COLUMN screenshots JSON DEFAULT '[]';

-- æ·»åŠ ç›¸åº”ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_packages_featured ON packages(is_featured);
CREATE INDEX IF NOT EXISTS idx_packages_pinned ON packages(is_pinned);
CREATE INDEX IF NOT EXISTS idx_packages_rating ON packages(rating DESC);
CREATE INDEX IF NOT EXISTS idx_packages_download_count ON packages(download_count DESC);
CREATE INDEX IF NOT EXISTS idx_packages_like_count ON packages(like_count DESC);
```

### 2. comments è¡¨å­—æ®µè°ƒæ•´
**åŸå› **: éœ€è¦æ”¯æŒå¸–å­è¯„è®º

```sql
-- commentsè¡¨çš„target_typeå·²ç»æ”¯æŒ'post'ï¼Œæ— éœ€è°ƒæ•´
-- ä½†å¯èƒ½éœ€è¦æ·»åŠ ä¸€äº›å­—æ®µæ¥åŒ¹é…é¢†åŸŸæ¨¡å‹ï¼š
ALTER TABLE comments ADD COLUMN helpful_count INTEGER DEFAULT 0;
ALTER TABLE comments ADD COLUMN is_helpful BOOLEAN DEFAULT 0;
```

## âœ… ä¿ç•™çš„è¡¨

ä»¥ä¸‹è¡¨æ ¼å®Œå…¨ä¿ç•™ï¼Œæ— éœ€è°ƒæ•´ï¼š
- **users** - ç”¨æˆ·ç®¡ç†ï¼ˆå‰ç«¯+åå°ä½¿ç”¨ï¼‰
- **categories** - åˆ†ç±»ç®¡ç†ï¼ˆå‰ç«¯+åå°ä½¿ç”¨ï¼‰
- **tags** - æ ‡ç­¾ç®¡ç†ï¼ˆå‰ç«¯+åå°ä½¿ç”¨ï¼‰
- **package_files** - æ–‡ä»¶ç®¡ç†ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
- **package_tags** - åŒ…æ ‡ç­¾å…³è”ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
- **likes** - ç‚¹èµåŠŸèƒ½ï¼ˆå‰ç«¯ä½¿ç”¨ï¼‰
- **favorites** - æ”¶è—åŠŸèƒ½ï¼ˆå‰ç«¯ä½¿ç”¨ï¼‰
- **downloads** - ä¸‹è½½è®°å½•ï¼ˆç»Ÿè®¡åŠŸèƒ½ï¼‰
- **user_actions** - ç”¨æˆ·è¡Œä¸ºè®°å½•ï¼ˆåå°ä½¿ç”¨+è§„åˆ’åŠŸèƒ½ï¼‰
- **email_verifications** - é‚®ä»¶éªŒè¯ï¼ˆè®¤è¯åŠŸèƒ½ï¼‰
- **notifications** - é€šçŸ¥ç³»ç»Ÿï¼ˆå‰ç«¯+åå°ä½¿ç”¨ï¼‰
- **subscriptions** - è®¢é˜…åŠŸèƒ½ï¼ˆè§„åˆ’ä¸­åŠŸèƒ½ï¼‰
- **mail_settings** - é‚®ä»¶è®¾ç½®ï¼ˆè§„åˆ’ä¸­åŠŸèƒ½ï¼‰
- **system_settings** - ç³»ç»Ÿè®¾ç½®ï¼ˆç³»ç»Ÿè¿è¡Œå¿…éœ€ï¼‰
- **ip_bans** - IPå°ç¦ï¼ˆåå°å®‰å…¨ç®¡ç†ä½¿ç”¨ï¼‰
- **download_security** - ä¸‹è½½å®‰å…¨ï¼ˆåå°å®‰å…¨ç®¡ç†ä½¿ç”¨ï¼‰

## ğŸ“ å®æ–½æ­¥éª¤

### æ­¥éª¤1: åˆ›å»ºæ–°çš„æ•°æ®åº“è¿ç§»æ–‡ä»¶
```bash
# åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶
touch APP_HouDuan/migrations/002_refactor_adjustments.sql
```

### æ­¥éª¤2: åœ¨è¿ç§»æ–‡ä»¶ä¸­æ·»åŠ è°ƒæ•´å†…å®¹
- åˆ é™¤announcementsè¡¨
- åˆ é™¤forbidden_wordsè¡¨  
- æ·»åŠ postsè¡¨åŠç›¸å…³ç´¢å¼•å’Œè§¦å‘å™¨
- è°ƒæ•´packagesè¡¨å­—æ®µ
- è°ƒæ•´commentsè¡¨å­—æ®µ

### æ­¥éª¤3: æ›´æ–°åˆå§‹åŒ–è„šæœ¬
ä¿®æ”¹`APP_HouDuan/migrations/001_initial.sql`ï¼Œç§»é™¤ä¸éœ€è¦çš„è¡¨å®šä¹‰

### æ­¥éª¤4: æµ‹è¯•è¿ç§»
```bash
# åœ¨æ–°åç«¯ä¸­æµ‹è¯•æ•°æ®åº“è¿ç§»
cd APP_HouDuan
cargo run
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¿ç§»**: å¦‚æœæ—§åç«¯æœ‰æ•°æ®éœ€è¦è¿ç§»ï¼Œéœ€è¦åˆ›å»ºæ•°æ®è¿ç§»è„šæœ¬
2. **å‘åå…¼å®¹**: ç¡®ä¿APIæ¥å£çš„å“åº”æ ¼å¼ä¿æŒå…¼å®¹
3. **ç´¢å¼•ä¼˜åŒ–**: æ–°å¢å­—æ®µçš„ç´¢å¼•å¯èƒ½éœ€è¦æ ¹æ®å®é™…æŸ¥è¯¢æ¨¡å¼è°ƒä¼˜
4. **FTSæœç´¢**: postsè¡¨çš„å…¨æ–‡æœç´¢éœ€è¦ä¸packagesè¡¨ä¿æŒä¸€è‡´çš„æœç´¢ä½“éªŒ

## ğŸ¯ é¢„æœŸæ•ˆæœ

è°ƒæ•´åçš„æ•°æ®åº“å°†ï¼š
- âœ… æ”¯æŒæ‰€æœ‰å‰ç«¯Appä½¿ç”¨çš„åŠŸèƒ½
- âœ… æ”¯æŒæ‰€æœ‰åå°ç®¡ç†ä½¿ç”¨çš„åŠŸèƒ½  
- âœ… ä¸ºè§„åˆ’ä¸­çš„åŠŸèƒ½é¢„ç•™ç©ºé—´
- âŒ ç§»é™¤ç¡®è®¤ä¸ä¼šå¼€å‘çš„åŠŸèƒ½
- ğŸš€ æ›´åŠ ç²¾ç®€å’Œä¸“æ³¨äºæ ¸å¿ƒä¸šåŠ¡

è¿™ä¸ªè°ƒæ•´ç¡®ä¿äº†æ•°æ®åº“ç»“æ„ä¸é‡æ„åˆ†ææŠ¥å‘Šå®Œå…¨ä¸€è‡´ï¼Œä¸ºæ–°åç«¯çš„DDDæ¶æ„æä¾›äº†åšå®çš„æ•°æ®åŸºç¡€ã€‚ 