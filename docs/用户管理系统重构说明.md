# 用户管理系统重构说明

## 概述

本次重构完全重新设计了用户管理系统，实现了基于权限的用户身份管理，支持多种用户角色和丰富的功能特性。

## 新功能特性

### 1. 用户身份系统

#### 三种用户身份
- **普通用户 (Normal)**: 基础权限，只能下载资源
- **开发者 (Developer)**: 可以上传资源并管理自己的资源
- **元老 (Elder)**: 继承开发者权限，可以管理全局资源

#### 权限矩阵
| 权限 | 普通用户 | 开发者 | 元老 |
|------|----------|--------|------|
| 下载资源 | ✅ | ✅ | ✅ |
| 上传资源 | ❌ | ✅ | ✅ |
| 管理自己的资源 | ❌ | ✅ | ✅ |
| 管理全局资源 | ❌ | ❌ | ✅ |
| 管理用户 | ❌ | ❌ | ✅ |
| 管理系统 | ❌ | ❌ | ❌ |

### 2. 自动晋升机制

- **星级晋升**: 普通用户星级达到3.0时自动晋升为开发者
- **连续签到奖励**: 连续签到7天以上，星级自动+0.5
- **标星奖励**: 用户上传的资源被管理员标星后，用户星级+1

### 3. 签到系统

- **每日签到**: 用户可每日签到一次
- **连续签到**: 系统自动计算连续签到天数
- **签到奖励**: 连续签到7天以上获得星级奖励
- **签到记录**: 完整的签到历史记录

### 4. QQ绑定系统

- **QQ号码绑定**: 用户可以绑定QQ号码
- **自动头像**: 根据QQ号码自动生成头像URL
- **头像API**: `http://q1.qlogo.cn/g?b=qq&nk=QQ号码&s=100`

### 5. 封禁管理系统

- **封禁功能**: 管理员可以封禁用户
- **封禁原因**: 记录封禁原因和时间
- **权限限制**: 被封禁用户无法登录和使用任何功能
- **解封功能**: 管理员可以解封用户

### 6. 管理员系统

- **配置文件管理**: 管理员账号由配置文件决定，不能通过注册创建
- **系统权限**: 管理员拥有最高权限，可以管理所有功能

## API接口

### 用户认证
- `POST /api/login` - 用户登录
- `POST /api/register` - 用户注册

### 用户信息
- `GET /api/user-info` - 获取用户信息
- `GET /api/change-password` - 修改密码
- `GET /api/change-nickname` - 修改昵称
- `GET /api/nicknames` - 获取用户昵称列表

### 签到系统
- `GET /api/sign-in` - 用户签到
- `POST /api/user/sign-in` - 新签到接口

### QQ绑定
- `POST /api/user/bind-qq` - 绑定QQ号码

### 权限管理
- `GET /api/user/permissions` - 获取用户权限
- `GET /api/user/check-permission` - 检查用户权限
- `POST /api/user/set-role` - 设置用户身份（管理员）

### 绳包标星
- `POST /api/user/star-package` - 标星绳包（管理员）

## 数据模型

### User结构体
```rust
pub struct User {
    pub username: String,
    pub nickname: String,
    pub password: String,
    pub star: f32,                    // 星级（支持小数）
    pub role: UserRole,               // 用户身份
    pub permissions: UserPermissions, // 用户权限
    pub banned: bool,                 // 是否被封禁
    pub ban_reason: Option<String>,   // 封禁原因
    pub ban_time: Option<String>,     // 封禁时间
    pub qq_number: Option<String>,    // QQ号码
    pub avatar_url: Option<String>,   // 头像URL
    pub sign_records: Vec<SignRecord>, // 签到记录
    pub sign_days: u32,              // 总签到天数
    pub sign_total: u32,             // 连续签到天数
    pub last_sign: String,           // 最后签到时间
    pub register_time: String,       // 注册时间
    pub last_login: String,          // 最后登录时间
    pub upload_count: u32,           // 上传资源数量
    pub download_count: u32,         // 下载资源数量
    pub is_admin: bool,              // 是否为管理员
}
```

### 用户身份枚举
```rust
pub enum UserRole {
    Normal,     // 普通用户
    Developer,  // 开发者
    Elder,      // 元老
}
```

### 权限结构
```rust
pub struct UserPermissions {
    pub can_download: bool,      // 下载资源
    pub can_upload: bool,        // 上传资源
    pub can_manage_own: bool,    // 管理自己的资源
    pub can_manage_global: bool, // 管理全局资源
    pub can_manage_users: bool,  // 管理用户
    pub can_manage_system: bool, // 管理系统
}
```

## 使用说明

### 1. 用户注册
- 新用户注册时默认为普通用户身份
- 星级初始为1.0
- 拥有基础下载权限

### 2. 身份晋升
- 用户星级达到3.0时自动晋升为开发者
- 开发者可以上传资源并管理自己的资源

### 3. 签到系统
- 用户每日可签到一次
- 连续签到7天以上获得星级奖励
- 签到记录完整保存

### 4. QQ绑定
- 用户可以绑定QQ号码
- 系统自动生成QQ头像
- 支持头像显示

### 5. 权限检查
- 所有操作都会进行权限检查
- 被封禁用户无法使用任何功能
- 权限不足时返回相应错误信息

## 配置文件

管理员账号在 `data/config.json` 中配置：
```json
{
  "admin_username": "muteduanxing",
  "admin_password": "ahk12378dx"
}
```

## 数据文件

- `data/users.json` - 用户数据
- `data/data.json` - 绳包数据（包含标星信息）
- `data/categories.json` - 分类数据

## 注意事项

1. **管理员账号**: 只能通过配置文件创建，不能通过注册创建
2. **权限继承**: 元老继承开发者权限，开发者继承普通用户权限
3. **自动晋升**: 基于星级的自动晋升机制
4. **封禁管理**: 被封禁用户完全无法使用系统
5. **数据兼容**: 新系统向后兼容旧数据格式 