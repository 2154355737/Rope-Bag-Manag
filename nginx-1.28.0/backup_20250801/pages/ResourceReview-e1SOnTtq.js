import{G as r,d as pe,X as _e,U as me,a5 as S,_ as U,l as fe,q as ge,N as he,E as Y}from"../chunks/element-plus-BqgU8HW0.js";import{p as B}from"../chunks/packages-B7D1MM1S.js";import{c as we}from"../chunks/categories-BbFpSfuE.js";import{f as be}from"../chunks/format-B9owEeWI.js";import{g as ye,_ as Ce}from"../assets/index-KJvHh4NK.js";import{x as ke,r as i,c as xe,X as ze,j as Re,y as T,A as a,Q as l,I as s,u as v,al as p,M as d,O as c,P as Ve,a6 as je,H,J as Be,ar as De,K as Pe,z as k}from"../chunks/vue-vendor-BleHOoLr.js";import"../chunks/utils-Dq7h7Pqt.js";const Ae={class:"admin-page resource-review"},Se={class:"page-header"},Ue={class:"header-content"},Te={class:"header-left"},$e={class:"header-icon"},Me={class:"header-actions"},Ne={class:"stats-section"},Ie={class:"stats-grid"},Ee={class:"stat-card"},Fe={class:"stat-icon pending"},Ye={class:"stat-content"},He={class:"stat-number"},Le={class:"stat-card"},Qe={class:"stat-icon approved"},Xe={class:"stat-content"},qe={class:"stat-number"},Ge={class:"stat-card"},Je={class:"stat-icon rejected"},Ke={class:"stat-content"},Oe={class:"stat-number"},We={class:"stat-card"},Ze={class:"stat-icon total"},et={class:"stat-content"},tt={class:"stat-number"},at={class:"search-section"},lt={class:"search-left"},st={class:"search-right"},ot={class:"table-section"},nt={class:"resource-name"},rt={class:"resource-desc"},it={class:"pagination-section"},dt={key:0},ut={class:"resource-info"},ct={class:"dialog-footer"},vt=ke({__name:"ResourceReview",setup(pt){const x=i(!1),D=i(!1),$=i([]),u=i([]),P=i([]),w=i(1),A=i(20),M=i(0),z=i(""),R=i(null),C=i(0),V=i(0),j=i(0),L=xe(()=>V.value+j.value),b=i(!1),_=i(null),m=i("approve"),g=ze({comment:""}),f=async()=>{x.value=!0;try{const t={page:w.value,page_size:A.value};z.value&&(t.search=z.value),R.value&&(t.category_id=R.value),console.log("📤 发送待审核资源请求:",t);const e=await B.getPendingResources(t);e.code===0&&e.data?(console.log("✅ 待审核资源加载成功:",e.data),$.value=e.data.list,M.value=e.data.total,C.value=e.data.total):(console.warn("❌ 待审核资源加载失败:",e),r.error(e.message||"加载待审核资源失败"))}catch(t){console.error("🚫 加载待审核资源出错:",t),t.response?.status===403?r.error("权限不足：只有管理员和元老可以查看待审核资源"):t.response?.status===404?r.error("API接口不存在，请检查后端服务"):r.error(t.response?.data?.message||"加载待审核资源时发生错误")}finally{x.value=!1}},Q=async()=>{try{const t=await we.getCategories();t.code===0&&t.data&&(P.value=Array.isArray(t.data)?t.data:t.data.list||[])}catch(t){console.error("加载分类出错:",t)}},X=t=>{if(!t)return"未分类";const e=P.value.find(n=>n.id===t);return e?e.name:"未知分类"},N=t=>be(t,"YYYY-MM-DD HH:mm:ss"),q=()=>{w.value=1,f()},G=()=>{w.value=1,f()},J=()=>{w.value=1,f()},K=()=>{f()},O=t=>{u.value=t},W=t=>{_.value=t,m.value="approve",g.comment="",b.value=!0},Z=t=>{_.value=t,m.value="reject",g.comment="",b.value=!0},ee=t=>{t.file_url?window.open(t.file_url,"_blank"):r.warning("该资源没有文件链接")},te=async()=>{if(_.value){if(m.value==="reject"&&!g.comment.trim()){r.warning("请说明拒绝的原因");return}D.value=!0;try{const t={status:m.value==="approve"?"approved":"rejected",comment:g.comment.trim()||void 0},e=await B.reviewResource(_.value.id,t);if(e.code===0){const n=m.value==="approve"?"通过":"拒绝";r.success(`资源审核${n}成功`),b.value=!1,m.value==="approve"?V.value++:j.value++,C.value--,await f()}else r.error(e.message||"审核失败")}catch(t){console.error("审核资源出错:",t),r.error("审核资源时发生错误")}finally{D.value=!1}}},ae=()=>{_.value=null,g.comment=""},le=async()=>{if(u.value.length===0){r.warning("请选择要批量通过的资源");return}try{await Y.confirm(`确定要批量通过选中的 ${u.value.length} 个资源吗？`,"批量通过",{confirmButtonText:"确定",cancelButtonText:"取消",type:"success"});const t=u.value.map(e=>B.reviewResource(e.id,{status:"approved"}));await Promise.all(t),r.success("批量通过成功"),V.value+=u.value.length,C.value-=u.value.length,u.value=[],await f()}catch(t){t!=="cancel"&&r.error("批量通过失败")}},se=async()=>{if(u.value.length===0){r.warning("请选择要批量拒绝的资源");return}try{const{value:t}=await Y.prompt("请输入批量拒绝的原因：","批量拒绝",{confirmButtonText:"确定",cancelButtonText:"取消",inputPlaceholder:"请说明拒绝的原因",inputValidator:n=>!n||!n.trim()?"请输入拒绝原因":!0}),e=u.value.map(n=>B.reviewResource(n.id,{status:"rejected",comment:t.trim()}));await Promise.all(e),r.success("批量拒绝成功"),j.value+=u.value.length,C.value-=u.value.length,u.value=[],await f()}catch(t){t!=="cancel"&&r.error("批量拒绝失败")}};return Re(async()=>{const t=ye();if(console.log("👤 当前用户信息:",t),!t){r.error("用户未登录");return}if(t.role!=="admin"&&t.role!=="elder"){r.error(`权限不足：当前角色 ${t.role}，需要管理员或元老权限`);return}console.log("✅ 权限验证通过，加载资源审核页面"),await Q(),await f()}),(t,e)=>{const n=p("el-icon"),h=p("el-button"),I=p("el-input"),oe=p("el-option"),ne=p("el-select"),y=p("el-table-column"),E=p("el-link"),re=p("el-table"),ie=p("el-pagination"),de=p("el-form-item"),ue=p("el-form"),ce=p("el-dialog"),ve=De("loading");return k(),T("div",Ae,[a("div",Se,[a("div",Ue,[a("div",Te,[a("div",$e,[l(n,{size:32},{default:s(()=>[l(v(pe))]),_:1})]),e[7]||(e[7]=a("div",{class:"header-info"},[a("h1",{class:"page-title"},"资源审核"),a("p",{class:"page-subtitle"},"审核用户上传的资源，决定是否上架到社区")],-1))]),a("div",Me,[l(h,{onClick:f,loading:x.value},{default:s(()=>[l(n,null,{default:s(()=>[l(v(_e))]),_:1}),e[8]||(e[8]=d(" 刷新列表 "))]),_:1,__:[8]},8,["loading"])])])]),a("div",Ne,[a("div",Ie,[a("div",Ee,[a("div",Fe,[l(n,{size:24},{default:s(()=>[l(v(me))]),_:1})]),a("div",Ye,[a("div",He,c(C.value),1),e[9]||(e[9]=a("div",{class:"stat-label"},"待审核",-1))])]),a("div",Le,[a("div",Qe,[l(n,{size:24},{default:s(()=>[l(v(S))]),_:1})]),a("div",Xe,[a("div",qe,c(V.value),1),e[10]||(e[10]=a("div",{class:"stat-label"},"已通过",-1))])]),a("div",Ge,[a("div",Je,[l(n,{size:24},{default:s(()=>[l(v(U))]),_:1})]),a("div",Ke,[a("div",Oe,c(j.value),1),e[11]||(e[11]=a("div",{class:"stat-label"},"已拒绝",-1))])]),a("div",We,[a("div",Ze,[l(n,{size:24},{default:s(()=>[l(v(fe))]),_:1})]),a("div",et,[a("div",tt,c(L.value),1),e[12]||(e[12]=a("div",{class:"stat-label"},"总审核数",-1))])])])]),a("div",at,[a("div",lt,[l(I,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=o=>z.value=o),placeholder:"搜索资源名称或作者",clearable:"",style:{width:"250px"},onInput:q},{prefix:s(()=>[l(n,null,{default:s(()=>[l(v(ge))]),_:1})]),_:1},8,["modelValue"]),l(ne,{modelValue:R.value,"onUpdate:modelValue":e[1]||(e[1]=o=>R.value=o),placeholder:"分类筛选",clearable:"",style:{width:"150px"},onChange:G},{default:s(()=>[(k(!0),T(Ve,null,je(P.value,o=>(k(),H(oe,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),a("div",st,[l(h,{type:"success",onClick:le,disabled:u.value.length===0},{default:s(()=>[l(n,null,{default:s(()=>[l(v(S))]),_:1}),e[13]||(e[13]=d(" 批量通过 "))]),_:1,__:[13]},8,["disabled"]),l(h,{type:"danger",onClick:se,disabled:u.value.length===0},{default:s(()=>[l(n,null,{default:s(()=>[l(v(U))]),_:1}),e[14]||(e[14]=d(" 批量拒绝 "))]),_:1,__:[14]},8,["disabled"])])]),a("div",ot,[Be((k(),H(re,{data:$.value,style:{width:"100%"},"header-cell-style":{background:"var(--bg-secondary)",color:"var(--text-primary)"},"row-style":{background:"var(--bg-card)"},border:"",stripe:"",onSelectionChange:O},{default:s(()=>[l(y,{type:"selection",width:"55"}),l(y,{prop:"name",label:"资源名称","min-width":"200"},{default:s(({row:o})=>[a("div",nt,[l(E,{href:o.file_url,target:"_blank",type:"primary"},{default:s(()=>[d(c(o.name),1)]),_:2},1032,["href"]),a("div",rt,c(o.description||"暂无描述"),1)])]),_:1}),l(y,{prop:"author",label:"作者",width:"120"}),l(y,{prop:"category_id",label:"分类",width:"100"},{default:s(({row:o})=>[d(c(X(o.category_id)),1)]),_:1}),l(y,{prop:"created_at",label:"上传时间",width:"180"},{default:s(({row:o})=>[d(c(N(o.created_at)),1)]),_:1}),l(y,{label:"操作",width:"200",fixed:"right"},{default:s(({row:o})=>[l(h,{size:"small",type:"success",onClick:F=>W(o)},{default:s(()=>[l(n,null,{default:s(()=>[l(v(S))]),_:1}),e[15]||(e[15]=d(" 通过 "))]),_:2,__:[15]},1032,["onClick"]),l(h,{size:"small",type:"danger",onClick:F=>Z(o)},{default:s(()=>[l(n,null,{default:s(()=>[l(v(U))]),_:1}),e[16]||(e[16]=d(" 拒绝 "))]),_:2,__:[16]},1032,["onClick"]),l(h,{size:"small",onClick:F=>ee(o)},{default:s(()=>[l(n,null,{default:s(()=>[l(v(he))]),_:1}),e[17]||(e[17]=d(" 详情 "))]),_:2,__:[17]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[ve,x.value]]),a("div",it,[l(ie,{"current-page":w.value,"onUpdate:currentPage":e[2]||(e[2]=o=>w.value=o),"page-size":A.value,"onUpdate:pageSize":e[3]||(e[3]=o=>A.value=o),"page-sizes":[10,20,50,100],total:M.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:J,onCurrentChange:K},null,8,["current-page","page-size","total"])])]),l(ce,{modelValue:b.value,"onUpdate:modelValue":e[6]||(e[6]=o=>b.value=o),title:m.value==="approve"?"通过审核":"拒绝审核",width:"500px",onClose:ae},{footer:s(()=>[a("div",ct,[l(h,{onClick:e[5]||(e[5]=o=>b.value=!1)},{default:s(()=>e[23]||(e[23]=[d("取消")])),_:1,__:[23]}),l(h,{type:m.value==="approve"?"success":"danger",onClick:te,loading:D.value},{default:s(()=>[d(" 确认"+c(m.value==="approve"?"通过":"拒绝"),1)]),_:1},8,["type","loading"])])]),default:s(()=>[_.value?(k(),T("div",dt,[a("div",ut,[a("h3",null,c(_.value.name),1),a("p",null,[e[18]||(e[18]=a("strong",null,"作者：",-1)),d(c(_.value.author),1)]),a("p",null,[e[19]||(e[19]=a("strong",null,"描述：",-1)),d(c(_.value.description||"暂无描述"),1)]),a("p",null,[e[20]||(e[20]=a("strong",null,"上传时间：",-1)),d(c(N(_.value.created_at)),1)]),a("p",null,[e[22]||(e[22]=a("strong",null,"文件链接：",-1)),l(E,{href:_.value.file_url,target:"_blank"},{default:s(()=>e[21]||(e[21]=[d("查看文件")])),_:1,__:[21]},8,["href"])])]),l(ue,{model:g,"label-width":"80px",class:"review-form"},{default:s(()=>[l(de,{label:"审核备注"},{default:s(()=>[l(I,{modelValue:g.comment,"onUpdate:modelValue":e[4]||(e[4]=o=>g.comment=o),type:"textarea",rows:4,placeholder:m.value==="approve"?"可选：添加通过审核的备注":"请说明拒绝的原因"},null,8,["modelValue","placeholder"])]),_:1})]),_:1},8,["model"])])):Pe("",!0)]),_:1},8,["modelValue","title"])])}}}),yt=Ce(vt,[["__scopeId","data-v-86e9b8a5"]]);export{yt as default};
