import{x as he,r as c,X as ke,c as V,ay as we,j as Ce,y as d,A as l,Q as o,K as f,O as m,H as y,I as a,M as i,al as _,u as D,P as H,a6 as N,J as be,a4 as Ve,V as De,ar as xe,ax as Te,z as r}from"../chunks/vue-vendor-BleHOoLr.js";import{u as Q,N as Pe,i as Ee,v as Ie,G as u,E as Le}from"../chunks/element-plus-BqgU8HW0.js";import{c as K}from"../chunks/comments-BV3pQ790.js";import{_ as Me}from"../assets/index-BYq8Q9FJ.js";import{a as Re,b as Ue,u as ze,d as Be}from"../chunks/posts-s6Ksrwn6.js";import{a as Se}from"../chunks/tags-xaH3Xs2k.js";import{u as Ae}from"../chunks/auth-DsME7P3V.js";import{f as Fe}from"../chunks/format-B9owEeWI.js";import"../chunks/utils-Dq7h7Pqt.js";const He={class:"post-detail-container"},Ne={class:"post-content-wrapper"},Ke={key:0,class:"post-header"},Ye={class:"post-meta"},qe={class:"post-title-section"},$e={class:"post-title"},je={class:"post-status-badges"},Ge={class:"post-info"},Je={class:"author-info"},Oe={class:"author-name"},Qe={class:"post-time"},Xe={class:"post-stats"},We={class:"stat-item"},Ze={class:"stat-item"},et={class:"stat-item"},tt={key:0,class:"post-tags"},ot={key:1,class:"post-body"},st={class:"content-wrapper"},at=["innerHTML"],lt={key:2,class:"post-actions"},nt={class:"comments-section"},rt={class:"comments-title"},ut={key:0,class:"comment-form"},it={class:"comment-actions"},ct={key:1,class:"login-prompt"},dt={class:"comments-list"},mt={key:0,class:"empty-comments"},_t={key:1,class:"comment-items"},vt={class:"comment-header"},pt={class:"comment-author"},ft={class:"comment-author-name"},gt={class:"comment-time"},yt={class:"comment-actions"},ht={class:"comment-content"},kt={class:"dialog-footer"},wt=he({__name:"PostDetail",setup(Ct){const Y=e=>Fe(e,"YYYY-MM-DD HH:mm"),X=we(),E=Te(),q=Ae(),s=c(),x=c([]),I=c([]),$=c([]),j=c(!1),T=c(!1),L=c(!1),h=c(!1),M=c(!1),R=c(!1),U=c(),k=c(""),C=c(!1),z=c(),v=ke({title:"",content:"",tags:[]}),W={title:[{required:!0,message:"请输入标题",trigger:"blur"},{min:1,max:200,message:"标题长度在 1 到 200 个字符",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"},{min:10,message:"内容至少 10 个字符",trigger:"blur"}]},B=V(()=>q.isLoggedIn),p=V(()=>q.currentUser),w=V(()=>parseInt(X.params.id)),Z=V(()=>!s.value||!p.value.value?!1:s.value.author_id===p.value.value?.id||p.value.value?.role==="admin"||p.value.value?.role==="elder"),ee=V(()=>!s.value||!p.value.value?!1:s.value.author_id===p.value.value?.id||p.value.value?.role==="admin"),G=async()=>{j.value=!0;try{const e=await Re(w.value);e.code===0&&e.data?(s.value=e.data,te(),S()):(u.error("帖子不存在"),E.push("/posts"))}catch(e){console.error("加载帖子失败:",e),u.error("加载帖子失败")}finally{j.value=!1}},te=async()=>{try{const e=await Ue(w.value);e.code===0&&e.data&&(x.value=e.data)}catch(e){console.error("加载标签失败:",e)}},S=async()=>{T.value=!0;try{const e=await K.getPostComments(w.value);e.code===0&&e.data&&(I.value=e.data.list)}catch(e){console.error("加载评论失败:",e)}finally{T.value=!1}},oe=async()=>{try{const e=await Se();e.code===0&&e.data&&($.value=e.data)}catch(e){console.error("加载所有标签失败:",e)}},se=e=>e.replace(/\n/g,"<br>"),ae=async()=>{if(!B.value){u.warning("请先登录");return}L.value=!0;try{h.value=!h.value,s.value&&(s.value.like_count+=h.value?1:-1),u.success(h.value?"点赞成功":"取消点赞成功")}catch(e){console.error("点赞失败:",e),u.error("操作失败")}finally{L.value=!1}},le=()=>{U.value&&U.value.focus()},J=async()=>{if(k.value.trim()){M.value=!0;try{const e=await K.createComment({target_type:"Post",target_id:w.value,content:k.value});e.code===0?(u.success("评论发表成功"),k.value="",S(),s.value&&s.value.comment_count++):u.error(e.message||"评论发表失败")}catch(e){console.error("发表评论失败:",e),u.error("发表评论失败")}finally{M.value=!1}}},ne=()=>{s.value&&(v.title=s.value.title,v.content=s.value.content,v.tags=x.value.map(e=>e.name),C.value=!0)},re=async()=>{if(z.value)try{await z.value.validate(),R.value=!0;const e=await ze(w.value,v);e.code===0?(u.success("帖子更新成功"),C.value=!1,G()):u.error(e.msg||"更新失败")}catch(e){console.error("更新帖子失败:",e),u.error("更新帖子失败")}finally{R.value=!1}},ue=()=>{Le.confirm("确定要删除这个帖子吗？删除后无法恢复。","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const e=await Be(w.value);e.code===0?(u.success("帖子删除成功"),E.push("/posts")):u.error(e.msg||"删除失败")}catch(e){console.error("删除帖子失败:",e),u.error("删除帖子失败")}})},ie=async e=>{try{const t=await K.deleteComment(e);t.code===0?(u.success("评论删除成功"),S(),s.value&&s.value.comment_count--):u.error(t.message||"删除失败")}catch(t){console.error("删除评论失败:",t),u.error("删除评论失败")}},ce=e=>p.value.value?e.user_id===p.value.value?.id||p.value.value?.role==="admin"||p.value.value?.role==="elder":!1,de=()=>{E.push("/login")};return Ce(()=>{G(),oe()}),(e,t)=>{const P=_("el-tag"),b=_("el-icon"),O=_("el-avatar"),g=_("el-button"),me=_("el-button-group"),A=_("el-input"),_e=_("el-empty"),F=_("el-form-item"),ve=_("el-option"),pe=_("el-select"),fe=_("el-form"),ge=_("el-dialog"),ye=xe("loading");return r(),d("div",He,[l("div",Ne,[s.value?(r(),d("div",Ke,[l("div",Ye,[l("div",qe,[l("h1",$e,m(s.value.title),1),l("div",je,[s.value.is_pinned?(r(),y(P,{key:0,type:"warning",size:"small"},{default:a(()=>t[6]||(t[6]=[i("置顶")])),_:1,__:[6]})):f("",!0),s.value.is_featured?(r(),y(P,{key:1,type:"success",size:"small"},{default:a(()=>t[7]||(t[7]=[i("精选")])),_:1,__:[7]})):f("",!0),s.value.status==="Draft"?(r(),y(P,{key:2,type:"info",size:"small"},{default:a(()=>t[8]||(t[8]=[i("草稿")])),_:1,__:[8]})):f("",!0)])]),l("div",Ge,[l("div",Je,[o(O,{size:32,class:"author-avatar"},{default:a(()=>[o(b,null,{default:a(()=>[o(D(Q))]),_:1})]),_:1}),l("span",Oe,m(s.value.author_name),1),l("span",Qe,m(Y(s.value.created_at)),1)]),l("div",Xe,[l("span",We,[o(b,null,{default:a(()=>[o(D(Pe))]),_:1}),i(" "+m(s.value.view_count)+" 浏览 ",1)]),l("span",Ze,[o(b,null,{default:a(()=>[o(D(Ee))]),_:1}),i(" "+m(s.value.comment_count)+" 评论 ",1)]),l("span",et,[o(b,null,{default:a(()=>[o(D(Ie))]),_:1}),i(" "+m(s.value.like_count)+" 点赞 ",1)])])])]),x.value.length>0?(r(),d("div",tt,[(r(!0),d(H,null,N(x.value,n=>(r(),y(P,{key:n.id,color:n.color,class:"tag-item"},{default:a(()=>[i(m(n.name),1)]),_:2},1032,["color"]))),128))])):f("",!0)])):f("",!0),s.value?(r(),d("div",ot,[l("div",st,[l("div",{class:"post-content",innerHTML:se(s.value.content)},null,8,at)])])):f("",!0),s.value&&B.value?(r(),d("div",lt,[o(me,null,{default:a(()=>[o(g,{type:"primary",icon:h.value?"Star":"StarFilled",onClick:ae,loading:L.value},{default:a(()=>[i(m(h.value?"取消点赞":"点赞"),1)]),_:1},8,["icon","loading"]),o(g,{type:"info",icon:"ChatDotRound",onClick:le},{default:a(()=>t[9]||(t[9]=[i(" 评论 ")])),_:1,__:[9]}),Z.value?(r(),y(g,{key:0,type:"warning",icon:"Edit",onClick:ne},{default:a(()=>t[10]||(t[10]=[i(" 编辑 ")])),_:1,__:[10]})):f("",!0),ee.value?(r(),y(g,{key:1,type:"danger",icon:"Delete",onClick:ue},{default:a(()=>t[11]||(t[11]=[i(" 删除 ")])),_:1,__:[11]})):f("",!0)]),_:1})])):f("",!0),l("div",nt,[l("h3",rt,"评论 ("+m(s.value?.comment_count||0)+")",1),B.value?(r(),d("div",ut,[o(A,{ref_key:"commentInputRef",ref:U,modelValue:k.value,"onUpdate:modelValue":t[0]||(t[0]=n=>k.value=n),type:"textarea",rows:3,placeholder:"写下你的评论...",onKeydown:Ve(De(J,["ctrl"]),["enter"])},null,8,["modelValue","onKeydown"]),l("div",it,[o(g,{type:"primary",onClick:J,loading:M.value,disabled:!k.value.trim()},{default:a(()=>t[12]||(t[12]=[i(" 发表评论 ")])),_:1,__:[12]},8,["loading","disabled"]),t[13]||(t[13]=l("span",{class:"comment-tip"},"Ctrl + Enter 快速发表",-1))])])):(r(),d("div",ct,[o(g,{type:"primary",onClick:de},{default:a(()=>t[14]||(t[14]=[i("登录后发表评论")])),_:1,__:[14]})])),be((r(),d("div",dt,[I.value.length===0&&!T.value?(r(),d("div",mt,[o(_e,{description:"暂无评论"})])):(r(),d("div",_t,[(r(!0),d(H,null,N(I.value,n=>(r(),d("div",{key:n.id,class:"comment-item"},[l("div",vt,[l("div",pt,[o(O,{size:24,class:"comment-avatar"},{default:a(()=>[o(b,null,{default:a(()=>[o(D(Q))]),_:1})]),_:1}),l("span",ft,m(n.username),1),l("span",gt,m(Y(n.created_at)),1)]),l("div",yt,[ce(n)?(r(),y(g,{key:0,type:"danger",size:"small",onClick:bt=>ie(n.id)},{default:a(()=>t[15]||(t[15]=[i(" 删除 ")])),_:2,__:[15]},1032,["onClick"])):f("",!0)])]),l("div",ht,m(n.content),1)]))),128))]))])),[[ye,T.value]])])]),o(ge,{modelValue:C.value,"onUpdate:modelValue":t[5]||(t[5]=n=>C.value=n),title:"编辑帖子",width:"60%"},{footer:a(()=>[l("span",kt,[o(g,{onClick:t[4]||(t[4]=n=>C.value=!1)},{default:a(()=>t[16]||(t[16]=[i("取消")])),_:1,__:[16]}),o(g,{type:"primary",onClick:re,loading:R.value},{default:a(()=>t[17]||(t[17]=[i(" 保存 ")])),_:1,__:[17]},8,["loading"])])]),default:a(()=>[o(fe,{ref_key:"editFormRef",ref:z,model:v,rules:W,"label-width":"80px"},{default:a(()=>[o(F,{label:"标题",prop:"title"},{default:a(()=>[o(A,{modelValue:v.title,"onUpdate:modelValue":t[1]||(t[1]=n=>v.title=n),placeholder:"请输入帖子标题"},null,8,["modelValue"])]),_:1}),o(F,{label:"内容",prop:"content"},{default:a(()=>[o(A,{modelValue:v.content,"onUpdate:modelValue":t[2]||(t[2]=n=>v.content=n),type:"textarea",rows:8,placeholder:"请输入帖子内容"},null,8,["modelValue"])]),_:1}),o(F,{label:"标签"},{default:a(()=>[o(pe,{modelValue:v.tags,"onUpdate:modelValue":t[3]||(t[3]=n=>v.tags=n),multiple:"",filterable:"","allow-create":"",placeholder:"选择或创建标签"},{default:a(()=>[(r(!0),d(H,null,N($.value,n=>(r(),y(ve,{key:n.id,label:n.name,value:n.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Rt=Me(wt,[["__scopeId","data-v-3c5ba8dd"]]);export{Rt as default};
