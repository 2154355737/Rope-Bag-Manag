import{x as oe,c as E,ay as ne,r as f,X as ae,j as se,y as u,A as n,Q as a,I as r,M as c,al as v,u as b,P as N,O as p,K as h,a6 as le,H as w,ax as re,z as s}from"../chunks/vue-vendor-BleHOoLr.js";import{I as ie,v as ue,J as ce,K as de,L as me,G as l,E as _e}from"../chunks/element-plus-BqgU8HW0.js";import{g as L,_ as pe}from"../assets/index-C1pGffEW.js";import{p as ve}from"../chunks/packages-CRAYzmY8.js";import{c as S}from"../chunks/comments-CfdOdxrk.js";import"../chunks/utils-Dq7h7Pqt.js";const fe={class:"comments-container"},ge={class:"header"},ye={key:0,class:"loading"},ke={key:1,class:"not-found"},Ce={class:"resource-info"},he={class:"meta"},we={class:"author"},ze={class:"date"},Ie={class:"comments-section"},be={key:0,class:"no-comments"},xe={key:1,class:"comment-list"},Se={class:"comment-header"},Be={class:"comment-author"},Pe={class:"comment-time"},Ve={class:"comment-content"},Ne={class:"comment-actions"},Te={key:2,class:"pagination"},Ae={class:"comment-form"},De={class:"form-actions"},Ee=oe({__name:"ResourceComment",setup(Le){const R=ne(),T=re(),g=E(()=>Number(R.params.id)||0),B=f(!0),i=f(null),y=f([]),k=f(0),z=f(1),x=f(10),P=f(!1),d=ae({content:"",parentId:null}),I=E(()=>localStorage.getItem("isLoggedIn")==="true"),A=t=>new Date(t).toLocaleDateString("zh-CN"),M=()=>{T.back()},U=()=>{T.push("/home")},$=async()=>{if(g.value)try{B.value=!0;const t=await ve.getPackage(g.value);t.code===0&&t.data?i.value=t.data:(l.error(t.message||"加载资源失败"),i.value=null)}catch(t){console.error("加载资源出错:",t),l.error("加载资源时发生错误"),i.value=null}finally{B.value=!1}},C=async()=>{if(g.value)try{const t=await S.getPackageComments(g.value,{page:z.value,size:x.value});t.code===0&&t.data?(y.value=t.data.list||[],k.value=t.data.total||0):(console.warn("加载评论返回错误:",t.message),y.value=[],k.value=0)}catch(t){console.error("加载评论出错:",t),y.value=[],k.value=0}},j=t=>i.value?t.username===i.value.author:!1,F=t=>{if(!I.value)return!1;const e=L();return!e||!i.value?!1:e.role==="Admin"||e.role==="Elder"||e.username===i.value.author},H=async t=>{try{const e=await S.pinComment(t.id,!t.pinned);e.code===0?(l.success(t.pinned?"取消置顶成功":"置顶成功"),C()):l.error(e.message||"操作失败")}catch(e){console.error("置顶失败:",e),l.error("置顶时发生错误")}},K=async()=>{if(!I.value){l.warning("请先登录后再发表评论");return}if(!d.content.trim()){l.warning("评论内容不能为空");return}if(g.value)try{P.value=!0;const t=await S.createComment({content:d.content.trim(),target_id:g.value,target_type:"package",parent_id:d.parentId??void 0});t.code===0?(l.success("评论发布成功"),d.content="",d.parentId=null,C()):l.error(t.message||"发布评论失败")}catch(t){console.error("发布评论失败:",t),l.error("发布评论时发生错误")}finally{P.value=!1}},q=async t=>{try{if({code:0,message:"点赞成功"}.code===0){l.success("点赞成功");const m=y.value.find(_=>_.id===t);m&&(m.likes=(m.likes||0)+1)}}catch(e){console.error("点赞失败:",e),l.error("点赞时发生错误")}},G=t=>{d.parentId=t,setTimeout(()=>{document.querySelector(".comment-form")?.scrollIntoView({behavior:"smooth"})},100)},J=async t=>{try{await _e.confirm("确定要删除此评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await S.deleteComment(t);e.code===0?(l.success("删除成功"),C()):l.error(e.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除评论失败:",e),l.error("删除评论时发生错误"))}},O=t=>{if(!I.value)return!1;const e=L();return e?e.role==="admin"||e.role==="moderator"?!0:t.user_id===e.id:!1},Q=t=>{x.value=t,z.value=1,C()},X=t=>{z.value=t,C()};return se(async()=>{await Promise.all([$(),C()])}),(t,e)=>{const m=v("el-icon"),_=v("el-button"),W=v("el-skeleton"),Y=v("el-empty"),D=v("el-tag"),Z=v("el-pagination"),ee=v("el-alert"),te=v("el-input");return s(),u("div",fe,[n("div",ge,[a(_,{class:"back-btn",onClick:M,type:"default",plain:""},{default:r(()=>[a(m,null,{default:r(()=>[a(b(ie))]),_:1}),e[3]||(e[3]=c(" 返回资源 "))]),_:1,__:[3]}),e[4]||(e[4]=n("h1",{class:"title"},"资源评论",-1))]),B.value?(s(),u("div",ye,[a(W,{rows:10,animated:""})])):i.value?(s(),u(N,{key:2},[n("div",Ce,[n("h2",null,p(i.value.name),1),n("div",he,[n("span",we,"作者: "+p(i.value.author),1),n("span",ze,"发布时间: "+p(A(i.value.created_at)),1)])]),n("div",Ie,[n("h3",null,"评论 ("+p(k.value)+")",1),y.value.length===0?(s(),u("div",be,e[6]||(e[6]=[n("p",null,"暂无评论，来发表第一条评论吧！",-1)]))):(s(),u("div",xe,[(s(!0),u(N,null,le(y.value,o=>(s(),u("div",{key:o.id,class:"comment-item"},[n("div",Se,[n("div",Be,[c(p(o.author_name||"匿名用户")+" ",1),j(o)?(s(),w(D,{key:0,type:"warning",size:"small",class:"ml-1"},{default:r(()=>e[7]||(e[7]=[c("作者")])),_:1,__:[7]})):h("",!0),o.pinned?(s(),w(D,{key:1,type:"primary",size:"small",class:"ml-1"},{default:r(()=>e[8]||(e[8]=[c("置顶")])),_:1,__:[8]})):h("",!0)]),n("div",Pe,p(A(o.created_at)),1)]),n("div",Ve,p(o.content),1),n("div",Ne,[a(_,{link:"",size:"small",onClick:V=>q(o.id)},{default:r(()=>[a(m,null,{default:r(()=>[a(b(ue))]),_:1}),c(" 点赞 ("+p(o.likes||0)+") ",1)]),_:2},1032,["onClick"]),I.value?(s(),w(_,{key:0,link:"",size:"small",onClick:V=>G(o.id)},{default:r(()=>[a(m,null,{default:r(()=>[a(b(ce))]),_:1}),e[9]||(e[9]=c(" 回复 "))]),_:2,__:[9]},1032,["onClick"])):h("",!0),O(o)?(s(),w(_,{key:1,link:"",size:"small",onClick:V=>J(o.id)},{default:r(()=>[a(m,null,{default:r(()=>[a(b(de))]),_:1}),e[10]||(e[10]=c(" 删除 "))]),_:2,__:[10]},1032,["onClick"])):h("",!0),F()?(s(),w(_,{key:2,link:"",size:"small",onClick:V=>H(o)},{default:r(()=>[a(m,null,{default:r(()=>[a(b(me))]),_:1}),c(" "+p(o.pinned?"取消置顶":"置顶"),1)]),_:2},1032,["onClick"])):h("",!0)])]))),128))])),k.value>0?(s(),u("div",Te,[a(Z,{"current-page":z.value,"onUpdate:currentPage":e[0]||(e[0]=o=>z.value=o),"page-size":x.value,"onUpdate:pageSize":e[1]||(e[1]=o=>x.value=o),total:k.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Q,onCurrentChange:X,background:""},null,8,["current-page","page-size","total"])])):h("",!0),n("div",Ae,[e[12]||(e[12]=n("h3",null,"发表评论",-1)),I.value?(s(),u(N,{key:1},[a(te,{modelValue:d.content,"onUpdate:modelValue":e[2]||(e[2]=o=>d.content=o),type:"textarea",rows:4,placeholder:"请输入您的评论",maxlength:500,"show-word-limit":""},null,8,["modelValue"]),n("div",De,[a(_,{type:"primary",onClick:K,loading:P.value,disabled:!d.content},{default:r(()=>e[11]||(e[11]=[c(" 提交评论 ")])),_:1,__:[11]},8,["loading","disabled"])])],64)):(s(),w(ee,{key:0,title:"请先登录后再发表评论",type:"warning",closable:!1,"show-icon":""}))])])],64)):(s(),u("div",ke,[a(Y,{description:"资源不存在或已被删除"}),a(_,{type:"primary",onClick:U},{default:r(()=>e[5]||(e[5]=[c("返回首页")])),_:1,__:[5]})]))])}}}),He=pe(Ee,[["__scopeId","data-v-51cff197"]]);export{He as default};
