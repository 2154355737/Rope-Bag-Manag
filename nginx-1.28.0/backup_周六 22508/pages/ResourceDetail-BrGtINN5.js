import{x as we,c as B,ay as ze,r as p,X as xe,y as _,A as s,az as H,P,a6 as K,C as be,Q as a,H as g,K as f,I as o,M as u,u as v,al as y,O as d,ax as Ie,z as n}from"../chunks/vue-vendor-BleHOoLr.js";import{u as G,j as Se,I as Ae,C as De,f as J,v as R,J as Pe,K as Te,L as qe,G as r,E as Ee}from"../chunks/element-plus-BqgU8HW0.js";import{T as Fe}from"../chunks/ThemeSwitcher-DAmAmwYA.js";import{g as T}from"../assets/index-BYq8Q9FJ.js";import{p as O}from"../chunks/packages-D1bca-EI.js";import{c as b}from"../chunks/comments-BV3pQ790.js";import{c as Me}from"../chunks/categories-CDxQep1u.js";import"../chunks/utils-Dq7h7Pqt.js";const Ne={class:"resource-detail-container"},Ve={class:"dynamic-background"},$e={class:"floating-particles"},Le={class:"header"},Be={class:"header-content"},Re={class:"actions"},Ue={class:"main"},Qe={class:"main-content"},je={key:0,class:"loading-container"},He={key:1,class:"not-found"},Ke={class:"resource-header"},Ge={class:"resource-title-area"},Je={class:"resource-title"},Oe={class:"resource-meta"},Xe={class:"meta-item"},We={class:"meta-item"},Ye={class:"meta-item"},Ze={class:"meta-item"},et={class:"resource-content"},tt={class:"resource-description"},at={class:"description-content"},st={class:"resource-actions"},ot={class:"comments-section"},lt={key:0,class:"no-comments"},nt={key:1,class:"comment-list"},rt={class:"comment-header"},it={class:"comment-meta"},ct={class:"comment-author"},ut={key:1,class:"comment-qq ml-1"},dt={class:"comment-time"},mt={class:"comment-content"},vt={class:"comment-actions"},_t={key:2,class:"pagination"},pt={class:"comment-form"},ft={class:"form-actions"},It=we({__name:"ResourceDetail",setup(gt){const X=ze(),z=Ie(),h=B(()=>Number(X.params.id)||0),q=p(!0),i=p(null),C=p([]),E=p([]),F=p(""),I=p(0),x=p(1),S=p(10),U=p(!1),M=p(!1),N=p(!1),k=xe({content:"",parentId:null}),w=B(()=>localStorage.getItem("isLoggedIn")==="true");B(()=>{const e=T();return e?e.id:null});const Q=e=>new Date(e).toLocaleDateString("zh-CN"),W=e=>e?{admin:"管理员",moderator:"版主",elder:"长老",user:"用户"}[e]||e:"",V=()=>{z.push("/home")},Y=()=>{z.push("/login")},Z=()=>{const e=T();if(!e){z.push("/login");return}e.role==="admin"||e.role==="moderator"?z.push("/admin"):e.role==="elder"?z.push("/elder"):e.role==="user"?z.push("/user"):z.push("/403")},ee=async()=>{if(h.value)try{q.value=!0;const e=await O.getPackage(h.value);e.code===0&&e.data?(i.value=e.data,i.value.category_id&&await ae(i.value.category_id)):(r.error(e.message||"加载资源失败"),i.value=null)}catch(e){console.error("加载资源出错:",e),r.error("加载资源时发生错误"),i.value=null}finally{q.value=!1}},A=async()=>{if(h.value)try{const e=await b.getPackageComments(h.value,{page:x.value,size:S.value});e.code===0&&e.data?(C.value=e.data.list||[],I.value=e.data.total||0):(console.warn("加载评论返回错误:",e.message),C.value=[],I.value=0)}catch(e){console.error("加载评论出错:",e),C.value=[],I.value=0}},te=async()=>{try{const e=await Me.getCategories();e.code===0&&e.data&&(E.value=e.data.list||[])}catch(e){console.error("加载分类出错:",e)}},ae=async e=>{E.value.length===0&&await te();const t=E.value.find(c=>c.id===e);F.value=t?t.name:"未分类"},se=e=>e&&{1:"#409EFF",2:"#67C23A",3:"#E6A23C",4:"#F56C6C",5:"#909399"}[e]||"#409EFF",oe=async()=>{if(h.value)try{const e=await O.downloadPackage(h.value);e.code===0?(e.data&&typeof e.data=="string"&&window.open(e.data,"_blank"),r.success("下载开始"),ee()):r.error(e.message||"下载失败")}catch(e){console.error("下载失败:",e),r.error("下载资源时发生错误")}},le=async()=>{if(!w.value){r.warning("请先登录后再点赞");return}if(h.value)try{M.value=!0,{code:0,message:"点赞成功"}.code===0&&(r.success("点赞成功"),U.value=!0,i.value&&(i.value.like_count+=1))}catch(e){console.error("点赞失败:",e),r.error("点赞时发生错误")}finally{M.value=!1}},ne=async()=>{if(!w.value){r.warning("请先登录后再发表评论");return}if(!k.content.trim()){r.warning("评论内容不能为空");return}if(h.value)try{N.value=!0;const e=await b.createComment({content:k.content.trim(),target_id:h.value,target_type:"Package",parent_id:k.parentId??void 0});e.code===0?(r.success("评论发布成功"),k.content="",k.parentId=null,A()):r.error(e.message||"发布评论失败")}catch(e){console.error("发布评论失败:",e),r.error("发布评论时发生错误")}finally{N.value=!1}},re=async e=>{try{const t=await b.likeComment(e,!0);if(t.code===0){r.success("点赞成功");const c=C.value.find(m=>m.id===e);c&&(c.likes=t.data??c.likes+1)}else r.error(t.message||"点赞失败")}catch(t){console.error("点赞失败:",t),r.error("点赞时发生错误")}},ie=e=>{k.parentId=e,setTimeout(()=>{document.querySelector(".comment-form")?.scrollIntoView({behavior:"smooth"})},100)},ce=async e=>{try{await Ee.confirm("确定要删除此评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=await b.deleteComment(e);t.code===0?(r.success("删除成功"),A()):r.error(t.message||"删除失败")}catch(t){t!=="cancel"&&(console.error("删除评论失败:",t),r.error("删除评论时发生错误"))}},ue=e=>{if(!w.value)return!1;const t=T();return t?t.role==="admin"||t.role==="moderator"?!0:e.user_id===t.id:!1},de=e=>{if(!w.value)return!1;const t=T();return!t||!i.value?!1:t.role==="Admin"||t.role==="Elder"||t.username===i.value.author},me=async e=>{try{const t=await b.pinComment(e.id,!e.pinned);t.code===0?(r.success(e.pinned?"取消置顶成功":"置顶成功"),e.pinned=!e.pinned):r.error(t.message||"操作失败")}catch(t){console.error("置顶失败:",t),r.error("置顶时发生错误")}},ve=e=>i.value?(console.log("检查作者身份:",{comment_author:e.username,resource_author:i.value.author,is_match:e.username===i.value.author}),e.username===i.value.author):!1,_e=e=>{S.value=e,x.value=1,A()},pe=e=>{x.value=e,A()},fe=e=>{const t=Math.random()*4+2,c=Math.random()*100,m=Math.random()*20,$=Math.random()*10+10;return{width:`${t}px`,height:`${t}px`,left:`${c}%`,animationDelay:`${m}s`,animationDuration:`${$}s`}};return(e,t)=>{const c=y("el-icon"),m=y("el-button"),$=y("el-skeleton"),ge=y("el-empty"),D=y("el-tag"),j=y("el-divider"),ye=y("el-avatar"),he=y("el-pagination"),ke=y("el-alert"),Ce=y("el-input");return n(),_("div",Ne,[s("div",Ve,[t[3]||(t[3]=H('<div class="gradient-layer"></div><div class="geometric-shapes"><div class="shape triangle-1"></div><div class="shape triangle-2"></div><div class="shape circle-1"></div><div class="shape circle-2"></div><div class="shape square-1"></div><div class="shape circle-3"></div><div class="shape triangle-3"></div><div class="shape square-2"></div></div>',2)),s("div",$e,[(n(),_(P,null,K(20,l=>s("div",{class:"particle",key:l,style:be(fe())},null,4)),64))]),t[4]||(t[4]=H('<div class="ripple-effects"><div class="ripple ripple-1"></div><div class="ripple ripple-2"></div><div class="ripple ripple-3"></div><div class="ripple ripple-4"></div><div class="ripple ripple-5"></div></div>',1))]),s("header",Le,[s("div",Be,[s("div",{class:"logo",onClick:V},t[5]||(t[5]=[s("div",{class:"logo-icon"},"📚",-1),s("div",{class:"logo-text"},[s("h1",null,"资源社区"),s("p",null,"分享、发现、学习")],-1)])),s("div",Re,[a(Fe),w.value?f("",!0):(n(),g(m,{key:0,type:"primary",size:"large",onClick:Y},{default:o(()=>[a(c,null,{default:o(()=>[a(v(G))]),_:1}),t[6]||(t[6]=u(" 登录 "))]),_:1,__:[6]})),w.value?(n(),g(m,{key:1,type:"success",size:"large",onClick:Z},{default:o(()=>[a(c,null,{default:o(()=>[a(v(Se))]),_:1}),t[7]||(t[7]=u(" 管理后台 "))]),_:1,__:[7]})):f("",!0)])])]),s("main",Ue,[s("div",Qe,[a(m,{class:"back-btn",onClick:V,type:"default",plain:""},{default:o(()=>[a(c,null,{default:o(()=>[a(v(Ae))]),_:1}),t[8]||(t[8]=u(" 返回列表 "))]),_:1,__:[8]}),q.value?(n(),_("div",je,[a($,{rows:10,animated:""})])):i.value?(n(),_(P,{key:2},[s("div",Ke,[s("div",Ge,[s("h1",Je,d(i.value.name),1),F.value?(n(),g(D,{key:0,class:"resource-category",size:"large",color:se(i.value.category_id)},{default:o(()=>[u(d(F.value),1)]),_:1},8,["color"])):f("",!0)]),s("div",Oe,[s("span",Xe,[a(c,null,{default:o(()=>[a(v(G))]),_:1}),u(" 作者: "+d(i.value.author),1)]),s("span",We,[a(c,null,{default:o(()=>[a(v(De))]),_:1}),u(" 发布时间: "+d(Q(i.value.created_at)),1)]),s("span",Ye,[a(c,null,{default:o(()=>[a(v(J))]),_:1}),u(" 下载次数: "+d(i.value.download_count),1)]),s("span",Ze,[a(c,null,{default:o(()=>[a(v(R))]),_:1}),u(" 点赞数: "+d(i.value.like_count),1)])])]),a(j),s("div",et,[s("div",tt,[t[10]||(t[10]=s("h2",null,"资源描述",-1)),s("div",at,d(i.value.description||"暂无描述信息"),1)]),s("div",st,[a(m,{type:"primary",size:"large",onClick:oe},{default:o(()=>[a(c,null,{default:o(()=>[a(v(J))]),_:1}),t[11]||(t[11]=u(" 下载资源 "))]),_:1,__:[11]}),a(m,{type:"default",size:"large",onClick:le,loading:M.value},{default:o(()=>[a(c,null,{default:o(()=>[a(v(R))]),_:1}),u(" "+d(U.value?"已点赞":"点赞"),1)]),_:1},8,["loading"])])]),a(j),s("div",ot,[s("h2",null,"用户评论 ("+d(C.value.length)+")",1),C.value.length===0?(n(),_("div",lt,t[12]||(t[12]=[s("p",null,"暂无评论，成为第一个评论的用户吧！",-1)]))):(n(),_("div",nt,[(n(!0),_(P,null,K(C.value,l=>(n(),_("div",{key:l.id,class:"comment-item"},[s("div",rt,[a(ye,{src:l.author_avatar,size:"small",class:"comment-avatar"},{default:o(()=>[u(d((l.author_name||"匿").charAt(0)),1)]),_:2},1032,["src"]),s("div",it,[s("span",ct,[u(d(l.author_name||"匿名用户")+" ",1),ve(l)?(n(),g(D,{key:0,size:"small",type:"warning",class:"ml-1"},{default:o(()=>t[13]||(t[13]=[u("作者")])),_:1,__:[13]})):f("",!0),l.pinned?(n(),g(D,{key:1,size:"small",type:"primary",class:"ml-1"},{default:o(()=>t[14]||(t[14]=[u("置顶")])),_:1,__:[14]})):f("",!0)]),l.author_role?(n(),g(D,{key:0,size:"small",type:"success",class:"ml-1"},{default:o(()=>[u(d(W(l.author_role)),1)]),_:2},1024)):f("",!0),l.author_qq?(n(),_("span",ut,"QQ: "+d(l.author_qq),1)):f("",!0)]),s("div",dt,d(Q(l.created_at)),1)]),s("div",mt,d(l.content),1),s("div",vt,[a(m,{link:"",size:"small",onClick:L=>re(l.id)},{default:o(()=>[a(c,null,{default:o(()=>[a(v(R))]),_:1}),u(" 点赞 ("+d(l.likes||0)+") ",1)]),_:2},1032,["onClick"]),w.value?(n(),g(m,{key:0,link:"",size:"small",onClick:L=>ie(l.id)},{default:o(()=>[a(c,null,{default:o(()=>[a(v(Pe))]),_:1}),t[15]||(t[15]=u(" 回复 "))]),_:2,__:[15]},1032,["onClick"])):f("",!0),ue(l)?(n(),g(m,{key:1,link:"",size:"small",onClick:L=>ce(l.id)},{default:o(()=>[a(c,null,{default:o(()=>[a(v(Te))]),_:1}),t[16]||(t[16]=u(" 删除 "))]),_:2,__:[16]},1032,["onClick"])):f("",!0),de()?(n(),g(m,{key:2,link:"",size:"small",onClick:L=>me(l)},{default:o(()=>[a(c,null,{default:o(()=>[a(v(qe))]),_:1}),u(" "+d(l.pinned?"取消置顶":"置顶"),1)]),_:2},1032,["onClick"])):f("",!0)])]))),128))])),C.value.length>0?(n(),_("div",_t,[a(he,{"current-page":x.value,"onUpdate:currentPage":t[0]||(t[0]=l=>x.value=l),"page-size":S.value,"onUpdate:pageSize":t[1]||(t[1]=l=>S.value=l),total:I.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:_e,onCurrentChange:pe,background:""},null,8,["current-page","page-size","total"])])):f("",!0),s("div",pt,[t[18]||(t[18]=s("h3",null,"发表评论",-1)),w.value?(n(),_(P,{key:1},[a(Ce,{modelValue:k.content,"onUpdate:modelValue":t[2]||(t[2]=l=>k.content=l),type:"textarea",rows:4,placeholder:"请输入您的评论",maxlength:500,"show-word-limit":""},null,8,["modelValue"]),s("div",ft,[a(m,{type:"primary",onClick:ne,loading:N.value,disabled:!k.content},{default:o(()=>t[17]||(t[17]=[u(" 提交评论 ")])),_:1,__:[17]},8,["loading","disabled"])])],64)):(n(),g(ke,{key:0,title:"请先登录后再发表评论",type:"warning",closable:!1,"show-icon":""}))])])],64)):(n(),_("div",He,[a(ge,{description:"资源不存在或已被删除"}),a(m,{type:"primary",onClick:V},{default:o(()=>t[9]||(t[9]=[u("返回首页")])),_:1,__:[9]})]))])])])}}});export{It as default};
