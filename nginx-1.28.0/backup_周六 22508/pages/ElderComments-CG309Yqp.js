import{x as he,r as y,X as R,c as J,j as ye,y as j,A as o,Q as t,H as C,K as D,I as a,al as r,M as c,u as z,O as f,a4 as O,J as be,ar as Ce,D as we,z as g}from"../chunks/vue-vendor-BleHOoLr.js";import{i as ke,a5 as xe,a9 as Ve,v as X,Q as W,G as i,E as P}from"../chunks/element-plus-BqgU8HW0.js";import{c as S}from"../chunks/comments-Dykap-Hr.js";import{g as De,_ as ze}from"../assets/index-KJvHh4NK.js";import"../chunks/utils-Dq7h7Pqt.js";const Se={class:"elder-comments-page"},$e={class:"page-header"},Ae={class:"header-content"},Ee={class:"header-tabs"},Te={class:"stat-content"},Ue={class:"stat-icon"},Be={class:"stat-info"},Fe={class:"stat-number"},Ye={class:"stat-label"},He={class:"stat-content"},Me={class:"stat-icon"},Le={class:"stat-info"},Ne={class:"stat-number"},Ie={class:"stat-content"},Ke={class:"stat-icon"},Re={class:"stat-info"},je={class:"stat-number"},Oe={class:"stat-content"},Pe={class:"stat-icon"},Qe={class:"stat-info"},qe={class:"stat-number"},Ge={class:"batch-actions"},Je={class:"selection-info"},Xe={class:"action-buttons"},We={class:"comment-content-cell"},Ze={class:"comment-meta"},et={key:0,class:"author"},tt={class:"likes"},at={key:1,class:"text-muted"},lt={class:"table-actions"},st={class:"pagination-wrapper"},ot={class:"dialog-footer"},nt=he({__name:"ElderComments",setup(dt){const F=y(null),Y=y(!1),H=y(!1),w=y(!1),A=y(!1),v=y("my"),Q=De(),k=y([]),h=y([]),M=y(null),L=y(null),x=R({page:1,pageSize:20}),d=R({status:"",resource_name:"",username:"",search:"",start_date:"",end_date:""}),E=R({content:""}),Z={content:[{required:!0,message:"请输入评论内容",trigger:"blur"},{min:5,max:500,message:"评论内容长度在 5 到 500 个字符之间",trigger:"blur"}]},ee=J(()=>k.value.length),T=J(()=>{const l=k.value.length,e=k.value.filter(m=>m.status==="Active").length,n=k.value.filter(m=>m.status==="Hidden").length,u=k.value.reduce((m,b)=>m+(b.likes||0),0);return{total:l,active:e,hidden:n,totalLikes:u}}),te=l=>{v.value=l,q()},_=async()=>{Y.value=!0;try{const l={page:x.page,size:x.pageSize,...d};Object.keys(l).forEach(u=>{(l[u]===""||l[u]===null)&&delete l[u]});const e={...l};e.start_date&&typeof e.start_date=="string"&&(e.start_date=new Date(e.start_date)),e.end_date&&typeof e.end_date=="string"&&(e.end_date=new Date(e.end_date));let n;if(v.value==="my"){if(!Q?.id)return;n=await S.getUserComments(Q.id,e)}else n=await S.getAllComments(e);n.code===0?k.value=n.data?.list||[]:i.error(n.message||"加载评论失败")}catch(l){console.error("加载评论列表失败:",l),i.error("加载评论列表失败")}finally{Y.value=!1}},ae=l=>{l&&l.length===2?(d.start_date=l[0],d.end_date=l[1]):(d.start_date="",d.end_date="")},q=()=>{d.status="",d.resource_name="",d.username="",d.search="",d.start_date="",d.end_date="",L.value=null,x.page=1,_()},le=l=>{h.value=l},N=()=>{h.value=[]},se=l=>{M.value=l,E.content=l.content,A.value=!0},oe=async l=>{const e=l.status==="Active"?"Hidden":"Active",n=e==="Active"?"显示":"隐藏";try{const u=await S.updateComment(l.id,{status:e});u.code===0?(i.success(`评论已${n}`),_()):i.error(u.message||`${n}失败`)}catch(u){console.error("切换评论状态失败:",u),i.error(`${n}失败`)}},G=async l=>{if(h.value.length===0){i.warning("请先选择要操作的评论");return}const e=l==="Active"?"显示":"隐藏";try{await P.confirm(`确定要批量${e}选中的 ${h.value.length} 条评论吗？`,`确认批量${e}`,{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),w.value=!0;const n=h.value.map(m=>m.id),u=await S.batchUpdateStatus(n,l);u.code===0?(i.success(`批量${e}成功`),N(),_()):i.error(u.message||`批量${e}失败`)}catch(n){n!=="cancel"&&(console.error("批量更新状态失败:",n),i.error(`批量${e}失败`))}finally{w.value=!1}},ne=async()=>{if(h.value.length===0){i.warning("请先选择要删除的评论");return}try{await P.confirm(`确定要批量删除选中的 ${h.value.length} 条评论吗？此操作不可恢复。`,"确认批量删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),w.value=!0;const l=h.value.map(n=>n.id),e=await S.batchDeleteComments(l);e.code===0?(i.success("批量删除成功"),N(),_()):i.error(e.message||"批量删除失败")}catch(l){l!=="cancel"&&(console.error("批量删除失败:",l),i.error("批量删除失败"))}finally{w.value=!1}},de=async()=>{if(!(!F.value||!M.value))try{await F.value.validate(),H.value=!0;const l=await S.updateComment(M.value.id,{content:E.content});l.code===0?(i.success("评论更新成功"),A.value=!1,_()):i.error(l.message||"更新失败")}catch(l){console.error("更新评论失败:",l),i.error("更新失败")}finally{H.value=!1}},ie=async l=>{try{await P.confirm("确定要删除这条评论吗？此操作不可恢复。","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await S.deleteComment(l.id);e.code===0?(i.success("删除成功"),_()):i.error(e.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除评论失败:",e),i.error("删除失败"))}},re=l=>{const e=new Date(l),n=new Date;return n.getTime()-e.getTime()<864e5&&e.getDate()===n.getDate()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.getFullYear()===n.getFullYear()?e.toLocaleDateString("zh-CN",{month:"short",day:"numeric"}):e.toLocaleDateString("zh-CN")};return ye(()=>{_()}),(l,e)=>{const n=r("el-radio-button"),u=r("el-radio-group"),m=r("el-icon"),b=r("el-card"),U=r("el-col"),ce=r("el-row"),I=r("el-option"),ue=r("el-select"),V=r("el-form-item"),B=r("el-input"),_e=r("el-date-picker"),p=r("el-button"),$=r("el-table-column"),me=r("el-tag"),pe=r("el-table"),fe=r("el-pagination"),ve=r("el-dialog"),ge=Ce("loading");return g(),j("div",Se,[o("div",$e,[o("div",Ae,[e[15]||(e[15]=o("h2",null,"评论管理",-1)),o("div",Ee,[t(u,{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=s=>v.value=s),onChange:te},{default:a(()=>[t(n,{label:"my"},{default:a(()=>e[13]||(e[13]=[c("我的评论")])),_:1,__:[13]}),t(n,{label:"all"},{default:a(()=>e[14]||(e[14]=[c("全站评论")])),_:1,__:[14]})]),_:1},8,["modelValue"])])])]),t(ce,{gutter:20,class:"stats-row"},{default:a(()=>[t(U,{span:6},{default:a(()=>[t(b,{shadow:"hover",class:"stat-card"},{default:a(()=>[o("div",Te,[o("div",Ue,[t(m,{color:"#409EFF"},{default:a(()=>[t(z(ke))]),_:1})]),o("div",Be,[o("div",Fe,f(T.value.total),1),o("div",Ye,f(v.value==="my"?"我的评论":"总评论数"),1)])])]),_:1})]),_:1}),t(U,{span:6},{default:a(()=>[t(b,{shadow:"hover",class:"stat-card"},{default:a(()=>[o("div",He,[o("div",Me,[t(m,{color:"#67C23A"},{default:a(()=>[t(z(xe))]),_:1})]),o("div",Le,[o("div",Ne,f(T.value.active),1),e[16]||(e[16]=o("div",{class:"stat-label"},"正常显示",-1))])])]),_:1})]),_:1}),t(U,{span:6},{default:a(()=>[t(b,{shadow:"hover",class:"stat-card"},{default:a(()=>[o("div",Ie,[o("div",Ke,[t(m,{color:"#E6A23C"},{default:a(()=>[t(z(Ve))]),_:1})]),o("div",Re,[o("div",je,f(T.value.hidden),1),e[17]||(e[17]=o("div",{class:"stat-label"},"已隐藏",-1))])])]),_:1})]),_:1}),t(U,{span:6},{default:a(()=>[t(b,{shadow:"hover",class:"stat-card"},{default:a(()=>[o("div",Oe,[o("div",Pe,[t(m,{color:"#F56C6C"},{default:a(()=>[t(z(X))]),_:1})]),o("div",Qe,[o("div",qe,f(T.value.totalLikes),1),e[18]||(e[18]=o("div",{class:"stat-label"},"总点赞数",-1))])])]),_:1})]),_:1})]),_:1}),t(b,{shadow:"hover",class:"filter-card"},{default:a(()=>[t(z(W),{model:d,inline:!0,class:"search-form"},{default:a(()=>[t(V,{label:"状态筛选:"},{default:a(()=>[t(ue,{modelValue:d.status,"onUpdate:modelValue":e[1]||(e[1]=s=>d.status=s),placeholder:"全部状态",clearable:"",style:{width:"120px"}},{default:a(()=>[t(I,{label:"全部",value:""}),t(I,{label:"正常",value:"Active"}),t(I,{label:"已隐藏",value:"Hidden"})]),_:1},8,["modelValue"])]),_:1}),v.value==="all"?(g(),C(V,{key:0,label:"资源筛选:"},{default:a(()=>[t(B,{modelValue:d.resource_name,"onUpdate:modelValue":e[2]||(e[2]=s=>d.resource_name=s),placeholder:"输入资源名称",clearable:"",style:{width:"160px"},onKeyup:O(_,["enter"])},null,8,["modelValue"])]),_:1})):D("",!0),v.value==="all"?(g(),C(V,{key:1,label:"用户筛选:"},{default:a(()=>[t(B,{modelValue:d.username,"onUpdate:modelValue":e[3]||(e[3]=s=>d.username=s),placeholder:"输入用户名",clearable:"",style:{width:"140px"},onKeyup:O(_,["enter"])},null,8,["modelValue"])]),_:1})):D("",!0),t(V,{label:"内容搜索:"},{default:a(()=>[t(B,{modelValue:d.search,"onUpdate:modelValue":e[4]||(e[4]=s=>d.search=s),placeholder:"搜索评论内容",clearable:"",style:{width:"200px"},onKeyup:O(_,["enter"])},null,8,["modelValue"])]),_:1}),t(V,{label:"时间范围:"},{default:a(()=>[t(_e,{modelValue:L.value,"onUpdate:modelValue":e[5]||(e[5]=s=>L.value=s),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",style:{width:"240px"},format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:ae},null,8,["modelValue"])]),_:1}),t(V,null,{default:a(()=>[t(p,{type:"primary",icon:"Search",onClick:_},{default:a(()=>e[19]||(e[19]=[c("搜索")])),_:1,__:[19]}),t(p,{icon:"Refresh",onClick:q},{default:a(()=>e[20]||(e[20]=[c("重置")])),_:1,__:[20]})]),_:1})]),_:1},8,["model"])]),_:1}),h.value.length>0?(g(),C(b,{key:0,shadow:"hover",class:"batch-card"},{default:a(()=>[o("div",Ge,[o("span",Je,"已选择 "+f(h.value.length)+" 条评论",1),o("div",Xe,[t(p,{type:"success",icon:"Select",onClick:e[6]||(e[6]=s=>G("Active")),loading:w.value},{default:a(()=>e[21]||(e[21]=[c(" 批量显示 ")])),_:1,__:[21]},8,["loading"]),t(p,{type:"warning",icon:"Hide",onClick:e[7]||(e[7]=s=>G("Hidden")),loading:w.value},{default:a(()=>e[22]||(e[22]=[c(" 批量隐藏 ")])),_:1,__:[22]},8,["loading"]),t(p,{type:"danger",icon:"Delete",onClick:ne,loading:w.value},{default:a(()=>e[23]||(e[23]=[c(" 批量删除 ")])),_:1,__:[23]},8,["loading"]),t(p,{onClick:N},{default:a(()=>e[24]||(e[24]=[c("取消选择")])),_:1,__:[24]})])])]),_:1})):D("",!0),t(b,{shadow:"hover",class:"comments-card"},{default:a(()=>[be((g(),C(pe,{data:k.value,onSelectionChange:le,"row-key":"id"},{default:a(()=>[t($,{type:"selection",width:"55"}),t($,{prop:"content",label:"评论内容","min-width":"300"},{default:a(({row:s})=>[o("div",We,[o("div",{class:we(["content",{"hidden-content":s.status==="Hidden"}])},f(s.content),3),o("div",Ze,[v.value==="all"?(g(),j("span",et," 作者: "+f(s.author_name||"未知"),1)):D("",!0),o("span",tt,[t(m,null,{default:a(()=>[t(z(X))]),_:1}),c(" "+f(s.likes||0),1)])])])]),_:1}),v.value==="all"?(g(),C($,{key:0,prop:"resource",label:"关联资源",width:"150"},{default:a(({row:s})=>[s.resource_id?(g(),C(p,{key:0,type:"text",size:"small",onClick:K=>l.$router.push(`/resource/${s.resource_id}`)},{default:a(()=>e[25]||(e[25]=[c(" 查看资源 ")])),_:2,__:[25]},1032,["onClick"])):(g(),j("span",at,"无关联"))]),_:1})):D("",!0),t($,{prop:"status",label:"状态",width:"80"},{default:a(({row:s})=>[t(me,{type:s.status==="Active"?"success":"warning",size:"small"},{default:a(()=>[c(f(s.status==="Active"?"正常":"隐藏"),1)]),_:2},1032,["type"])]),_:1}),t($,{prop:"created_at",label:"发表时间",width:"120"},{default:a(({row:s})=>[c(f(re(s.created_at)),1)]),_:1}),t($,{label:"操作",width:"180",fixed:"right"},{default:a(({row:s})=>[o("div",lt,[v.value==="my"&&s.status==="Active"?(g(),C(p,{key:0,type:"text",size:"small",icon:"Edit",onClick:K=>se(s)},{default:a(()=>e[26]||(e[26]=[c(" 编辑 ")])),_:2,__:[26]},1032,["onClick"])):D("",!0),v.value==="all"?(g(),C(p,{key:1,type:"text",size:"small",icon:s.status==="Active"?"Hide":"View",onClick:K=>oe(s)},{default:a(()=>[c(f(s.status==="Active"?"隐藏":"显示"),1)]),_:2},1032,["icon","onClick"])):D("",!0),t(p,{type:"text",size:"small",icon:"Delete",onClick:K=>ie(s),class:"delete-btn"},{default:a(()=>e[27]||(e[27]=[c(" 删除 ")])),_:2,__:[27]},1032,["onClick"])])]),_:1})]),_:1},8,["data"])),[[ge,Y.value]]),o("div",st,[t(fe,{"current-page":x.page,"onUpdate:currentPage":e[8]||(e[8]=s=>x.page=s),"page-size":x.pageSize,"onUpdate:pageSize":e[9]||(e[9]=s=>x.pageSize=s),"page-sizes":[10,20,50,100],total:ee.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:_,onCurrentChange:_},null,8,["current-page","page-size","total"])])]),_:1}),t(ve,{modelValue:A.value,"onUpdate:modelValue":e[12]||(e[12]=s=>A.value=s),title:"编辑评论",width:"600px","close-on-click-modal":!1},{footer:a(()=>[o("div",ot,[t(p,{onClick:e[11]||(e[11]=s=>A.value=!1)},{default:a(()=>e[28]||(e[28]=[c("取消")])),_:1,__:[28]}),t(p,{type:"primary",onClick:de,loading:H.value},{default:a(()=>e[29]||(e[29]=[c(" 保存修改 ")])),_:1,__:[29]},8,["loading"])])]),default:a(()=>[t(z(W),{model:E,rules:Z,ref_key:"editFormRef",ref:F,"label-width":"80px"},{default:a(()=>[t(V,{label:"评论内容",prop:"content"},{default:a(()=>[t(B,{modelValue:E.content,"onUpdate:modelValue":e[10]||(e[10]=s=>E.content=s),type:"textarea",rows:6,placeholder:"请输入评论内容","show-word-limit":"",maxlength:"500"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),mt=ze(nt,[["__scopeId","data-v-15b8e2ef"]]);export{mt as default};
