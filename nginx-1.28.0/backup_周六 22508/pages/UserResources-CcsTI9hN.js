import{x as Ue,r as b,X as F,c as P,j as xe,y as V,A as n,Q as t,I as a,M as p,al as d,u as g,O as c,a4 as ee,J as Re,ar as ze,K as D,P as E,a6 as $,H as R,z as u}from"../chunks/vue-vendor-BleHOoLr.js";import{l as Ae,a5 as Ie,U as te,f as le,Q,ah as Se,v as Fe,G as m,E as Pe}from"../chunks/element-plus-BqgU8HW0.js";import{p as G}from"../chunks/packages-D1bca-EI.js";import{g as De,_ as Ee}from"../assets/index-BYq8Q9FJ.js";import{u as $e}from"../chunks/users-B3_-qbGS.js";import{c as Me}from"../chunks/categories-CDxQep1u.js";import{c as Be}from"../chunks/posts-s6Ksrwn6.js";import"../chunks/utils-Dq7h7Pqt.js";const Te={class:"user-resource-manage"},je={class:"page-header"},Ne={class:"header-content"},Ke={class:"stat-content"},Le={class:"stat-icon"},qe={class:"stat-info"},Oe={class:"stat-number"},Qe={class:"stat-content"},Ge={class:"stat-icon"},He={class:"stat-info"},Je={class:"stat-number"},Xe={class:"stat-content"},We={class:"stat-icon"},Ye={class:"stat-info"},Ze={class:"stat-number"},et={class:"stat-content"},tt={class:"stat-icon"},lt={class:"stat-info"},at={class:"stat-number"},ot={key:0,class:"empty-state"},st={key:1,class:"resource-grid"},nt={class:"resource-header"},dt=["onClick"],rt={class:"resource-info"},it={class:"info-item"},ut={class:"value"},pt={class:"info-item"},ct={class:"value"},mt={class:"info-item"},_t={class:"resource-description"},ft={class:"resource-stats"},gt={class:"stat-item"},vt={class:"stat-item"},yt={class:"stat-item"},bt={key:2,class:"pagination-wrapper"},Vt={class:"tags-container"},wt={class:"dialog-footer"},kt={class:"dialog-footer"},ht=Ue({__name:"UserResources",setup(Ct){const M=b(null),B=b(null),I=b(!1),T=b(!1),j=b(!1),h=b(!1),z=b(!1),H=De(),C=b([]),A=b([]),N=b(null),w=F({page:1,pageSize:12,total:0}),k=F({status:"",search:""}),s=F({type:"package",name:"",author:H?.username||"",version:"",description:"",category_id:void 0,file_url:"",tags:[],tagsInput:""}),r=F({name:"",version:"",description:"",category_id:void 0,file_url:""}),J={name:[{required:!0,message:"请输入标题",trigger:"blur"},{min:2,max:50,message:"标题长度在 2 到 50 个字符之间",trigger:"blur"}],author:[{required:!0,message:"请输入作者名称",trigger:"blur"}],description:[{required:!0,message:"请输入内容",trigger:"blur"},{min:10,max:500,message:"内容长度在 10 到 500 个字符之间",trigger:"blur"}],file_url:[{pattern:/^https?:\/\/.+/,message:"请输入有效的URL地址",trigger:"blur"}]},K=P(()=>C.value.length),ae=P(()=>C.value.filter(o=>o.status==="Active").length),oe=P(()=>C.value.filter(o=>o.status==="Pending").length),se=P(()=>C.value.reduce((o,e)=>o+e.download_count,0)),v=async()=>{I.value=!0;try{const o={page:w.page,pageSize:w.pageSize,status:k.status||void 0};console.log("📤 加载用户资源参数:",o);const e=await $e.getMyResources(o);e.code===0?(console.log("✅ 用户资源加载成功:",e.data),C.value=e.data?.list||[],w.total=e.data?.total||0):(console.warn("❌ 用户资源加载失败:",e),m.error(e.message||"加载资源失败"))}catch(o){console.error("🚫 加载资源列表失败:",o),m.error("加载资源列表失败")}finally{I.value=!1}},ne=()=>{k.status="",k.search="",w.page=1,v()},de=(o,e)=>{switch(o){case"edit":re(e);break;case"view":window.open(`/resource/${e.id}`,"_blank");break;case"delete":me(e);break}},re=o=>{N.value=o,r.name=o.name,r.version=o.version||"",r.description=o.description||"",r.category_id=o.category_id||void 0,r.file_url=o.file_url,z.value=!0},ie=()=>{const o=s.tagsInput?.trim();o&&o.length>0&&!s.tags.includes(o)&&(s.tags.push(o),s.tagsInput="")},ue=o=>{const e=s.tags.indexOf(o);e>-1&&s.tags.splice(e,1)},pe=async()=>{if(M.value)try{if(s.type==="package"&&!s.file_url){m.error("请填写文件链接");return}if(await M.value.validate(),T.value=!0,s.type==="package"){const o=s.category_id?A.value.find(y=>y.id===s.category_id)?.name:void 0,e={title:s.name,description:s.description,category:o,tags:s.tags,file_url:s.file_url||""};console.log("📤 普通用户提交资源数据:",e);const _=await G.userSubmitResource(e);_.code===0?(m.success("资源上传成功，等待审核"),h.value=!1,X(),v()):m.error(_.message||"上传失败")}else{const o=await Be({title:s.name,content:s.description,category_id:s.category_id,tags:s.tags,status:"Published"});o.code===0?(m.success("帖子发布成功"),h.value=!1,X(),v()):m.error(o.msg||"发布失败")}}catch(o){console.error("提交失败:",o),m.error(s.type==="package"?"上传失败":"发布失败")}finally{T.value=!1}},ce=async()=>{if(!(!B.value||!N.value))try{await B.value.validate(),j.value=!0;const o=await G.updatePackage(N.value.id,r);o.code===0?(m.success("资源更新成功"),z.value=!1,v()):m.error(o.message||"更新失败")}catch(o){console.error("更新资源失败:",o),m.error("更新失败")}finally{j.value=!1}},me=async o=>{try{await Pe.confirm(`确定要删除资源 "${o.name}" 吗？此操作不可恢复。`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await G.deletePackage(o.id);e.code===0?(m.success("删除成功"),v()):m.error(e.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除资源失败:",e),m.error("删除失败"))}},X=()=>{Object.assign(s,{type:"package",name:"",author:H?.username||"",version:"",description:"",category_id:void 0,file_url:"",tags:[],tagsInput:""})},_e=o=>({Active:"success",Pending:"warning",Rejected:"danger",Inactive:"info"})[o]||"info",fe=o=>({Active:"已发布",Pending:"审核中",Rejected:"已拒绝",Inactive:"已下架"})[o]||o,ge=o=>new Date(o).toLocaleDateString("zh-CN"),ve=async()=>{try{console.log("正在加载分类数据...");const o=await Me.getCategories();console.log("分类API响应:",o),o.code===0&&o.data?(A.value=Array.isArray(o.data)?o.data:o.data.list||[],console.log("加载到的分类:",A.value)):console.error("分类API返回错误:",o)}catch(o){console.error("加载分类失败:",o)}};return xe(()=>{ve(),v()}),(o,e)=>{const _=d("el-button"),y=d("el-icon"),x=d("el-card"),S=d("el-col"),ye=d("el-row"),U=d("el-option"),L=d("el-select"),i=d("el-form-item"),f=d("el-input"),be=d("el-empty"),q=d("el-dropdown-item"),Ve=d("el-dropdown-menu"),we=d("el-dropdown"),W=d("el-tag"),ke=d("el-pagination"),Y=d("el-radio"),he=d("el-radio-group"),Z=d("el-dialog"),Ce=ze("loading");return u(),V("div",Te,[n("div",je,[n("div",Ne,[e[24]||(e[24]=n("h2",null,"我的内容",-1)),t(_,{type:"primary",icon:"Plus",onClick:e[0]||(e[0]=l=>h.value=!0)},{default:a(()=>e[23]||(e[23]=[p(" 提交内容 ")])),_:1,__:[23]})])]),t(ye,{gutter:20,class:"stats-row"},{default:a(()=>[t(S,{span:6},{default:a(()=>[t(x,{shadow:"hover",class:"stat-card"},{default:a(()=>[n("div",Ke,[n("div",Le,[t(y,{color:"#409EFF"},{default:a(()=>[t(g(Ae))]),_:1})]),n("div",qe,[n("div",Oe,c(K.value),1),e[25]||(e[25]=n("div",{class:"stat-label"},"总内容数",-1))])])]),_:1})]),_:1}),t(S,{span:6},{default:a(()=>[t(x,{shadow:"hover",class:"stat-card"},{default:a(()=>[n("div",Qe,[n("div",Ge,[t(y,{color:"#67C23A"},{default:a(()=>[t(g(Ie))]),_:1})]),n("div",He,[n("div",Je,c(ae.value),1),e[26]||(e[26]=n("div",{class:"stat-label"},"已发布",-1))])])]),_:1})]),_:1}),t(S,{span:6},{default:a(()=>[t(x,{shadow:"hover",class:"stat-card"},{default:a(()=>[n("div",Xe,[n("div",We,[t(y,{color:"#E6A23C"},{default:a(()=>[t(g(te))]),_:1})]),n("div",Ye,[n("div",Ze,c(oe.value),1),e[27]||(e[27]=n("div",{class:"stat-label"},"审核中",-1))])])]),_:1})]),_:1}),t(S,{span:6},{default:a(()=>[t(x,{shadow:"hover",class:"stat-card"},{default:a(()=>[n("div",et,[n("div",tt,[t(y,{color:"#F56C6C"},{default:a(()=>[t(g(le))]),_:1})]),n("div",lt,[n("div",at,c(se.value),1),e[28]||(e[28]=n("div",{class:"stat-label"},"总下载量",-1))])])]),_:1})]),_:1})]),_:1}),t(x,{shadow:"hover",class:"filter-card"},{default:a(()=>[t(g(Q),{model:k,inline:!0,class:"search-form"},{default:a(()=>[t(i,{label:"状态筛选:"},{default:a(()=>[t(L,{modelValue:k.status,"onUpdate:modelValue":e[1]||(e[1]=l=>k.status=l),placeholder:"全部状态",clearable:"",style:{width:"120px"}},{default:a(()=>[t(U,{label:"全部",value:""}),t(U,{label:"已发布",value:"Active"}),t(U,{label:"审核中",value:"Pending"}),t(U,{label:"已拒绝",value:"Rejected"}),t(U,{label:"已下架",value:"Inactive"})]),_:1},8,["modelValue"])]),_:1}),t(i,{label:"搜索:"},{default:a(()=>[t(f,{modelValue:k.search,"onUpdate:modelValue":e[2]||(e[2]=l=>k.search=l),placeholder:"输入资源名称",clearable:"",style:{width:"200px"},onKeyup:ee(v,["enter"])},null,8,["modelValue"])]),_:1}),t(i,null,{default:a(()=>[t(_,{type:"primary",icon:"Search",onClick:v},{default:a(()=>e[29]||(e[29]=[p("搜索")])),_:1,__:[29]}),t(_,{icon:"Refresh",onClick:ne},{default:a(()=>e[30]||(e[30]=[p("重置")])),_:1,__:[30]})]),_:1})]),_:1},8,["model"])]),_:1}),t(x,{shadow:"hover",class:"resource-list-card"},{default:a(()=>[Re((u(),V("div",null,[C.value.length===0&&!I.value?(u(),V("div",ot,[t(be,{description:"还没有提交任何内容"},{default:a(()=>[t(_,{type:"primary",onClick:e[3]||(e[3]=l=>h.value=!0)},{default:a(()=>e[31]||(e[31]=[p(" 立即提交 ")])),_:1,__:[31]})]),_:1})])):(u(),V("div",st,[(u(!0),V(E,null,$(C.value,l=>(u(),V("div",{key:l.id,class:"resource-card"},[n("div",nt,[n("div",{class:"resource-title",onClick:O=>o.$router.push(`/resource/${l.id}`)},c(l.name),9,dt),t(we,{onCommand:O=>de(O,l)},{dropdown:a(()=>[t(Ve,null,{default:a(()=>[t(q,{command:"edit"},{default:a(()=>e[32]||(e[32]=[p("编辑")])),_:1,__:[32]}),t(q,{command:"view"},{default:a(()=>e[33]||(e[33]=[p("查看")])),_:1,__:[33]}),t(q,{command:"delete",divided:""},{default:a(()=>e[34]||(e[34]=[p("删除")])),_:1,__:[34]})]),_:1})]),default:a(()=>[t(_,{type:"text",size:"small"},{default:a(()=>[t(y,null,{default:a(()=>[t(g(Se))]),_:1})]),_:1})]),_:2},1032,["onCommand"])]),n("div",rt,[n("div",it,[e[35]||(e[35]=n("span",{class:"label"},"作者:",-1)),n("span",ut,c(l.author),1)]),n("div",pt,[e[36]||(e[36]=n("span",{class:"label"},"版本:",-1)),n("span",ct,c(l.version||"未设置"),1)]),n("div",mt,[e[37]||(e[37]=n("span",{class:"label"},"状态:",-1)),t(W,{type:_e(l.status),size:"small"},{default:a(()=>[p(c(fe(l.status)),1)]),_:2},1032,["type"])])]),n("div",_t,c(l.description||"暂无描述"),1),n("div",ft,[n("div",gt,[t(y,null,{default:a(()=>[t(g(le))]),_:1}),n("span",null,c(l.download_count),1)]),n("div",vt,[t(y,null,{default:a(()=>[t(g(Fe))]),_:1}),n("span",null,c(l.like_count||0),1)]),n("div",yt,[t(y,null,{default:a(()=>[t(g(te))]),_:1}),n("span",null,c(ge(l.created_at)),1)])])]))),128))])),K.value>0?(u(),V("div",bt,[t(ke,{"current-page":w.page,"onUpdate:currentPage":e[4]||(e[4]=l=>w.page=l),"page-size":w.pageSize,"onUpdate:pageSize":e[5]||(e[5]=l=>w.pageSize=l),"page-sizes":[10,20,50],total:K.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:v,onCurrentChange:v},null,8,["current-page","page-size","total"])])):D("",!0)])),[[Ce,I.value]])]),_:1}),t(Z,{modelValue:h.value,"onUpdate:modelValue":e[15]||(e[15]=l=>h.value=l),title:"提交内容",width:"600px","close-on-click-modal":!1},{footer:a(()=>[n("div",wt,[t(_,{onClick:e[14]||(e[14]=l=>h.value=!1)},{default:a(()=>e[40]||(e[40]=[p("取消")])),_:1,__:[40]}),t(_,{type:"primary",onClick:pe,loading:T.value},{default:a(()=>[p(c(s.type==="package"?"提交资源":"发布帖子"),1)]),_:1},8,["loading"])])]),default:a(()=>[t(g(Q),{model:s,rules:J,ref_key:"uploadFormRef",ref:M,"label-width":"80px"},{default:a(()=>[t(i,{label:"内容类型"},{default:a(()=>[t(he,{modelValue:s.type,"onUpdate:modelValue":e[6]||(e[6]=l=>s.type=l)},{default:a(()=>[t(Y,{label:"package"},{default:a(()=>e[38]||(e[38]=[p("资源")])),_:1,__:[38]}),t(Y,{label:"post"},{default:a(()=>e[39]||(e[39]=[p("帖子")])),_:1,__:[39]})]),_:1},8,["modelValue"])]),_:1}),t(i,{label:s.type==="package"?"资源名称":"帖子标题",prop:"name"},{default:a(()=>[t(f,{modelValue:s.name,"onUpdate:modelValue":e[7]||(e[7]=l=>s.name=l),placeholder:s.type==="package"?"请输入资源名称":"请输入帖子标题"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),s.type==="package"?(u(),R(i,{key:0,label:"作者",prop:"author"},{default:a(()=>[t(f,{modelValue:s.author,"onUpdate:modelValue":e[8]||(e[8]=l=>s.author=l),placeholder:"当前用户",disabled:""},null,8,["modelValue"])]),_:1})):D("",!0),s.type==="package"?(u(),R(i,{key:1,label:"版本",prop:"version"},{default:a(()=>[t(f,{modelValue:s.version,"onUpdate:modelValue":e[9]||(e[9]=l=>s.version=l),placeholder:"请输入版本号（可选）"},null,8,["modelValue"])]),_:1})):D("",!0),t(i,{label:s.type==="package"?"资源分类":"帖子分类",prop:"category_id"},{default:a(()=>[t(L,{modelValue:s.category_id,"onUpdate:modelValue":e[10]||(e[10]=l=>s.category_id=l),placeholder:s.type==="package"?"请选择资源分类":"请选择帖子分类",style:{width:"100%"}},{default:a(()=>[(u(!0),V(E,null,$(A.value,l=>(u(),R(U,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),t(i,{label:s.type==="package"?"资源描述":"帖子内容",prop:"description"},{default:a(()=>[t(f,{modelValue:s.description,"onUpdate:modelValue":e[11]||(e[11]=l=>s.description=l),type:"textarea",rows:4,placeholder:s.type==="package"?"请输入资源描述":"请输入帖子内容"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),t(i,{label:"标签"},{default:a(()=>[t(f,{modelValue:s.tagsInput,"onUpdate:modelValue":e[12]||(e[12]=l=>s.tagsInput=l),placeholder:"输入标签，用逗号分隔",onKeyup:ee(ie,["enter"]),clearable:""},null,8,["modelValue"]),n("div",Vt,[(u(!0),V(E,null,$(s.tags,l=>(u(),R(W,{key:l,closable:"",onClose:O=>ue(l),effect:"light"},{default:a(()=>[p(c(l),1)]),_:2},1032,["onClose"]))),128))])]),_:1}),s.type==="package"?(u(),R(i,{key:2,label:"文件链接",prop:"file_url"},{default:a(()=>[t(f,{modelValue:s.file_url,"onUpdate:modelValue":e[13]||(e[13]=l=>s.file_url=l),placeholder:"请输入文件下载链接"},null,8,["modelValue"])]),_:1})):D("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Z,{modelValue:z.value,"onUpdate:modelValue":e[22]||(e[22]=l=>z.value=l),title:"编辑资源",width:"600px","close-on-click-modal":!1},{footer:a(()=>[n("div",kt,[t(_,{onClick:e[21]||(e[21]=l=>z.value=!1)},{default:a(()=>e[41]||(e[41]=[p("取消")])),_:1,__:[41]}),t(_,{type:"primary",onClick:ce,loading:j.value},{default:a(()=>e[42]||(e[42]=[p(" 保存修改 ")])),_:1,__:[42]},8,["loading"])])]),default:a(()=>[t(g(Q),{model:r,rules:J,ref_key:"editFormRef",ref:B,"label-width":"80px"},{default:a(()=>[t(i,{label:"资源名称",prop:"name"},{default:a(()=>[t(f,{modelValue:r.name,"onUpdate:modelValue":e[16]||(e[16]=l=>r.name=l),placeholder:"请输入资源名称"},null,8,["modelValue"])]),_:1}),t(i,{label:"版本",prop:"version"},{default:a(()=>[t(f,{modelValue:r.version,"onUpdate:modelValue":e[17]||(e[17]=l=>r.version=l),placeholder:"请输入版本号（可选）"},null,8,["modelValue"])]),_:1}),t(i,{label:"分类",prop:"category_id"},{default:a(()=>[t(L,{modelValue:r.category_id,"onUpdate:modelValue":e[18]||(e[18]=l=>r.category_id=l),placeholder:"请选择分类",style:{width:"100%"}},{default:a(()=>[(u(!0),V(E,null,$(A.value,l=>(u(),R(U,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(i,{label:"资源描述",prop:"description"},{default:a(()=>[t(f,{modelValue:r.description,"onUpdate:modelValue":e[19]||(e[19]=l=>r.description=l),type:"textarea",rows:4,placeholder:"请输入资源描述"},null,8,["modelValue"])]),_:1}),t(i,{label:"文件链接",prop:"file_url"},{default:a(()=>[t(f,{modelValue:r.file_url,"onUpdate:modelValue":e[20]||(e[20]=l=>r.file_url=l),placeholder:"请输入文件下载链接"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Pt=Ee(ht,[["__scopeId","data-v-cc1b0933"]]);export{Pt as default};
