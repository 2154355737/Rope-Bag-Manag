import{x as De,r as m,X as Ae,j as Me,y as D,A as u,Q as t,I as a,al as d,a4 as $e,u as v,P as q,a6 as H,H as V,M as n,J as Ue,K as A,ar as Te,O as b,ax as Se,z as p}from"../chunks/vue-vendor-BleHOoLr.js";import{q as O,X as Ie,N as W,i as Fe,v as Ee,Y as Re,aa as Be,G as f,E as M}from"../chunks/element-plus-BqgU8HW0.js";import{_ as Ne}from"../assets/index-BYq8Q9FJ.js";import{c as Ye}from"../chunks/categories-CDxQep1u.js";import{g as qe,b as He,u as Z,d as Ke}from"../chunks/posts-s6Ksrwn6.js";import{a as je}from"../chunks/tags-xaH3Xs2k.js";import{f as Le}from"../chunks/format-B9owEeWI.js";import"../chunks/utils-Dq7h7Pqt.js";const Qe={class:"post-manage"},Xe={class:"filters"},Ge={class:"search-buttons"},Je={class:"table-container"},Oe={class:"post-title"},We={class:"post-badges"},Ze={class:"post-stats"},et={key:0,class:"batch-actions"},tt={class:"pagination"},at={class:"dialog-footer"},lt=De({__name:"PostManage",setup(ot){const ee=Se(),te=o=>Le(o,"YYYY-MM-DD HH:mm"),I=m(!1),F=m(!1),K=m([]),E=m([]),j=m([]),k=m([]),L=m(0),$=m(1),R=m(20),U=m(""),T=m(""),h=m(""),x=m(!1),B=m(),s=Ae({title:"",content:"",category_id:void 0,tags:[],status:"Draft",is_pinned:!1,is_featured:!1}),ae={title:[{required:!0,message:"请输入标题",trigger:"blur"},{min:1,max:200,message:"标题长度在 1 到 200 个字符",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"},{min:10,message:"内容至少 10 个字符",trigger:"blur"}]},c=async()=>{I.value=!0;try{console.log("🔍 [PostManage] 开始加载帖子");const o={page:$.value,page_size:R.value,search:U.value||void 0,status:T.value||void 0,category_id:h.value?parseInt(h.value):void 0};console.log("🔍 [PostManage] 请求参数:",o);const e=await qe(o);if(console.log("🔍 [PostManage] API响应:",e),e.code===0&&e.data){const r=Array.isArray(e.data)?e.data:e.data.list||[],y=Array.isArray(e.data)?e.data.length:e.data.total||r.length;console.log("🔍 [PostManage] 解析后的帖子列表:",r),console.log("🔍 [PostManage] 总数:",y),K.value=r,L.value=y,r.length===0&&console.warn("⚠️ [PostManage] 帖子列表为空")}else console.error("❌ [PostManage] API返回错误:",e),f.error(e.msg||e.message||"加载帖子失败")}catch(o){console.error("❌ [PostManage] 请求异常:",o),f.error("加载帖子失败")}finally{I.value=!1}},le=async()=>{try{const o=await Ye.getCategories();o.code===0&&o.data&&(E.value=o.data?.list||o.data||[])}catch(o){console.error("加载分类失败:",o)}},oe=async()=>{try{const o=await je();o.code===0&&o.data&&(j.value=o.data)}catch(o){console.error("加载标签失败:",o)}},se=()=>{U.value="",T.value="",h.value="",$.value=1,c()},ne=o=>{k.value=o},Q=o=>{ee.push(`/posts/${o}`)},de=o=>{s.id=o.id,s.title=o.title,s.content=o.content,s.category_id=o.category_id,s.status=o.status,s.is_pinned=o.is_pinned,s.is_featured=o.is_featured,s.tags=[],x.value=!0,re(o.id)},re=async o=>{try{const e=await He(o);e.code===0&&e.data&&(s.tags=e.data.map(r=>r.name))}catch(e){console.error("加载帖子标签失败:",e)}},ie=()=>{s.id=void 0,s.title="",s.content="",s.category_id=void 0,s.status="Draft",s.is_pinned=!1,s.is_featured=!1,s.tags=[]},ue=async()=>{if(B.value)try{await B.value.validate(),F.value=!0;const{id:o,...e}=s,r=await Z(o,e);r.code===0?(f.success("帖子更新成功"),x.value=!1,c()):f.error(r.msg||"更新失败")}catch(o){console.error("保存帖子失败:",o),f.error("保存失败")}finally{F.value=!1}},_e=async(o,e)=>{const[r,y]=o.split("-"),C=parseInt(y);try{let i={},g="";switch(r){case"pin":i.is_pinned=!e.is_pinned,g=e.is_pinned?"取消置顶成功":"置顶成功";break;case"feature":i.is_featured=!e.is_featured,g=e.is_featured?"取消精选成功":"设为精选成功";break;case"archive":i.status="Archived",g="归档成功";break;case"publish":i.status="Published",g="发布成功";break;case"delete":await M.confirm("确定要删除这个帖子吗？","确认删除",{type:"warning"}),(await Ke(C)).code===0&&(f.success("删除成功"),c());return}const _=await Z(C,i);_.code===0?(f.success(g),c()):f.error(_.msg||"操作失败")}catch(i){i!=="cancel"&&(console.error("操作失败:",i),f.error("操作失败"))}},me=async()=>{try{await M.confirm(`确定要置顶选中的 ${k.value.length} 个帖子吗？`,"批量置顶"),f.info("批量置顶功能开发中...")}catch{}},ce=async()=>{try{await M.confirm(`确定要将选中的 ${k.value.length} 个帖子设为精选吗？`,"批量精选"),f.info("批量精选功能开发中...")}catch{}},pe=async()=>{try{await M.confirm(`确定要归档选中的 ${k.value.length} 个帖子吗？`,"批量归档"),f.info("批量归档功能开发中...")}catch{}},fe=async()=>{try{await M.confirm(`确定要删除选中的 ${k.value.length} 个帖子吗？此操作不可恢复！`,"批量删除",{type:"warning"}),f.info("批量删除功能开发中...")}catch{}},ge=()=>{c()},ve=o=>{switch(o){case"Published":return"success";case"Draft":return"info";case"Archived":return"warning";default:return"info"}},be=o=>{switch(o){case"Published":return"已发布";case"Draft":return"草稿";case"Archived":return"已归档";default:return o}};return Me(()=>{c(),le(),oe()}),(o,e)=>{const r=d("el-icon"),y=d("el-input"),C=d("el-col"),i=d("el-option"),g=d("el-select"),_=d("el-button"),X=d("el-row"),w=d("el-table-column"),ye=d("el-link"),N=d("el-tag"),z=d("el-dropdown-item"),we=d("el-dropdown-menu"),Ve=d("el-dropdown"),G=d("el-button-group"),ke=d("el-table"),Ce=d("el-pagination"),P=d("el-form-item"),Y=d("el-radio"),Pe=d("el-radio-group"),J=d("el-checkbox"),he=d("el-form"),xe=d("el-dialog"),ze=Te("loading");return p(),D("div",Qe,[e[36]||(e[36]=u("div",{class:"page-header"},[u("h1",null,"帖子管理"),u("p",null,"管理社区帖子内容")],-1)),u("div",Xe,[t(X,{gutter:16},{default:a(()=>[t(C,{span:6},{default:a(()=>[t(y,{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=l=>U.value=l),placeholder:"搜索帖子标题或内容...",clearable:"",onKeyup:$e(c,["enter"]),onClear:c},{prefix:a(()=>[t(r,null,{default:a(()=>[t(v(O))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(C,{span:4},{default:a(()=>[t(g,{modelValue:T.value,"onUpdate:modelValue":e[1]||(e[1]=l=>T.value=l),placeholder:"选择状态",clearable:"",onChange:c},{default:a(()=>[t(i,{label:"全部",value:""}),t(i,{label:"已发布",value:"Published"}),t(i,{label:"草稿",value:"Draft"}),t(i,{label:"已归档",value:"Archived"})]),_:1},8,["modelValue"])]),_:1}),t(C,{span:4},{default:a(()=>[t(g,{modelValue:h.value,"onUpdate:modelValue":e[2]||(e[2]=l=>h.value=l),placeholder:"选择分类",clearable:"",onChange:c},{default:a(()=>[t(i,{label:"全部",value:""}),(p(!0),D(q,null,H(E.value,l=>(p(),V(i,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(C,{span:6},{default:a(()=>[u("div",Ge,[t(_,{onClick:ge},{default:a(()=>[t(r,null,{default:a(()=>[t(v(Ie))]),_:1}),e[14]||(e[14]=n(" 刷新 "))]),_:1,__:[14]}),t(_,{type:"primary",onClick:c},{default:a(()=>[t(r,null,{default:a(()=>[t(v(O))]),_:1}),e[15]||(e[15]=n(" 查询 "))]),_:1,__:[15]})]),t(_,{onClick:se,style:{"margin-top":"10px"}},{default:a(()=>e[16]||(e[16]=[n("重置")])),_:1,__:[16]})]),_:1})]),_:1})]),u("div",Je,[Ue((p(),V(ke,{data:K.value,stripe:"",style:{width:"100%"},onSelectionChange:ne},{default:a(()=>[t(w,{type:"selection",width:"55"}),t(w,{prop:"id",label:"ID",width:"80"}),t(w,{prop:"title",label:"标题","min-width":"200"},{default:a(({row:l})=>[u("div",Oe,[t(ye,{type:"primary",onClick:S=>Q(l.id)},{default:a(()=>[n(b(l.title),1)]),_:2},1032,["onClick"]),u("div",We,[l.is_pinned?(p(),V(N,{key:0,type:"warning",size:"small"},{default:a(()=>e[17]||(e[17]=[n("置顶")])),_:1,__:[17]})):A("",!0),l.is_featured?(p(),V(N,{key:1,type:"success",size:"small"},{default:a(()=>e[18]||(e[18]=[n("精选")])),_:1,__:[18]})):A("",!0)])])]),_:1}),t(w,{prop:"author_name",label:"作者",width:"120"}),t(w,{prop:"status",label:"状态",width:"100"},{default:a(({row:l})=>[t(N,{type:ve(l.status),size:"small"},{default:a(()=>[n(b(be(l.status)),1)]),_:2},1032,["type"])]),_:1}),t(w,{label:"统计",width:"120"},{default:a(({row:l})=>[u("div",Ze,[u("span",null,[t(r,null,{default:a(()=>[t(v(W))]),_:1}),n(" "+b(l.view_count),1)]),u("span",null,[t(r,null,{default:a(()=>[t(v(Fe))]),_:1}),n(" "+b(l.comment_count),1)]),u("span",null,[t(r,null,{default:a(()=>[t(v(Ee))]),_:1}),n(" "+b(l.like_count),1)])])]),_:1}),t(w,{prop:"created_at",label:"创建时间",width:"160"},{default:a(({row:l})=>[n(b(te(l.created_at)),1)]),_:1}),t(w,{label:"操作",width:"300",fixed:"right"},{default:a(({row:l})=>[t(G,null,{default:a(()=>[t(_,{size:"small",onClick:S=>Q(l.id)},{default:a(()=>[t(r,null,{default:a(()=>[t(v(W))]),_:1}),e[19]||(e[19]=n(" 查看 "))]),_:2,__:[19]},1032,["onClick"]),t(_,{size:"small",type:"primary",onClick:S=>de(l)},{default:a(()=>[t(r,null,{default:a(()=>[t(v(Re))]),_:1}),e[20]||(e[20]=n(" 编辑 "))]),_:2,__:[20]},1032,["onClick"]),t(Ve,{onCommand:S=>_e(S,l)},{dropdown:a(()=>[t(we,null,{default:a(()=>[t(z,{command:`pin-${l.id}`},{default:a(()=>[n(b(l.is_pinned?"取消置顶":"置顶"),1)]),_:2},1032,["command"]),t(z,{command:`feature-${l.id}`},{default:a(()=>[n(b(l.is_featured?"取消精选":"设为精选"),1)]),_:2},1032,["command"]),l.status!=="Archived"?(p(),V(z,{key:0,command:`archive-${l.id}`},{default:a(()=>e[22]||(e[22]=[n(" 归档 ")])),_:2,__:[22]},1032,["command"])):A("",!0),l.status!=="Published"?(p(),V(z,{key:1,command:`publish-${l.id}`},{default:a(()=>e[23]||(e[23]=[n(" 发布 ")])),_:2,__:[23]},1032,["command"])):A("",!0),t(z,{command:`delete-${l.id}`,divided:""},{default:a(()=>e[24]||(e[24]=[u("span",{style:{color:"#f56c6c"}},"删除",-1)])),_:2,__:[24]},1032,["command"])]),_:2},1024)]),default:a(()=>[t(_,{size:"small"},{default:a(()=>[e[21]||(e[21]=n(" 更多")),t(r,{class:"el-icon--right"},{default:a(()=>[t(v(Be))]),_:1})]),_:1,__:[21]})]),_:2},1032,["onCommand"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ze,I.value]]),k.value.length>0?(p(),D("div",et,[u("span",null,"已选择 "+b(k.value.length)+" 个帖子",1),t(G,null,{default:a(()=>[t(_,{size:"small",onClick:me},{default:a(()=>e[25]||(e[25]=[n("批量置顶")])),_:1,__:[25]}),t(_,{size:"small",onClick:ce},{default:a(()=>e[26]||(e[26]=[n("批量精选")])),_:1,__:[26]}),t(_,{size:"small",onClick:pe},{default:a(()=>e[27]||(e[27]=[n("批量归档")])),_:1,__:[27]}),t(_,{size:"small",type:"danger",onClick:fe},{default:a(()=>e[28]||(e[28]=[n("批量删除")])),_:1,__:[28]})]),_:1})])):A("",!0),u("div",tt,[t(Ce,{"current-page":$.value,"onUpdate:currentPage":e[3]||(e[3]=l=>$.value=l),"page-size":R.value,"onUpdate:pageSize":e[4]||(e[4]=l=>R.value=l),"page-sizes":[10,20,50,100],total:L.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:c,onCurrentChange:c},null,8,["current-page","page-size","total"])])]),t(xe,{modelValue:x.value,"onUpdate:modelValue":e[13]||(e[13]=l=>x.value=l),title:"编辑帖子",width:"800px",onClose:ie},{footer:a(()=>[u("span",at,[t(_,{onClick:e[12]||(e[12]=l=>x.value=!1)},{default:a(()=>e[34]||(e[34]=[n("取消")])),_:1,__:[34]}),t(_,{type:"primary",onClick:ue,loading:F.value},{default:a(()=>e[35]||(e[35]=[n(" 保存 ")])),_:1,__:[35]},8,["loading"])])]),default:a(()=>[t(he,{ref_key:"editFormRef",ref:B,model:s,rules:ae,"label-width":"100px"},{default:a(()=>[t(P,{label:"标题",prop:"title"},{default:a(()=>[t(y,{modelValue:s.title,"onUpdate:modelValue":e[5]||(e[5]=l=>s.title=l),maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(P,{label:"内容",prop:"content"},{default:a(()=>[t(y,{modelValue:s.content,"onUpdate:modelValue":e[6]||(e[6]=l=>s.content=l),type:"textarea",rows:10,maxlength:"10000","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(P,{label:"分类"},{default:a(()=>[t(g,{modelValue:s.category_id,"onUpdate:modelValue":e[7]||(e[7]=l=>s.category_id=l),placeholder:"选择分类"},{default:a(()=>[(p(!0),D(q,null,H(E.value,l=>(p(),V(i,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(P,{label:"标签"},{default:a(()=>[t(g,{modelValue:s.tags,"onUpdate:modelValue":e[8]||(e[8]=l=>s.tags=l),multiple:"",filterable:"","allow-create":"",placeholder:"选择或创建标签"},{default:a(()=>[(p(!0),D(q,null,H(j.value,l=>(p(),V(i,{key:l.id,label:l.name,value:l.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(P,{label:"状态"},{default:a(()=>[t(Pe,{modelValue:s.status,"onUpdate:modelValue":e[9]||(e[9]=l=>s.status=l)},{default:a(()=>[t(Y,{label:"Draft"},{default:a(()=>e[29]||(e[29]=[n("草稿")])),_:1,__:[29]}),t(Y,{label:"Published"},{default:a(()=>e[30]||(e[30]=[n("已发布")])),_:1,__:[30]}),t(Y,{label:"Archived"},{default:a(()=>e[31]||(e[31]=[n("已归档")])),_:1,__:[31]})]),_:1},8,["modelValue"])]),_:1}),t(P,{label:"选项"},{default:a(()=>[t(J,{modelValue:s.is_pinned,"onUpdate:modelValue":e[10]||(e[10]=l=>s.is_pinned=l)},{default:a(()=>e[32]||(e[32]=[n("置顶")])),_:1,__:[32]},8,["modelValue"]),t(J,{modelValue:s.is_featured,"onUpdate:modelValue":e[11]||(e[11]=l=>s.is_featured=l)},{default:a(()=>e[33]||(e[33]=[n("精选")])),_:1,__:[33]},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),ct=Ne(lt,[["__scopeId","data-v-6fed0bb8"]]);export{ct as default};
