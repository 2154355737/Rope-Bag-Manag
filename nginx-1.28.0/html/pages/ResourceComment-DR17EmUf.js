import{x as oe,c as E,ay as ne,r as g,X as ae,j as se,y as c,A as n,Q as a,I as r,M as u,al as v,u as I,P as A,O as p,K as h,a6 as le,H as w,ax as re,z as s}from"../chunks/vue-vendor-BleHOoLr.js";import{S as ie,A as ce,T as ue,U as de,V as me,K as l,E as _e}from"../chunks/element-plus-Cc1YNc_4.js";import{g as R,u as pe,_ as ve}from"../assets/index-B_N-aWSj.js";import{p as fe}from"../chunks/packages-DTwnlaPG.js";import{c as S}from"../chunks/comments-CGKKo5_6.js";import"../chunks/utils-Dq7h7Pqt.js";const ge={class:"comments-container"},ye={class:"header"},ke={key:0,class:"loading"},Ce={key:1,class:"not-found"},he={class:"resource-info"},we={class:"meta"},ze={class:"author"},be={class:"date"},Ie={class:"comments-section"},xe={key:0,class:"no-comments"},Se={key:1,class:"comment-list"},Pe={class:"comment-header"},Ve={class:"comment-author"},Be={class:"comment-time"},Ae={class:"comment-content"},Te={class:"comment-actions"},Ne={key:2,class:"pagination"},De={class:"comment-form"},Ee={class:"form-actions"},Re=oe({__name:"ResourceComment",setup(Ue){const U=ne(),T=re(),f=E(()=>Number(U.params.id)||0),P=g(!0),i=g(null),y=g([]),k=g(0),z=g(1),x=g(10),V=g(!1),d=ae({content:"",parentId:null}),b=E(()=>localStorage.getItem("isLoggedIn")==="true"),N=t=>new Date(t).toLocaleDateString("zh-CN"),$=()=>{T.back()},L=()=>{T.push("/home")},M=async()=>{if(f.value)try{P.value=!0;const t=await fe.getPackage(f.value);t.code===0&&t.data?i.value=t.data:(l.error(t.message||"加载资源失败"),i.value=null)}catch(t){console.error("加载资源出错:",t),l.error("加载资源时发生错误"),i.value=null}finally{P.value=!1}},C=async()=>{if(f.value)try{const t=await S.getPackageComments(f.value,{page:z.value,size:x.value});t.code===0&&t.data?(y.value=t.data.list||[],k.value=t.data.total||0):(console.warn("加载评论返回错误:",t.message),y.value=[],k.value=0)}catch(t){console.error("加载评论出错:",t),y.value=[],k.value=0}},j=t=>i.value?t.username===i.value.author:!1,F=t=>{if(!b.value)return!1;const e=R();return!e||!i.value?!1:e.role==="Admin"||e.role==="Elder"||e.username===i.value.author},H=async t=>{try{const e=await S.pinComment(t.id,!t.pinned);e.code===0?(l.success(t.pinned?"取消置顶成功":"置顶成功"),C()):l.error(e.message||"操作失败")}catch(e){console.error("置顶失败:",e),l.error("置顶时发生错误")}},K=async()=>{if(!b.value){l.warning("请先登录后再发表评论");return}if(!d.content.trim()){l.warning("评论内容不能为空");return}if(f.value)try{V.value=!0;const t=await S.createComment({content:d.content.trim(),target_id:f.value,target_type:"package",parent_id:d.parentId??void 0});t.code===0?(l.success("评论发布成功"),pe.logComment("Package",f.value,`评论资源: ${i.value?.name||"未知资源"}`).catch(e=>console.error("记录评论行为失败:",e)),d.content="",d.parentId=null,C()):l.error(t.message||"发布评论失败")}catch(t){console.error("发布评论失败:",t),l.error("发布评论时发生错误")}finally{V.value=!1}},q=async t=>{try{if({code:0,message:"点赞成功"}.code===0){l.success("点赞成功");const m=y.value.find(_=>_.id===t);m&&(m.likes=(m.likes||0)+1)}}catch(e){console.error("点赞失败:",e),l.error("点赞时发生错误")}},O=t=>{d.parentId=t,setTimeout(()=>{document.querySelector(".comment-form")?.scrollIntoView({behavior:"smooth"})},100)},Q=async t=>{try{await _e.confirm("确定要删除此评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await S.deleteComment(t);e.code===0?(l.success("删除成功"),C()):l.error(e.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除评论失败:",e),l.error("删除评论时发生错误"))}},X=t=>{if(!b.value)return!1;const e=R();return e?e.role==="admin"||e.role==="moderator"?!0:t.user_id===e.id:!1},G=t=>{x.value=t,z.value=1,C()},J=t=>{z.value=t,C()};return se(async()=>{await Promise.all([M(),C()])}),(t,e)=>{const m=v("el-icon"),_=v("el-button"),W=v("el-skeleton"),Y=v("el-empty"),D=v("el-tag"),Z=v("el-pagination"),ee=v("el-alert"),te=v("el-input");return s(),c("div",ge,[n("div",ye,[a(_,{class:"back-btn",onClick:$,type:"default",plain:""},{default:r(()=>[a(m,null,{default:r(()=>[a(I(ie))]),_:1}),e[3]||(e[3]=u(" 返回资源 "))]),_:1,__:[3]}),e[4]||(e[4]=n("h1",{class:"title"},"资源评论",-1))]),P.value?(s(),c("div",ke,[a(W,{rows:10,animated:""})])):i.value?(s(),c(A,{key:2},[n("div",he,[n("h2",null,p(i.value.name),1),n("div",we,[n("span",ze,"作者: "+p(i.value.author),1),n("span",be,"发布时间: "+p(N(i.value.created_at)),1)])]),n("div",Ie,[n("h3",null,"评论 ("+p(k.value)+")",1),y.value.length===0?(s(),c("div",xe,e[6]||(e[6]=[n("p",null,"暂无评论，来发表第一条评论吧！",-1)]))):(s(),c("div",Se,[(s(!0),c(A,null,le(y.value,o=>(s(),c("div",{key:o.id,class:"comment-item"},[n("div",Pe,[n("div",Ve,[u(p(o.author_name||"匿名用户")+" ",1),j(o)?(s(),w(D,{key:0,type:"warning",size:"small",class:"ml-1"},{default:r(()=>e[7]||(e[7]=[u("作者")])),_:1,__:[7]})):h("",!0),o.pinned?(s(),w(D,{key:1,type:"primary",size:"small",class:"ml-1"},{default:r(()=>e[8]||(e[8]=[u("置顶")])),_:1,__:[8]})):h("",!0)]),n("div",Be,p(N(o.created_at)),1)]),n("div",Ae,p(o.content),1),n("div",Te,[a(_,{link:"",size:"small",onClick:B=>q(o.id)},{default:r(()=>[a(m,null,{default:r(()=>[a(I(ce))]),_:1}),u(" 点赞 ("+p(o.likes||0)+") ",1)]),_:2},1032,["onClick"]),b.value?(s(),w(_,{key:0,link:"",size:"small",onClick:B=>O(o.id)},{default:r(()=>[a(m,null,{default:r(()=>[a(I(ue))]),_:1}),e[9]||(e[9]=u(" 回复 "))]),_:2,__:[9]},1032,["onClick"])):h("",!0),X(o)?(s(),w(_,{key:1,link:"",size:"small",onClick:B=>Q(o.id)},{default:r(()=>[a(m,null,{default:r(()=>[a(I(de))]),_:1}),e[10]||(e[10]=u(" 删除 "))]),_:2,__:[10]},1032,["onClick"])):h("",!0),F()?(s(),w(_,{key:2,link:"",size:"small",onClick:B=>H(o)},{default:r(()=>[a(m,null,{default:r(()=>[a(I(me))]),_:1}),u(" "+p(o.pinned?"取消置顶":"置顶"),1)]),_:2},1032,["onClick"])):h("",!0)])]))),128))])),k.value>0?(s(),c("div",Ne,[a(Z,{"current-page":z.value,"onUpdate:currentPage":e[0]||(e[0]=o=>z.value=o),"page-size":x.value,"onUpdate:pageSize":e[1]||(e[1]=o=>x.value=o),total:k.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:G,onCurrentChange:J,background:""},null,8,["current-page","page-size","total"])])):h("",!0),n("div",De,[e[12]||(e[12]=n("h3",null,"发表评论",-1)),b.value?(s(),c(A,{key:1},[a(te,{modelValue:d.content,"onUpdate:modelValue":e[2]||(e[2]=o=>d.content=o),type:"textarea",rows:4,placeholder:"请输入您的评论",maxlength:500,"show-word-limit":""},null,8,["modelValue"]),n("div",Ee,[a(_,{type:"primary",onClick:K,loading:V.value,disabled:!d.content},{default:r(()=>e[11]||(e[11]=[u(" 提交评论 ")])),_:1,__:[11]},8,["loading","disabled"])])],64)):(s(),w(ee,{key:0,title:"请先登录后再发表评论",type:"warning",closable:!1,"show-icon":""}))])])],64)):(s(),c("div",Ce,[a(Y,{description:"资源不存在或已被删除"}),a(_,{type:"primary",onClick:L},{default:r(()=>e[5]||(e[5]=[u("返回首页")])),_:1,__:[5]})]))])}}}),Ke=ve(Re,[["__scopeId","data-v-f7148c57"]]);export{Ke as default};
