import{u as Y,a2 as Z,z as ee,K as d}from"../chunks/element-plus-Cc1YNc_4.js";import{m as ae,_ as se}from"../assets/index-B_N-aWSj.js";import{u as N}from"../chunks/users-C4D58Onb.js";import{c as le}from"../chunks/categories-BGQr79qD.js";import{s as P}from"../chunks/subscriptions-rsW08wEa.js";import{x as oe,r as _,X as Q,j as te,y as w,Q as l,I as o,J as F,ar as re,A as s,H as D,al as n,u as A,O as p,M as g,z as m}from"../chunks/vue-vendor-BleHOoLr.js";import"../chunks/utils-Dq7h7Pqt.js";const ne={class:"user-profile"},ie={class:"card-header"},de={class:"profile-display"},ue={class:"profile-info"},ce={class:"avatar-section"},_e=["src"],me={class:"info-section"},pe={class:"info-item"},fe={class:"value"},ve={class:"info-item"},ge={class:"value"},be={class:"info-item"},ye={class:"value"},he={class:"info-item"},we={class:"value highlight"},ke={class:"info-item"},qe={class:"value"},Ve={class:"card-header"},Ue={class:"subscription-content"},Ce={class:"avatar-upload-section"},xe=["src"],ze={key:1,class:"avatar-uploader-icon"},Ee={class:"avatar-input"},Qe={class:"dialog-footer"},De=oe({__name:"UserProfile",setup(Ae){const k=_(null),q=_(!1),V=_(!1),U=_(!1),f=_(!1),u=_({}),b=_([]),c=Q({}),C=Q({}),r=Q({nickname:"",qq_number:"",avatar_url:""}),$={nickname:[{required:!0,message:"请输入昵称",trigger:"blur"},{min:2,max:20,message:"昵称长度在 2 到 20 个字符之间",trigger:"blur"}],qq_number:[{pattern:/^\d{5,12}$/,message:"请输入5-12位数字的QQ号",trigger:"blur"}]},L=async()=>{q.value=!0;try{const a=await N.getCurrentUser();a.code===0&&a.data&&(u.value=a.data,r.nickname=a.data.nickname||"",r.qq_number=a.data.qq_number||"",r.avatar_url=a.data.avatar_url||"")}catch(a){console.error("加载用户信息失败:",a),d.error("加载用户信息失败")}finally{q.value=!1}},B=async()=>{V.value=!0;try{const a=await le.getCategories();a.code===0&&(b.value=a.data?.list||[],await j())}catch(a){console.error("加载分类列表失败:",a),d.error("加载分类列表失败")}finally{V.value=!1}},j=async()=>{try{const a=await P.getUserSubscriptions();a.code===0&&a.data&&(Object.assign(c,a.data),b.value.forEach(e=>{c[e.id]===void 0&&(c[e.id]=!1)}))}catch(a){console.error("加载用户订阅状态失败:",a),b.value.forEach(e=>{c[e.id]===void 0&&(c[e.id]=!1)})}},O=async(a,e)=>{C[a]=!0;try{const i=await P.setSubscription({category_id:a,enabled:e});i.code===0?d.success(e?"已订阅":"已取消订阅"):(d.error(i.message||"操作失败"),c[a]=!e)}catch(i){console.error("切换订阅状态失败:",i),d.error("操作失败"),c[a]=!e}finally{C[a]=!1}},T=a=>{const e=a.type.startsWith("image/"),i=a.size/1024/1024<2;if(!e)return d.error("只能上传图片文件!"),!1;if(!i)return d.error("图片大小不能超过 2MB!"),!1;const v=new FileReader;return v.onload=y=>{r.avatar_url=y.target?.result},v.readAsDataURL(a),!1},M=a=>{console.warn("头像加载失败:",a);const e=a.target;e&&e.src.includes("q.qlogo.cn")&&(e.style.display="none")},H=async()=>{if(k.value)try{await k.value.validate(),U.value=!0;const a=await N.updateCurrentUser(r);a.code===0?(d.success("保存成功"),f.value=!1,await L(),await ae()):d.error(a.message||a.msg||"保存失败")}catch(a){console.error("保存个人信息失败:",a),d.error("保存失败")}finally{U.value=!1}},J=a=>a?new Date(a).toLocaleDateString("zh-CN"):"未知";return te(()=>{L(),B()}),(a,e)=>{const i=n("el-button"),v=n("el-avatar"),y=n("el-icon"),R=n("el-card"),h=n("el-table-column"),K=n("el-tag"),W=n("el-switch"),X=n("el-table"),x=n("el-input"),z=n("el-form-item"),G=n("el-upload"),I=n("el-dialog"),S=re("loading");return m(),w("div",ne,[l(R,{shadow:"hover",class:"profile-card"},{header:o(()=>[s("div",ie,[e[7]||(e[7]=s("h3",null,"个人信息",-1)),l(i,{type:"primary",size:"small",onClick:e[0]||(e[0]=t=>f.value=!0)},{default:o(()=>e[6]||(e[6]=[g("编辑信息")])),_:1,__:[6]})])]),default:o(()=>[F((m(),w("div",de,[s("div",ue,[s("div",ce,[u.value.avatar_url?(m(),D(v,{key:0,size:80,src:u.value.avatar_url},{default:o(()=>[s("img",{src:u.value.avatar_url,onError:M},null,40,_e)]),_:1},8,["src"])):(m(),D(v,{key:1,size:80},{default:o(()=>[l(y,null,{default:o(()=>[l(A(Y))]),_:1})]),_:1}))]),s("div",me,[s("div",pe,[e[8]||(e[8]=s("span",{class:"label"},"用户名：",-1)),s("span",fe,p(u.value.username||"未设置"),1)]),s("div",ve,[e[9]||(e[9]=s("span",{class:"label"},"昵称：",-1)),s("span",ge,p(u.value.nickname||"未设置"),1)]),s("div",be,[e[10]||(e[10]=s("span",{class:"label"},"QQ号：",-1)),s("span",ye,p(u.value.qq_number||"未设置"),1)]),s("div",he,[e[11]||(e[11]=s("span",{class:"label"},"积分：",-1)),s("span",we,p(u.value.star||0),1)]),s("div",ke,[e[12]||(e[12]=s("span",{class:"label"},"注册时间：",-1)),s("span",qe,p(J(u.value.created_at)),1)])])])])),[[S,q.value]])]),_:1}),l(R,{shadow:"hover",class:"subscription-card"},{header:o(()=>[s("div",Ve,[e[14]||(e[14]=s("h3",null,"资源订阅",-1)),l(i,{link:"",size:"small",onClick:B},{default:o(()=>e[13]||(e[13]=[g("刷新")])),_:1,__:[13]})])]),default:o(()=>[s("div",Ue,[e[15]||(e[15]=s("p",{class:"subscription-desc"},"订阅您感兴趣的资源分类，我们会在有新资源时通知您。",-1)),F((m(),D(X,{data:b.value,style:{width:"100%"}},{default:o(()=>[l(h,{prop:"name",label:"分类名称"}),l(h,{prop:"description",label:"分类描述","show-overflow-tooltip":""}),l(h,{label:"资源数量",width:"100"},{default:o(({row:t})=>[l(K,{size:"small"},{default:o(()=>[g(p(t.count||0),1)]),_:2},1024)]),_:1}),l(h,{label:"订阅状态",width:"100"},{default:o(({row:t})=>[l(W,{modelValue:c[t.id],"onUpdate:modelValue":E=>c[t.id]=E,onChange:E=>O(t.id,E),loading:C[t.id]},null,8,["modelValue","onUpdate:modelValue","onChange","loading"])]),_:1})]),_:1},8,["data"])),[[S,V.value]])])]),_:1}),l(I,{modelValue:f.value,"onUpdate:modelValue":e[5]||(e[5]=t=>f.value=t),title:"编辑个人信息",width:"500px"},{footer:o(()=>[s("div",Qe,[l(i,{onClick:e[4]||(e[4]=t=>f.value=!1)},{default:o(()=>e[17]||(e[17]=[g("取消")])),_:1,__:[17]}),l(i,{type:"primary",onClick:H,loading:U.value},{default:o(()=>e[18]||(e[18]=[g("保存")])),_:1,__:[18]},8,["loading"])])]),default:o(()=>[l(A(Z),{model:r,rules:$,ref_key:"formRef",ref:k,"label-width":"90px"},{default:o(()=>[l(z,{label:"昵称",prop:"nickname"},{default:o(()=>[l(x,{modelValue:r.nickname,"onUpdate:modelValue":e[1]||(e[1]=t=>r.nickname=t),placeholder:"请输入昵称"},null,8,["modelValue"])]),_:1}),l(z,{label:"QQ号",prop:"qq_number"},{default:o(()=>[l(x,{modelValue:r.qq_number,"onUpdate:modelValue":e[2]||(e[2]=t=>r.qq_number=t),placeholder:"请输入QQ号"},null,8,["modelValue"])]),_:1}),l(z,{label:"头像",prop:"avatar_url"},{default:o(()=>[s("div",Ce,[l(G,{class:"avatar-uploader",action:"","show-file-list":!1,"before-upload":T,accept:"image/*"},{default:o(()=>[r.avatar_url?(m(),w("img",{key:0,src:r.avatar_url,class:"avatar-preview",onError:M},null,40,xe)):(m(),w("div",ze,[l(y,null,{default:o(()=>[l(A(ee))]),_:1}),e[16]||(e[16]=s("span",null,"上传头像",-1))]))]),_:1}),s("div",Ee,[l(x,{modelValue:r.avatar_url,"onUpdate:modelValue":e[3]||(e[3]=t=>r.avatar_url=t),placeholder:"或粘贴头像图片URL",clearable:""},null,8,["modelValue"])])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Fe=se(De,[["__scopeId","data-v-f2d0a758"]]);export{Fe as default};
