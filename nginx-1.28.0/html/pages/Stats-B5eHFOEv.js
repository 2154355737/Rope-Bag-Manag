import{k as Ct,u as _t,M as O,b as pt,f as ht,Y as Lt,m as At,t as Tt,L as $t,Z as zt,U as It,H as Rt}from"../chunks/element-plus-hGoKm610.js";import{f as mt,j as Ut,_ as Pt}from"../assets/index-C28i2SJl.js";import{u as Ot}from"../chunks/users-D39iNwN1.js";import{c as Ft}from"../chunks/categories-BRHoYYyG.js";import{a as gt}from"../chunks/admin-BTTWAptb.js";import{i as yt,L as wt}from"../chunks/echarts-Bn9PLWWT.js";import{x as Et,r as u,c as Nt,j as Yt,S as jt,y as tt,A as t,Q as n,I as p,u as k,al as Dt,O as w,M as F,C as E,P as Bt,a6 as Vt,D as Gt,H as Ht,L as Kt,z as N}from"../chunks/vue-vendor-BleHOoLr.js";import"../chunks/utils-Dq7h7Pqt.js";const Qt={class:"stats-desktop"},Wt={class:"page-header"},Zt={class:"header-content"},qt={class:"header-left"},Jt={class:"header-icon"},Xt={class:"header-actions"},te={class:"time-display"},ee={class:"current-time"},se={class:"current-date"},ae={class:"stats-section"},oe={class:"stats-grid"},ne={class:"stat-card primary"},le={class:"stat-icon"},ie={class:"stat-content"},re={class:"stat-number"},de={class:"stat-trend positive"},ce={class:"stat-card success"},ue={class:"stat-icon"},ve={class:"stat-content"},fe={class:"stat-number"},_e={class:"stat-trend positive"},pe={class:"stat-card warning"},he={class:"stat-icon"},me={class:"stat-content"},ge={class:"stat-number"},ye={class:"stat-trend positive"},we={class:"stat-card info"},De={class:"stat-icon"},Se={class:"stat-content"},be={class:"stat-number"},Me={class:"stat-trend positive"},xe={class:"charts-section"},ke={class:"chart-row"},Ce={class:"chart-card"},Le={class:"chart-header"},Ae={class:"chart-actions"},Te={class:"chart-card"},$e={class:"status-activity-section"},ze={class:"status-section"},Ie={class:"status-grid"},Re={class:"status-item"},Ue={class:"status-value"},Pe={class:"status-bar"},Oe={class:"status-item"},Fe={class:"status-value"},Ee={class:"status-bar"},Ne={class:"status-item"},Ye={class:"status-value"},je={class:"status-bar"},Be={class:"status-item"},Ve={class:"status-value"},Ge={class:"status-bar"},He={class:"activity-section"},Ke={class:"section-header"},Qe={class:"activity-list"},We={class:"activity-content"},Ze={class:"activity-text"},qe={class:"activity-time"},Je=Et({__name:"Stats",setup(Xe){const et=u(""),st=u(""),m=u("7d"),h=u(0),z=u(0),Y=u(0),j=u(0),B=u(0),at=u(0),ot=u(0),V=u(null),G=u(null);let A=null,T=null;const H=u({"7d":{dates:[],counts:[]},"30d":{dates:[],counts:[]},"90d":{dates:[],counts:[]}}),U=u({绳索:0,装备:0,工具:0,教程:0}),b=u({cpu:45,memory:65,disk:32,network:75});Nt(()=>h.value===0?0:Math.round(B.value/h.value*100));let K=null,Q=null,W=null;function nt(){const s=new Date;et.value=s.toLocaleTimeString(),st.value=s.toLocaleDateString()}function Z(s){m.value=s,P()}function P(){if(!V.value)return;A&&A.dispose(),A=yt(V.value);const s=H.value[m.value],e={dates:s.dates||[],counts:s.counts||[]},a=e.counts.map(r=>{const v=Number(r);return isNaN(v)?0:Math.max(0,v)}),l={backgroundColor:"transparent",tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:function(r){const v=r[0].dataIndex,D=e.dates[v],I=a[v];return`${D}: ${I} 用户`}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:e.dates,axisLine:{lineStyle:{color:"#ccc"}},axisLabel:{color:"#666"}},yAxis:{type:"value",min:0,minInterval:1,axisLine:{lineStyle:{color:"#ccc"}},axisLabel:{color:"#666",formatter:"{value}"},splitLine:{lineStyle:{color:"rgba(220, 220, 220, 0.2)"}}},series:[{name:"用户数",type:"line",stack:"Total",data:a,areaStyle:{color:new wt(0,0,0,1,[{offset:0,color:"rgba(64, 158, 255, 0.7)"},{offset:1,color:"rgba(64, 158, 255, 0.1)"}])},lineStyle:{color:"#409EFF"},itemStyle:{color:"#409EFF"},symbol:"circle",symbolSize:8}]};A.setOption(l),window.addEventListener("resize",()=>{A?.resize()})}function q(){if(!G.value)return;T&&T.dispose(),T=yt(G.value);const s=Object.keys(U.value),e=Object.values(U.value),a={backgroundColor:"transparent",tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:s,axisLine:{lineStyle:{color:"#ccc"}},axisLabel:{color:"#666"}},yAxis:{type:"value",axisLine:{lineStyle:{color:"#ccc"}},axisLabel:{color:"#666"},splitLine:{lineStyle:{color:"rgba(220, 220, 220, 0.2)"}}},series:[{name:"下载量",type:"bar",data:e,itemStyle:{color:new wt(0,0,0,1,[{offset:0,color:"rgba(64, 158, 255, 1)"},{offset:1,color:"rgba(64, 158, 255, 0.5)"}])},barWidth:"40%"}]};T.setOption(a),window.addEventListener("resize",()=>{T?.resize()})}async function St(){await X(),Rt.success("已刷新活动数据")}function bt(s){switch(s){case"register":return _t;case"upload":return It;case"edit":return zt;case"delete":return $t;case"rate":return Tt;case"download":return ht;case"comment":return At;default:return pt}}function Mt(s){const e=new Date(s),l=(new Date().getTime()-e.getTime())/1e3;return l<60?"刚刚":l<3600?Math.floor(l/60)+"分钟前":l<86400?Math.floor(l/3600)+"小时前":`${e.getFullYear()}/${e.getMonth()+1}/${e.getDate()} ${e.getHours()}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`}async function lt(){try{const s=new Date;let e;m.value==="7d"?(e=new Date(s),e.setDate(s.getDate()-6)):m.value==="30d"?(e=new Date(s),e.setDate(s.getDate()-29)):(e=new Date(s),e.setDate(s.getDate()-89));const a=o=>`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`,l=a(e),r=a(s),v=mt.getActionStats({start_time:l,end_time:r}),D=Ot.getUsers({pageSize:1e3}),I=gt.getStats(),[g,y,S]=await Promise.all([v.catch(o=>({code:-1,data:null})),D.catch(o=>({code:-1,data:{list:[]}})),I.catch(o=>({code:-1,data:null}))]);let i=0;S.code===0&&S.data&&(i=S.data.total_users||0,h.value=i),i===0&&y.code===0&&y.data&&(i=y.data.list?.length||0,i>0&&(h.value=i));const $=[],f=[],d=[];let M=new Date(e);for(;M<=s;){const o=a(M),c=`${M.getMonth()+1}/${M.getDate()}`;f.push(o),d.push(c),M.setDate(M.getDate()+1)}const R=new Array(f.length).fill(0);if(y.code===0&&y.data&&y.data.list&&y.data.list.forEach(c=>{if(c.created_at){const x=c.created_at.substring(0,10),ft=f.indexOf(x);ft>=0&&R[ft]++}}),R.every(o=>o===0)&&g.code===0&&g.data&&g.data.by_day&&g.data.by_day.length>0){const o=new Map;g.data.by_day.forEach(c=>{const x=c.date.substring(0,10);o.set(x,c.count)});for(let c=0;c<f.length;c++){const x=o.get(f[c]);x!==void 0&&x>0&&(R[c]=x)}}const ut=R.reduce((o,c)=>o+c,0),kt=Math.max(1,h.value-ut),_=[];let vt=kt;if(ut===0&&h.value>1){const o=(h.value-1)/f.length;for(let c=0;c<f.length;c++){const x=Math.floor(1+o*(c+1));_.push(x)}_.length>0&&(_[_.length-1]=h.value)}else for(const o of R)vt+=o,_.push(vt);let C=[],L=[];if(m.value==="7d")C=[...d],L=[..._];else if(m.value==="30d"){C=[d[0]],L=[_[0]];for(let o=3;o<d.length-3;o+=3)C.push(d[o]),L.push(_[o]);C.push(d[d.length-1]),L.push(_[_.length-1])}else if(m.value==="90d"){C=[d[0]],L=[_[0]];for(let o=7;o<d.length-7;o+=7)C.push(d[o]),L.push(_[o]);C.push(d[d.length-1]),L.push(_[_.length-1])}H.value[m.value]={dates:C,counts:L},P()}catch(s){console.error("加载用户趋势数据失败",s);const e=[],a=[],l=1,r=Math.max(1,Math.floor((h.value-l)/6));for(let v=0;v<=6;v++){const D=new Date;D.setDate(D.getDate()-(6-v)),e.push(`${D.getMonth()+1}/${D.getDate()}`),a.push(l+r*v)}a.length>0&&(a[a.length-1]=h.value),H.value[m.value]={dates:e,counts:a},P()}}async function it(){try{const s=new Date,e=new Date(s.getFullYear(),s.getMonth(),1),a=new Date(s.getFullYear(),s.getMonth()+1,0),l=i=>`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`,r=l(e),v=l(a),D=Ut.getResourceActionStats({resource_type:"Package",start_date:r,end_date:v}),I=Ft.getCategories(),[g,y]=await Promise.all([D,I]),S={};if(y.code===0&&y.data&&y.data.list){const i=y.data.list.slice(0,4);for(const $ of i)if(g.code===0&&g.data){const f=g.data.download_count,d=Math.random()*.5+.5;S[$.name]=Math.floor(f*d/i.length)}else S[$.name]=Math.floor(Math.random()*1e3)+500}else{const i=["绳索","装备","工具","教程"];if(g.code===0&&g.data){let f=g.data.download_count;for(let d=0;d<i.length-1;d++){const M=Math.floor(f*(Math.random()*.4+.1));S[i[d]]=M,f-=M}S[i[i.length-1]]=f>0?f:0}else for(const $ of i)S[$]=Math.floor(Math.random()*1e3)+500}U.value=S,q()}catch(s){console.error("加载下载统计数据失败",s),U.value={绳索:1250,装备:890,工具:567,教程:1023},q()}}async function rt(){try{const s=await gt.getStats();if(s.code===0&&s.data){const e=s.data;h.value=e.total_users||0,z.value=e.total_packages||0,B.value=e.active_users||0,at.value=e.new_users_today||0,ot.value=e.new_packages_today||0,Y.value=e.total_comments||Math.floor(z.value*5.2),j.value=Math.floor(z.value*12.6),await lt(),await it()}}catch(s){console.error("加载统计数据失败",s),h.value=256,z.value=148,B.value=103,at.value=12,ot.value=8,Y.value=3720,j.value=8540,await lt(),await it()}}const J=u([]);function xt(s){switch(s){case"Login":return"login";case"Register":return"register";case"Upload":return"upload";case"Download":return"download";case"Comment":return"comment";case"Edit":return"edit";case"Delete":return"delete";case"Rate":return"rate";default:return s.toLowerCase()}}async function X(){try{const s=await mt.getUserActions({page:1,page_size:5});if(s.code===0&&s.data&&s.data.actions){const e=s.data.actions.map(a=>({id:a.id,type:xt(a.action_type),text:a.details||`${a.action_type} 操作`,time:a.created_at}));J.value=e}else dt()}catch(s){console.error("加载最近活动失败",s),dt()}}function dt(){const s=[{id:1,type:"register",text:"新用户 张三 注册了账号",time:new Date(Date.now()-3e5).toISOString()},{id:2,type:"upload",text:'李四 上传了新绳包 "高强度登山绳"',time:new Date(Date.now()-9e5).toISOString()},{id:3,type:"edit",text:'王五 编辑了绳包 "安全防护绳"',time:new Date(Date.now()-21e5).toISOString()},{id:4,type:"delete",text:"管理员删除了违规评论",time:new Date(Date.now()-72e5).toISOString()},{id:5,type:"rate",text:'赵六 评价了绳包 "攀岩专用绳"',time:new Date(Date.now()-108e5).toISOString()}];J.value=s}function ct(){b.value={cpu:Math.floor(Math.random()*20+35),memory:Math.floor(Math.random()*20+55),disk:Math.floor(Math.random()*10+28),network:Math.floor(Math.random()*30+60)}}return Yt(()=>{nt(),K=window.setInterval(nt,1e3),rt(),ct(),X(),setTimeout(()=>{P(),q()},100),Q=window.setInterval(()=>{rt(),ct()},6e4),W=window.setInterval(()=>{X()},3e4)}),jt(()=>{K!==null&&clearInterval(K),Q!==null&&clearInterval(Q),W!==null&&clearInterval(W),A&&A.dispose(),T&&T.dispose()}),(s,e)=>{const a=Dt("el-icon"),l=Dt("el-button");return N(),tt("div",Qt,[t("div",Wt,[t("div",Zt,[t("div",qt,[t("div",Jt,[n(a,{size:32},{default:p(()=>[n(k(Ct))]),_:1})]),e[3]||(e[3]=t("div",{class:"header-info"},[t("h1",{class:"page-title"},"统计信息"),t("p",{class:"page-subtitle"},"系统运行数据概览")],-1))]),t("div",Xt,[t("div",te,[t("span",ee,w(et.value),1),t("span",se,w(st.value),1)])])])]),t("div",ae,[t("div",oe,[t("div",ne,[t("div",le,[n(a,{size:24},{default:p(()=>[n(k(_t))]),_:1})]),t("div",ie,[t("div",re,w(h.value),1),e[5]||(e[5]=t("div",{class:"stat-label"},"总用户数",-1)),t("div",de,[n(a,null,{default:p(()=>[n(k(O))]),_:1}),e[4]||(e[4]=t("span",null,"+12.5%",-1))])])]),t("div",ce,[t("div",ue,[n(a,{size:24},{default:p(()=>[n(k(pt))]),_:1})]),t("div",ve,[t("div",fe,w(z.value),1),e[7]||(e[7]=t("div",{class:"stat-label"},"总绳包数",-1)),t("div",_e,[n(a,null,{default:p(()=>[n(k(O))]),_:1}),e[6]||(e[6]=t("span",null,"+8.3%",-1))])])]),t("div",pe,[t("div",he,[n(a,{size:24},{default:p(()=>[n(k(ht))]),_:1})]),t("div",me,[t("div",ge,w(Y.value),1),e[9]||(e[9]=t("div",{class:"stat-label"},"总下载量",-1)),t("div",ye,[n(a,null,{default:p(()=>[n(k(O))]),_:1}),e[8]||(e[8]=t("span",null,"+15.7%",-1))])])]),t("div",we,[t("div",De,[n(a,{size:24},{default:p(()=>[n(k(Lt))]),_:1})]),t("div",Se,[t("div",be,w(j.value),1),e[11]||(e[11]=t("div",{class:"stat-label"},"总浏览量",-1)),t("div",Me,[n(a,null,{default:p(()=>[n(k(O))]),_:1}),e[10]||(e[10]=t("span",null,"+22.1%",-1))])])])])]),t("div",xe,[t("div",ke,[t("div",Ce,[t("div",Le,[e[15]||(e[15]=t("h3",{class:"chart-title"},"用户增长趋势",-1)),t("div",Ae,[n(l,{size:"small",type:m.value==="7d"?"primary":"default",onClick:e[0]||(e[0]=r=>Z("7d"))},{default:p(()=>e[12]||(e[12]=[F("7天")])),_:1,__:[12]},8,["type"]),n(l,{size:"small",type:m.value==="30d"?"primary":"default",onClick:e[1]||(e[1]=r=>Z("30d"))},{default:p(()=>e[13]||(e[13]=[F("30天")])),_:1,__:[13]},8,["type"]),n(l,{size:"small",type:m.value==="90d"?"primary":"default",onClick:e[2]||(e[2]=r=>Z("90d"))},{default:p(()=>e[14]||(e[14]=[F("90天")])),_:1,__:[14]},8,["type"])])]),t("div",{ref_key:"userTrendChartRef",ref:V,class:"chart-container",style:{height:"300px"}},null,512)]),t("div",Te,[e[16]||(e[16]=t("div",{class:"chart-header"},[t("h3",{class:"chart-title"},"下载量统计"),t("div",{class:"chart-period"},"本月")],-1)),t("div",{ref_key:"downloadChartRef",ref:G,class:"chart-container",style:{height:"300px"}},null,512)])])]),t("div",$e,[t("div",ze,[e[21]||(e[21]=t("div",{class:"section-header"},[t("h3",{class:"section-title"},"系统状态"),t("div",{class:"status-indicator online"},[t("div",{class:"status-dot"}),t("span",null,"在线")])],-1)),t("div",Ie,[t("div",Re,[e[17]||(e[17]=t("div",{class:"status-label"},"CPU使用率",-1)),t("div",Ue,w(b.value.cpu)+"%",1),t("div",Pe,[t("div",{class:"status-progress",style:E({width:b.value.cpu+"%"})},null,4)])]),t("div",Oe,[e[18]||(e[18]=t("div",{class:"status-label"},"内存使用率",-1)),t("div",Fe,w(b.value.memory)+"%",1),t("div",Ee,[t("div",{class:"status-progress",style:E({width:b.value.memory+"%"})},null,4)])]),t("div",Ne,[e[19]||(e[19]=t("div",{class:"status-label"},"磁盘使用率",-1)),t("div",Ye,w(b.value.disk)+"%",1),t("div",je,[t("div",{class:"status-progress",style:E({width:b.value.disk+"%"})},null,4)])]),t("div",Be,[e[20]||(e[20]=t("div",{class:"status-label"},"网络状态",-1)),t("div",Ve,w(b.value.network)+"Mbps",1),t("div",Ge,[t("div",{class:"status-progress",style:E({width:b.value.network/100+"%"})},null,4)])])])]),t("div",He,[t("div",Ke,[e[23]||(e[23]=t("h3",{class:"section-title"},"实时活动",-1)),n(l,{size:"small",type:"primary",onClick:St},{default:p(()=>e[22]||(e[22]=[F("刷新")])),_:1,__:[22]})]),t("div",Qe,[(N(!0),tt(Bt,null,Vt(J.value,r=>(N(),tt("div",{key:r.id,class:"activity-item"},[t("div",{class:Gt(["activity-icon",r.type])},[n(a,{size:16},{default:p(()=>[(N(),Ht(Kt(bt(r.type))))]),_:2},1024)],2),t("div",We,[t("div",Ze,w(r.text),1),t("div",qe,w(Mt(r.time)),1)])]))),128))])])])])}}}),rs=Pt(Je,[["__scopeId","data-v-d925dbe7"]]);export{rs as default};
