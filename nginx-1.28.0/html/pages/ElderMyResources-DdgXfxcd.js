import{x as De,r as g,X as S,c as E,j as Pe,y as k,A as s,Q as t,I as l,M as i,al as r,u as w,O as f,a4 as $e,J as Fe,ar as Me,K as ee,P as Q,a6 as X,D as Se,H as A,z as c}from"../chunks/vue-vendor-BleHOoLr.js";import{l as Ee,a6 as Ae,T as te,f as le,P as G,ag as je,t as Ie,a3 as Ye,H as _,E as Be}from"../chunks/element-plus-hGoKm610.js";import{p as j}from"../chunks/packages-B3dEIScr.js";import{g as Te,_ as Le}from"../assets/index-D3Kp6etV.js";import{c as Ne}from"../chunks/categories-Cxelk8WM.js";import"../chunks/utils-Dq7h7Pqt.js";const qe={class:"elder-my-resources-page"},Ke={class:"page-header"},He={class:"header-content"},Oe={class:"header-actions"},Je={class:"stat-content"},Qe={class:"stat-icon"},Xe={class:"stat-info"},Ge={class:"stat-number"},We={class:"stat-content"},Ze={class:"stat-icon"},et={class:"stat-info"},tt={class:"stat-number"},lt={class:"stat-content"},at={class:"stat-icon"},ot={class:"stat-info"},st={class:"stat-number"},nt={class:"stat-content"},dt={class:"stat-icon"},it={class:"stat-info"},rt={class:"stat-number"},ut={key:0,class:"empty-state"},pt={key:1,class:"resource-grid"},ct={class:"resource-header"},_t=["onClick"],mt={class:"resource-info"},ft={class:"info-item"},vt={class:"value"},gt={class:"info-item"},wt={key:0,class:"info-item"},yt={class:"rejection-reason"},bt={class:"resource-description"},kt={class:"resource-stats"},Vt={class:"stat-item"},ht={class:"stat-item"},Ct={class:"stat-item"},Rt={class:"resource-actions"},Ut={key:2,class:"pagination-wrapper"},xt={class:"privilege-note"},zt={class:"dialog-footer"},Dt={class:"dialog-footer"},Pt=De({__name:"ElderMyResources",setup($t){const I=g(null),Y=g(null),F=g(!1),B=g(!1),T=g(!1),L=g(!1),U=g(!1),z=g(!1),N=Te(),C=g([]),q=g([]),K=g(null),H=g(null),R=S({page:1,pageSize:12}),p=S({status:"",search:"",start_date:"",end_date:""}),n=S({name:"",author:N?.username||"",version:"",description:"",category_id:void 0,file_url:"",skipReview:!1}),d=S({name:"",version:"",description:"",category_id:void 0,file_url:"",status:"Active"}),W={name:[{required:!0,message:"请输入资源名称",trigger:"blur"},{min:2,max:50,message:"名称长度在 2 到 50 个字符之间",trigger:"blur"}],author:[{required:!0,message:"请输入作者名称",trigger:"blur"}],description:[{max:500,message:"描述不能超过 500 个字符",trigger:"blur"}],file_url:[{required:!0,message:"请输入文件链接",trigger:"blur"},{pattern:/^https?:\/\/.+/,message:"请输入有效的URL地址",trigger:"blur"}]},O=E(()=>C.value.length),ae=E(()=>C.value.filter(o=>o.status==="Active").length),oe=E(()=>C.value.filter(o=>o.status==="Pending").length),se=E(()=>C.value.reduce((o,e)=>o+e.download_count,0)),V=async()=>{F.value=!0;try{const o={page:R.page,pageSize:R.pageSize,...p,search:p.search||N?.username},e=await j.getPackages(o);e.code===0&&(C.value=e.data?.list||[])}catch(o){console.error("加载资源列表失败:",o),_.error("加载资源列表失败")}finally{F.value=!1}},ne=async()=>{try{const o=await Ne.getCategories();o.code===0&&(q.value=o.data?.list||[])}catch(o){console.error("加载分类列表失败:",o)}},de=o=>{o&&o.length===2?(p.start_date=o[0],p.end_date=o[1]):(p.start_date="",p.end_date="")},ie=()=>{p.status="",p.search="",p.start_date="",p.end_date="",H.value=null,R.page=1,V()},re=(o,e)=>{switch(o){case"edit":J(e);break;case"view":window.open(`/resource/${e.id}`,"_blank");break;case"stats":ue();break;case"comments":pe(e);break;case"delete":fe(e);break}},ue=o=>{_.info("资源统计功能开发中...")},pe=o=>{window.open(`/resource/${o.id}/comments`,"_blank")},J=o=>{K.value=o,d.name=o.name,d.version=o.version||"",d.description=o.description||"",d.category_id=o.category_id||void 0,d.file_url=o.file_url,d.status=o.status,z.value=!0},ce=async()=>{if(!n.file_url){_.warning("请先输入文件链接");return}L.value=!0;try{await new Promise(o=>setTimeout(o,1e3)),_.success("链接验证通过")}catch{_.error("链接验证失败")}finally{L.value=!1}},_e=async()=>{if(I.value)try{await I.value.validate(),B.value=!0;const o={...n};n.skipReview&&delete o.skipReview;const e=await j.adminCreatePackage(o);e.code===0?(_.success(n.skipReview?"资源发布成功":"资源上传成功，等待审核"),U.value=!1,ve(),V()):_.error(e.message||"上传失败")}catch(o){console.error("上传资源失败:",o),_.error("上传失败")}finally{B.value=!1}},me=async()=>{if(!(!Y.value||!K.value))try{await Y.value.validate(),T.value=!0;const o=await j.updatePackage(K.value.id,d);o.code===0?(_.success("资源更新成功"),z.value=!1,V()):_.error(o.message||"更新失败")}catch(o){console.error("更新资源失败:",o),_.error("更新失败")}finally{T.value=!1}},fe=async o=>{try{await Be.confirm(`确定要删除资源 "${o.name}" 吗？此操作不可恢复。`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await j.deletePackage(o.id);e.code===0?(_.success("删除成功"),V()):_.error(e.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除资源失败:",e),_.error("删除失败"))}},ve=()=>{Object.assign(n,{name:"",author:N?.username||"",version:"",description:"",category_id:void 0,file_url:"",skipReview:!1})},ge=o=>({Active:"success",Pending:"warning",Rejected:"danger",Inactive:"info"})[o]||"info",we=o=>({Active:"已发布",Pending:"审核中",Rejected:"已拒绝",Inactive:"已下架"})[o]||o,ye=o=>new Date(o).toLocaleDateString("zh-CN");return Pe(()=>{V(),ne()}),(o,e)=>{const m=r("el-button"),h=r("el-icon"),x=r("el-card"),v=r("el-col"),D=r("el-row"),y=r("el-option"),M=r("el-select"),u=r("el-form-item"),b=r("el-input"),be=r("el-date-picker"),ke=r("el-empty"),P=r("el-dropdown-item"),Ve=r("el-dropdown-menu"),he=r("el-dropdown"),Ce=r("el-tag"),Re=r("el-tooltip"),Ue=r("el-pagination"),xe=r("el-checkbox"),Z=r("el-dialog"),ze=Me("loading");return c(),k("div",qe,[s("div",Ke,[s("div",He,[e[25]||(e[25]=s("h2",null,"我的资源",-1)),s("div",Oe,[t(m,{type:"primary",icon:"Plus",onClick:e[0]||(e[0]=a=>U.value=!0)},{default:l(()=>e[24]||(e[24]=[i(" 上传新资源 ")])),_:1,__:[24]})])])]),t(D,{gutter:20,class:"stats-row"},{default:l(()=>[t(v,{span:6},{default:l(()=>[t(x,{shadow:"hover",class:"stat-card"},{default:l(()=>[s("div",Je,[s("div",Qe,[t(h,{color:"#409EFF"},{default:l(()=>[t(w(Ee))]),_:1})]),s("div",Xe,[s("div",Ge,f(O.value),1),e[26]||(e[26]=s("div",{class:"stat-label"},"总资源数",-1))])])]),_:1})]),_:1}),t(v,{span:6},{default:l(()=>[t(x,{shadow:"hover",class:"stat-card"},{default:l(()=>[s("div",We,[s("div",Ze,[t(h,{color:"#67C23A"},{default:l(()=>[t(w(Ae))]),_:1})]),s("div",et,[s("div",tt,f(ae.value),1),e[27]||(e[27]=s("div",{class:"stat-label"},"已发布",-1))])])]),_:1})]),_:1}),t(v,{span:6},{default:l(()=>[t(x,{shadow:"hover",class:"stat-card"},{default:l(()=>[s("div",lt,[s("div",at,[t(h,{color:"#E6A23C"},{default:l(()=>[t(w(te))]),_:1})]),s("div",ot,[s("div",st,f(oe.value),1),e[28]||(e[28]=s("div",{class:"stat-label"},"审核中",-1))])])]),_:1})]),_:1}),t(v,{span:6},{default:l(()=>[t(x,{shadow:"hover",class:"stat-card"},{default:l(()=>[s("div",nt,[s("div",dt,[t(h,{color:"#F56C6C"},{default:l(()=>[t(w(le))]),_:1})]),s("div",it,[s("div",rt,f(se.value),1),e[29]||(e[29]=s("div",{class:"stat-label"},"总下载量",-1))])])]),_:1})]),_:1})]),_:1}),t(x,{shadow:"hover",class:"filter-card"},{default:l(()=>[t(w(G),{model:p,inline:!0,class:"search-form"},{default:l(()=>[t(u,{label:"状态筛选:"},{default:l(()=>[t(M,{modelValue:p.status,"onUpdate:modelValue":e[1]||(e[1]=a=>p.status=a),placeholder:"全部状态",clearable:"",style:{width:"140px"}},{default:l(()=>[t(y,{label:"全部",value:""}),t(y,{label:"已发布",value:"Active"}),t(y,{label:"审核中",value:"Pending"}),t(y,{label:"已拒绝",value:"Rejected"}),t(y,{label:"已下架",value:"Inactive"})]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"搜索:"},{default:l(()=>[t(b,{modelValue:p.search,"onUpdate:modelValue":e[2]||(e[2]=a=>p.search=a),placeholder:"输入资源名称",clearable:"",style:{width:"200px"},onKeyup:$e(V,["enter"])},null,8,["modelValue"])]),_:1}),t(u,{label:"创建时间:"},{default:l(()=>[t(be,{modelValue:H.value,"onUpdate:modelValue":e[3]||(e[3]=a=>H.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",style:{width:"240px"},format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:de},null,8,["modelValue"])]),_:1}),t(u,null,{default:l(()=>[t(m,{type:"primary",icon:"Search",onClick:V},{default:l(()=>e[30]||(e[30]=[i("搜索")])),_:1,__:[30]}),t(m,{icon:"Refresh",onClick:ie},{default:l(()=>e[31]||(e[31]=[i("重置")])),_:1,__:[31]})]),_:1})]),_:1},8,["model"])]),_:1}),t(x,{shadow:"hover",class:"resource-list-card"},{default:l(()=>[Fe((c(),k("div",null,[C.value.length===0&&!F.value?(c(),k("div",ut,[t(ke,{description:"还没有上传任何资源"},{default:l(()=>[t(m,{type:"primary",onClick:e[4]||(e[4]=a=>U.value=!0)},{default:l(()=>e[32]||(e[32]=[i(" 立即上传 ")])),_:1,__:[32]})]),_:1})])):(c(),k("div",pt,[(c(!0),k(Q,null,X(C.value,a=>(c(),k("div",{key:a.id,class:Se(["resource-card",{"pending-card":a.status==="Pending","rejected-card":a.status==="Rejected"}])},[s("div",ct,[s("div",{class:"resource-title",onClick:$=>o.$router.push(`/resource/${a.id}`)},f(a.name),9,_t),t(he,{onCommand:$=>re($,a)},{dropdown:l(()=>[t(Ve,null,{default:l(()=>[t(P,{command:"edit"},{default:l(()=>e[33]||(e[33]=[i("编辑")])),_:1,__:[33]}),t(P,{command:"view"},{default:l(()=>e[34]||(e[34]=[i("查看")])),_:1,__:[34]}),t(P,{command:"stats"},{default:l(()=>e[35]||(e[35]=[i("数据统计")])),_:1,__:[35]}),t(P,{command:"comments"},{default:l(()=>e[36]||(e[36]=[i("查看评论")])),_:1,__:[36]}),t(P,{command:"delete",divided:""},{default:l(()=>e[37]||(e[37]=[i("删除")])),_:1,__:[37]})]),_:1})]),default:l(()=>[t(m,{type:"text",size:"small"},{default:l(()=>[t(h,null,{default:l(()=>[t(w(je))]),_:1})]),_:1})]),_:2},1032,["onCommand"])]),s("div",mt,[s("div",ft,[e[38]||(e[38]=s("span",{class:"label"},"版本:",-1)),s("span",vt,f(a.version||"未设置"),1)]),s("div",gt,[e[39]||(e[39]=s("span",{class:"label"},"状态:",-1)),t(Ce,{type:ge(a.status),size:"small"},{default:l(()=>[i(f(we(a.status)),1)]),_:2},1032,["type"])]),a.status==="Rejected"&&a.review_comment?(c(),k("div",wt,[e[40]||(e[40]=s("span",{class:"label"},"拒绝原因:",-1)),t(Re,{content:a.review_comment,placement:"top"},{default:l(()=>[s("span",yt,f(a.review_comment.substring(0,20))+"...",1)]),_:2},1032,["content"])])):ee("",!0)]),s("div",bt,f(a.description||"暂无描述"),1),s("div",kt,[s("div",Vt,[t(h,null,{default:l(()=>[t(w(le))]),_:1}),s("span",null,f(a.download_count),1)]),s("div",ht,[t(h,null,{default:l(()=>[t(w(Ie))]),_:1}),s("span",null,f(a.like_count||0),1)]),s("div",Ct,[t(h,null,{default:l(()=>[t(w(te))]),_:1}),s("span",null,f(ye(a.created_at)),1)])]),s("div",Rt,[a.status==="Rejected"?(c(),A(m,{key:0,type:"warning",size:"small",onClick:$=>J(a)},{default:l(()=>e[41]||(e[41]=[i(" 重新提交 ")])),_:2,__:[41]},1032,["onClick"])):(c(),A(m,{key:1,type:"primary",size:"small",onClick:$=>J(a)},{default:l(()=>e[42]||(e[42]=[i(" 编辑 ")])),_:2,__:[42]},1032,["onClick"])),t(m,{type:"success",size:"small",onClick:$=>o.$router.push(`/resource/${a.id}`)},{default:l(()=>e[43]||(e[43]=[i(" 查看详情 ")])),_:2,__:[43]},1032,["onClick"])])],2))),128))])),O.value>0?(c(),k("div",Ut,[t(Ue,{"current-page":R.page,"onUpdate:currentPage":e[5]||(e[5]=a=>R.page=a),"page-size":R.pageSize,"onUpdate:pageSize":e[6]||(e[6]=a=>R.pageSize=a),"page-sizes":[12,24,48],total:O.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:V,onCurrentChange:V},null,8,["current-page","page-size","total"])])):ee("",!0)])),[[ze,F.value]])]),_:1}),t(Z,{modelValue:U.value,"onUpdate:modelValue":e[15]||(e[15]=a=>U.value=a),title:"上传新资源",width:"700px","close-on-click-modal":!1},{footer:l(()=>[s("div",zt,[t(m,{onClick:e[14]||(e[14]=a=>U.value=!1)},{default:l(()=>e[47]||(e[47]=[i("取消")])),_:1,__:[47]}),t(m,{type:"primary",onClick:_e,loading:B.value},{default:l(()=>[i(f(n.skipReview?"立即发布":"提交审核"),1)]),_:1},8,["loading"])])]),default:l(()=>[t(w(G),{model:n,rules:W,ref_key:"uploadFormRef",ref:I,"label-width":"100px"},{default:l(()=>[t(D,{gutter:20},{default:l(()=>[t(v,{span:12},{default:l(()=>[t(u,{label:"资源名称",prop:"name"},{default:l(()=>[t(b,{modelValue:n.name,"onUpdate:modelValue":e[7]||(e[7]=a=>n.name=a),placeholder:"请输入资源名称"},null,8,["modelValue"])]),_:1})]),_:1}),t(v,{span:12},{default:l(()=>[t(u,{label:"作者",prop:"author"},{default:l(()=>[t(b,{modelValue:n.author,"onUpdate:modelValue":e[8]||(e[8]=a=>n.author=a),placeholder:"请输入作者名称"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(D,{gutter:20},{default:l(()=>[t(v,{span:12},{default:l(()=>[t(u,{label:"版本",prop:"version"},{default:l(()=>[t(b,{modelValue:n.version,"onUpdate:modelValue":e[9]||(e[9]=a=>n.version=a),placeholder:"请输入版本号（可选）"},null,8,["modelValue"])]),_:1})]),_:1}),t(v,{span:12},{default:l(()=>[t(u,{label:"分类",prop:"category_id"},{default:l(()=>[t(M,{modelValue:n.category_id,"onUpdate:modelValue":e[10]||(e[10]=a=>n.category_id=a),placeholder:"请选择分类",style:{width:"100%"}},{default:l(()=>[(c(!0),k(Q,null,X(q.value,a=>(c(),A(y,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(u,{label:"资源描述",prop:"description"},{default:l(()=>[t(b,{modelValue:n.description,"onUpdate:modelValue":e[11]||(e[11]=a=>n.description=a),type:"textarea",rows:4,placeholder:"请输入资源描述","show-word-limit":"",maxlength:"500"},null,8,["modelValue"])]),_:1}),t(u,{label:"文件链接",prop:"file_url"},{default:l(()=>[t(b,{modelValue:n.file_url,"onUpdate:modelValue":e[12]||(e[12]=a=>n.file_url=a),placeholder:"请输入文件下载链接"},{append:l(()=>[t(m,{onClick:ce,loading:L.value},{default:l(()=>e[44]||(e[44]=[i(" 验证链接 ")])),_:1,__:[44]},8,["loading"])]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"元老特权"},{default:l(()=>[t(xe,{modelValue:n.skipReview,"onUpdate:modelValue":e[13]||(e[13]=a=>n.skipReview=a)},{default:l(()=>e[45]||(e[45]=[i(" 跳过审核（直接发布） ")])),_:1,__:[45]},8,["modelValue"]),s("div",xt,[t(h,null,{default:l(()=>[t(w(Ye))]),_:1}),e[46]||(e[46]=s("span",null,"作为元老，您可以选择跳过审核流程直接发布资源",-1))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Z,{modelValue:z.value,"onUpdate:modelValue":e[23]||(e[23]=a=>z.value=a),title:"编辑资源",width:"700px","close-on-click-modal":!1},{footer:l(()=>[s("div",Dt,[t(m,{onClick:e[22]||(e[22]=a=>z.value=!1)},{default:l(()=>e[48]||(e[48]=[i("取消")])),_:1,__:[48]}),t(m,{type:"primary",onClick:me,loading:T.value},{default:l(()=>e[49]||(e[49]=[i(" 保存修改 ")])),_:1,__:[49]},8,["loading"])])]),default:l(()=>[t(w(G),{model:d,rules:W,ref_key:"editFormRef",ref:Y,"label-width":"100px"},{default:l(()=>[t(D,{gutter:20},{default:l(()=>[t(v,{span:12},{default:l(()=>[t(u,{label:"资源名称",prop:"name"},{default:l(()=>[t(b,{modelValue:d.name,"onUpdate:modelValue":e[16]||(e[16]=a=>d.name=a),placeholder:"请输入资源名称"},null,8,["modelValue"])]),_:1})]),_:1}),t(v,{span:12},{default:l(()=>[t(u,{label:"版本",prop:"version"},{default:l(()=>[t(b,{modelValue:d.version,"onUpdate:modelValue":e[17]||(e[17]=a=>d.version=a),placeholder:"请输入版本号（可选）"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(D,{gutter:20},{default:l(()=>[t(v,{span:12},{default:l(()=>[t(u,{label:"分类",prop:"category_id"},{default:l(()=>[t(M,{modelValue:d.category_id,"onUpdate:modelValue":e[18]||(e[18]=a=>d.category_id=a),placeholder:"请选择分类",style:{width:"100%"}},{default:l(()=>[(c(!0),k(Q,null,X(q.value,a=>(c(),A(y,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(v,{span:12},{default:l(()=>[t(u,{label:"状态控制"},{default:l(()=>[t(M,{modelValue:d.status,"onUpdate:modelValue":e[19]||(e[19]=a=>d.status=a),placeholder:"选择状态",style:{width:"100%"}},{default:l(()=>[t(y,{label:"已发布",value:"Active"}),t(y,{label:"待审核",value:"Pending"}),t(y,{label:"已下架",value:"Inactive"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(u,{label:"资源描述",prop:"description"},{default:l(()=>[t(b,{modelValue:d.description,"onUpdate:modelValue":e[20]||(e[20]=a=>d.description=a),type:"textarea",rows:4,placeholder:"请输入资源描述","show-word-limit":"",maxlength:"500"},null,8,["modelValue"])]),_:1}),t(u,{label:"文件链接",prop:"file_url"},{default:l(()=>[t(b,{modelValue:d.file_url,"onUpdate:modelValue":e[21]||(e[21]=a=>d.file_url=a),placeholder:"请输入文件下载链接"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),It=Le(Pt,[["__scopeId","data-v-6c06abc0"]]);export{It as default};
