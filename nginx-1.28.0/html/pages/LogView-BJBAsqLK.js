import{x as te,r as i,w as le,j as se,y as k,A as t,J as ae,Q as l,I as s,u as v,al as r,M as _,O as d,ar as oe,K as N,ax as ne,z as V}from"../chunks/vue-vendor-BleHOoLr.js";import{o as W,H as ie,ab as de,a1 as ue,ac as re,v as ce,U as ve,f as _e,D as pe,K as c}from"../chunks/element-plus-Cc1YNc_4.js";import{_ as fe}from"../assets/index-B_N-aWSj.js";import{l as O}from"../chunks/logs-BYhp7VRE.js";import"../chunks/utils-Dq7h7Pqt.js";const me={class:"admin-page log-view-desktop"},ge={class:"page-header"},he={class:"header-content"},ye={class:"header-left"},be={class:"header-icon"},we={class:"header-actions"},ke={class:"stats-section"},Ve={class:"stats-grid"},Ce={class:"stat-card"},xe={class:"stat-icon"},Re={class:"stat-content"},ze={class:"stat-number"},Le={class:"stat-card"},Ne={class:"stat-icon"},Oe={class:"stat-content"},Se={class:"stat-number"},De={class:"stat-card"},Ie={class:"stat-icon"},Ae={class:"stat-content"},Ee={class:"stat-number"},Me={class:"stat-card"},Ue={class:"stat-icon"},$e={class:"stat-content"},Fe={class:"stat-number"},Te={class:"search-section"},We={class:"search-left"},Ye={class:"search-right"},Be={class:"table-section"},je={class:"message-cell"},Je={key:0,class:"empty-logs"},Ke={class:"pagination-section"},He={key:0,class:"log-detail"},Qe={class:"detail-item"},qe={class:"detail-value"},Ge={class:"detail-item"},Pe={class:"detail-item"},Xe={class:"detail-value"},Ze={class:"detail-item"},et={class:"detail-message"},tt={key:0,class:"detail-item"},lt={class:"detail-stack"},st={key:1,class:"detail-item"},at={class:"detail-meta"},ot={class:"confirm-content"},nt={class:"dialog-footer"},it=te({name:"LogView",__name:"LogView",setup(dt){ne();const m=i([]),R=i(!1),b=i(1),S=i(20),z=i(0),C=i(""),g=i(""),h=i(null);i("");const x=i(!1),u=i(null),y=i(!1),D=i(""),I=i(()=>{}),E=i(0),M=i(0),U=i(0);function Y(a){u.value=a,x.value=!0}function B(a){D.value="确定要删除这条日志吗？",I.value=async()=>{try{const e=await O.deleteLog(a.id);e.code===0?(c.success("日志已删除"),x.value=!1,p(b.value)):c.error(e.message||"删除失败")}catch(e){console.error("删除日志失败:",e),c.error("删除日志失败")}finally{y.value=!1}},y.value=!0}function j(a){S.value=a,p(1)}function $(a){switch(a){case"ERROR":return"danger";case"WARN":return"warning";case"INFO":default:return"success"}}async function p(a=1){b.value=a,R.value=!0;try{const e=await O.getLogs({page:b.value,pageSize:S.value,level:g.value||void 0,search:C.value||void 0});e.code===0&&e.data?(m.value=e.data.logs||[],z.value=e.data.total||0,E.value=m.value.filter(o=>o.level==="INFO").length,M.value=m.value.filter(o=>o.level==="WARN").length,U.value=m.value.filter(o=>o.level==="ERROR").length):c.warning(e.message||"获取日志数据失败")}catch(e){console.error("加载日志失败:",e),c.error("日志加载失败，请稍后重试"),m.value=[],z.value=0}finally{R.value=!1}}function J(){p(b.value)}function A(){p(1)}async function K(){try{const a={};C.value&&(a.search=C.value),g.value&&(a.level=g.value),h.value&&h.value[0]&&h.value[1]&&(a.start_date=h.value[0],a.end_date=h.value[1]);const e=await O.exportLogs(a);if(e.code===0&&e.data){const o=document.createElement("a");o.href=e.data.url,o.download=`system_logs_${new Date().toISOString().split("T")[0]}.txt`,o.click(),c.success("日志导出成功")}else c.error("导出日志失败")}catch(a){console.error("导出日志失败:",a),c.error("导出失败，请稍后重试")}}async function H(){D.value="确定要清空所有日志吗？此操作不可恢复！",I.value=async()=>{try{const a={};g.value&&(a.level=g.value);const e=await O.clearLogs(a);e.code===0&&e.data?(c.success(`成功清除${e.data.deleted_count||0}条日志`),p(1)):c.error(e.message||"清空失败")}catch(a){console.error("清空日志失败:",a),c.error("清空日志失败")}finally{y.value=!1}},y.value=!0}return le(b,a=>p(a)),se(()=>p(1)),(a,e)=>{const o=r("el-icon"),f=r("el-button"),Q=r("el-input"),L=r("el-option"),q=r("el-select"),G=r("el-date-picker"),w=r("el-table-column"),F=r("el-tag"),P=r("el-table"),X=r("el-empty"),Z=r("el-pagination"),T=r("el-dialog"),ee=oe("loading");return V(),k("div",me,[t("div",ge,[t("div",he,[t("div",ye,[t("div",be,[l(o,{size:32},{default:s(()=>[l(v(W))]),_:1})]),e[8]||(e[8]=t("div",{class:"header-info"},[t("h1",{class:"page-title"},"日志查看"),t("p",{class:"page-subtitle"},"查看和管理系统运行日志")],-1))]),t("div",we,[l(f,{onClick:J},{default:s(()=>[l(o,null,{default:s(()=>[l(v(ie))]),_:1}),e[9]||(e[9]=_(" 刷新 "))]),_:1,__:[9]})])])]),t("div",ke,[t("div",Ve,[t("div",Ce,[t("div",xe,[l(o,{size:24},{default:s(()=>[l(v(W))]),_:1})]),t("div",Re,[t("div",ze,d(z.value),1),e[10]||(e[10]=t("div",{class:"stat-label"},"总日志",-1))])]),t("div",Le,[t("div",Ne,[l(o,{size:24},{default:s(()=>[l(v(de))]),_:1})]),t("div",Oe,[t("div",Se,d(E.value),1),e[11]||(e[11]=t("div",{class:"stat-label"},"信息",-1))])]),t("div",De,[t("div",Ie,[l(o,{size:24},{default:s(()=>[l(v(ue))]),_:1})]),t("div",Ae,[t("div",Ee,d(M.value),1),e[12]||(e[12]=t("div",{class:"stat-label"},"警告",-1))])]),t("div",Me,[t("div",Ue,[l(o,{size:24},{default:s(()=>[l(v(re))]),_:1})]),t("div",$e,[t("div",Fe,d(U.value),1),e[13]||(e[13]=t("div",{class:"stat-label"},"错误",-1))])])])]),t("div",Te,[t("div",We,[l(Q,{modelValue:C.value,"onUpdate:modelValue":e[0]||(e[0]=n=>C.value=n),placeholder:"搜索日志内容...",clearable:"",style:{width:"250px"},onInput:A},{prefix:s(()=>[l(o,null,{default:s(()=>[l(v(ce))]),_:1})]),_:1},8,["modelValue"]),l(q,{modelValue:g.value,"onUpdate:modelValue":e[1]||(e[1]=n=>g.value=n),placeholder:"日志等级",clearable:"",style:{width:"150px"},onChange:A},{default:s(()=>[l(L,{label:"全部",value:""}),l(L,{label:"INFO",value:"INFO"}),l(L,{label:"WARN",value:"WARN"}),l(L,{label:"ERROR",value:"ERROR"})]),_:1},8,["modelValue"]),l(G,{modelValue:h.value,"onUpdate:modelValue":e[2]||(e[2]=n=>h.value=n),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",style:{width:"350px"},"value-format":"YYYY-MM-DD",onChange:A},null,8,["modelValue"])]),t("div",Ye,[l(f,{onClick:H,type:"danger"},{default:s(()=>[l(o,null,{default:s(()=>[l(v(ve))]),_:1}),e[14]||(e[14]=_(" 清空日志 "))]),_:1,__:[14]}),l(f,{onClick:K,type:"success"},{default:s(()=>[l(o,null,{default:s(()=>[l(v(_e))]),_:1}),e[15]||(e[15]=_(" 导出日志 "))]),_:1,__:[15]})])]),ae((V(),k("div",Be,[l(P,{data:m.value,stripe:"",border:"",style:{width:"100%"},"header-cell-style":{background:"var(--bg-secondary)",color:"var(--text-primary)"},"row-style":{background:"var(--bg-card)"}},{default:s(()=>[l(w,{type:"index",width:"50",label:"#"}),l(w,{prop:"timestamp",label:"时间",width:"180"}),l(w,{prop:"level",label:"等级",width:"100"},{default:s(({row:n})=>[l(F,{type:$(n.level),size:"small"},{default:s(()=>[_(d(n.level),1)]),_:2},1032,["type"])]),_:1}),l(w,{prop:"source",label:"来源",width:"150"}),l(w,{prop:"message",label:"消息","min-width":"400"},{default:s(({row:n})=>[t("div",je,d(n.message),1)]),_:1}),l(w,{label:"操作",width:"120",fixed:"right"},{default:s(({row:n})=>[l(f,{size:"small",onClick:ut=>Y(n),type:"primary"},{default:s(()=>[l(o,null,{default:s(()=>[l(v(pe))]),_:1}),e[16]||(e[16]=_(" 详情 "))]),_:2,__:[16]},1032,["onClick"])]),_:1})]),_:1},8,["data"]),!R.value&&m.value.length===0?(V(),k("div",Je,[l(X,{description:"暂无日志数据"})])):N("",!0)])),[[ee,R.value]]),t("div",Ke,[l(Z,{"current-page":b.value,"page-size":S.value,"page-sizes":[10,20,50,100],total:z.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:j,onCurrentChange:p},null,8,["current-page","page-size","total"])]),l(T,{modelValue:x.value,"onUpdate:modelValue":e[5]||(e[5]=n=>x.value=n),title:"日志详情",width:"700px","close-on-click-modal":!1},{footer:s(()=>[l(f,{onClick:e[3]||(e[3]=n=>x.value=!1)},{default:s(()=>e[23]||(e[23]=[_("关闭")])),_:1,__:[23]}),l(f,{type:"danger",onClick:e[4]||(e[4]=n=>B(u.value))},{default:s(()=>e[24]||(e[24]=[_("删除")])),_:1,__:[24]})]),default:s(()=>[u.value?(V(),k("div",He,[t("div",Qe,[e[17]||(e[17]=t("span",{class:"detail-label"},"时间：",-1)),t("span",qe,d(u.value.timestamp),1)]),t("div",Ge,[e[18]||(e[18]=t("span",{class:"detail-label"},"等级：",-1)),l(F,{type:$(u.value.level)},{default:s(()=>[_(d(u.value.level),1)]),_:1},8,["type"])]),t("div",Pe,[e[19]||(e[19]=t("span",{class:"detail-label"},"来源：",-1)),t("span",Xe,d(u.value.source),1)]),t("div",Ze,[e[20]||(e[20]=t("span",{class:"detail-label"},"消息：",-1)),t("div",et,d(u.value.message),1)]),u.value.stack?(V(),k("div",tt,[e[21]||(e[21]=t("span",{class:"detail-label"},"堆栈：",-1)),t("pre",lt,d(u.value.stack),1)])):N("",!0),u.value.meta?(V(),k("div",st,[e[22]||(e[22]=t("span",{class:"detail-label"},"元数据：",-1)),t("pre",at,d(JSON.stringify(u.value.meta,null,2)),1)])):N("",!0)])):N("",!0)]),_:1},8,["modelValue"]),l(T,{modelValue:y.value,"onUpdate:modelValue":e[7]||(e[7]=n=>y.value=n),title:"确认操作",width:"400px"},{footer:s(()=>[t("span",nt,[l(f,{onClick:e[6]||(e[6]=n=>y.value=!1)},{default:s(()=>e[25]||(e[25]=[_("取消")])),_:1,__:[25]}),l(f,{type:"danger",onClick:I.value},{default:s(()=>e[26]||(e[26]=[_("确认")])),_:1,__:[26]},8,["onClick"])])]),default:s(()=>[t("div",ot,[t("p",null,d(D.value),1)])]),_:1},8,["modelValue"])])}}}),ft=fe(it,[["__scopeId","data-v-034dc6b6"]]);export{ft as default};
