import{k as Ce,ae as N,Y as ze,J as xe,c as Ve,$ as Se,af as $e,X as Me,ag as De,f as P,M as O,a4 as Ue,I as i,E as A}from"../chunks/element-plus-D5w7-vkF.js";import{a as g,l as Ae,_ as Ie}from"../assets/index-C3B7XhMB.js";import{x as Ee,r as v,X as ee,j as Fe,y as I,A as t,K as R,Q as a,I as s,u as c,al as f,M as d,O as r,J as Te,ar as je,H as Le,z as x}from"../chunks/vue-vendor-BleHOoLr.js";import"../chunks/utils-Dq7h7Pqt.js";function Ne(_){return g.get("/v1/admin/backups",{params:{page:_.page||1,page_size:_.size||20}})}function Pe(){return g.get("/v1/admin/backup/stats")}function Oe(_){return g.post("/v1/admin/backup",_)}function Re(_){return g.delete(`/v1/admin/backup/${_}`)}function ae(_){return g.post("/v1/admin/backup/batch-delete",{backup_ids:_})}function qe(_){return g.post(`/v1/admin/backup/${_}/restore`,{confirm:!0})}function Je(_){return`/api/v1/admin/backup/${_}/download`}function te(_){return g.post("/v1/admin/backup-schedule",_)}function Ke(){return g.get("/v1/admin/backup-schedule")}const Xe={class:"admin-page backup-manage"},Ge={class:"page-header"},He={class:"header-content"},Qe={class:"header-left"},Ye={class:"header-icon"},We={class:"header-actions"},Ze={class:"stats-section"},ea={class:"stats-grid"},aa={class:"stat-card"},ta={class:"stat-icon"},la={class:"stat-content"},sa={class:"stat-number"},oa={class:"stat-card"},na={class:"stat-icon"},ua={class:"stat-content"},ia={class:"stat-number"},da={class:"stat-card"},ca={class:"stat-icon"},ra={class:"stat-content"},pa={class:"stat-number"},_a={class:"stat-card"},fa={class:"stat-icon"},ba={class:"stat-content"},va={class:"stat-number"},ma={class:"content-section backup-operations"},ka={class:"operations-grid"},ga={class:"operation-icon"},ya={class:"operation-control"},ha={key:0,class:"schedule-info"},wa={class:"operation-icon"},Ba={class:"operation-icon"},Ca={class:"operation-icon"},za={class:"table-section"},xa={class:"pagination-section"},Va={key:0,class:"batch-actions"},Sa={class:"selected-count"},$a={key:0,class:"backup-detail"},Ma={class:"detail-item"},Da={class:"detail-item"},Ua={class:"detail-item"},Aa={class:"detail-item"},Ia={class:"detail-item"},Ea={class:"detail-item"},Fa={class:"detail-item"},Ta={class:"detail-item"},ja={class:"description-box"},La=Ee({__name:"BackupManage",setup(_){const E=v(!1),F=v(!1),h=v([]),w=v([]),V=v(1),S=v(20),T=v(0),j=v(!1),C=v(!1),m=v(null),k=ee({total_backups:0,success_backups:0,failed_backups:0,total_size:0}),n=ee({enable_auto_backup:!1,backup_interval_hours:24,backup_location:"./backups",max_backup_files:10}),z=async()=>{await Promise.all([B(),le()])},le=async()=>{const l=await Pe();l.code===0&&Object.assign(k,l.data)},b=v(!1),se=async()=>{try{n.enable_auto_backup=b.value;const l={enabled:n.enable_auto_backup,frequency:"hourly",time:"00:00",retain_count:n.max_backup_files,auto_clean:!0},e=await te(l);e.code===0?($.value=n.enable_auto_backup?`${n.backup_interval_hours}h`:"已禁用",i.success(n.enable_auto_backup?"自动备份已启用":"自动备份已禁用")):(b.value=!b.value,n.enable_auto_backup=b.value,i.error(e.message||"配置保存失败"))}catch(l){console.error("切换自动备份状态失败:",l),b.value=!b.value,n.enable_auto_backup=b.value,i.error("操作失败，请重试")}},$=v(""),oe=async()=>{await q(),i.info("备份创建后可在列表下载")};async function q(){F.value=!0;try{(await Oe({backup_type:"Manual"})).code===0&&(i.success("备份创建成功"),z())}catch{i.error("创建备份失败")}finally{F.value=!1}}const ne=()=>{const l=document.createElement("input");l.type="file",l.accept=".db",l.onchange=async()=>{if(!l.files?.length)return;const e=new FormData;e.append("file",l.files[0]),(await Ae("/api/v1/admin/backup/upload",e)).code===0&&(i.success("导入成功"),z())},l.click()},ue=async()=>{await A.confirm("确定清理所有失败备份记录吗?","提示");const l=h.value.filter(u=>u.status!=="Success").map(u=>u.id);if(l.length===0){i.info("无失败备份");return}(await ae(l)).code===0&&(i.success("已清理"),z())};async function B(){E.value=!0;try{const l={page:V.value,size:S.value},e=await Ne(l);e.code===0&&(h.value=e.data.list||[],T.value=e.data.total||0,ie())}catch(l){console.error("加载备份记录失败:",l),i.error("加载备份记录失败")}finally{E.value=!1}}function ie(){k.total_backups=T.value,k.success_backups=h.value.filter(l=>l.status==="Success").length,k.failed_backups=h.value.filter(l=>l.status==="Failed").length,k.total_size=h.value.reduce((l,e)=>l+(e.file_size||0),0)}function de(){C.value=!0}function ce(l){S.value=l,B()}function re(l){V.value=l,B()}async function pe(l){try{const e=document.createElement("a");e.href=`http://127.0.0.1:15201${Je(l.id)}`,e.download=l.filename,e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e),i.success("下载已开始")}catch{i.error("下载失败")}}async function _e(l){try{await A.confirm("确定要恢复这个备份吗？这将覆盖当前数据库！","确认恢复",{type:"warning"});const e=await qe(l.id);e.code===0?(i.success("备份恢复成功"),B()):i.error(e.message||"恢复失败")}catch(e){e!=="cancel"&&i.error("恢复失败")}}async function fe(l){try{await A.confirm("确定要删除这个备份吗？","确认删除"),(await Re(l.id)).code===0&&(i.success("备份已删除"),B())}catch(e){e!=="cancel"&&i.error("删除失败")}}async function be(){if(w.value.length===0){i.warning("请选择要删除的备份");return}try{await A.confirm(`确定要删除选中的 ${w.value.length} 个备份吗？`,"确认删除");const l=w.value.map(u=>u.id),e=await ae(l);e.code===0?(i.success("批量删除成功"),w.value=[],B()):i.error(e.message||"批量删除失败")}catch(l){l!=="cancel"&&i.error("删除失败")}}function ve(){i.info("批量下载功能开发中...")}async function me(){try{const l={enabled:n.enable_auto_backup,frequency:"hourly",time:"00:00",retain_count:n.max_backup_files,auto_clean:!0},e=await te(l);e.code===0?(i.success("自动备份配置已保存"),b.value=n.enable_auto_backup,$.value=`${n.backup_interval_hours}h`,C.value=!1):i.error(e.message||"保存配置失败")}catch(l){console.error("保存自动备份配置失败:",l),i.error("保存配置时发生错误")}}function J(l){return{Auto:"primary",Manual:"success",Scheduled:"warning"}[l]||"info"}function K(l){return{Auto:"自动备份",Manual:"手动备份",Scheduled:"定时备份"}[l]||l}function X(l){return{Success:"success",Failed:"danger",InProgress:"warning"}[l]||"info"}function G(l){return{Success:"成功",Failed:"失败",InProgress:"进行中"}[l]||l}function L(l){if(!l)return"0 B";const e=1024,u=["B","KB","MB","GB"],p=Math.floor(Math.log(l)/Math.log(e));return parseFloat((l/Math.pow(e,p)).toFixed(2))+" "+u[p]}function H(l){return l?new Date(l).toLocaleString():"-"}async function ke(){try{const l=await Ke();l.code===0&&l.data&&(Object.assign(n,{enable_auto_backup:l.data.enabled||!1,backup_interval_hours:24,backup_location:l.data.location||"backups/",max_backup_files:l.data.retain_count||10}),b.value=n.enable_auto_backup,$.value=`${n.backup_interval_hours}h`)}catch(l){console.error("加载自动备份配置失败:",l),Object.assign(n,{enable_auto_backup:!1,backup_interval_hours:24,backup_location:"backups/",max_backup_files:10})}}return Fe(async()=>{await z(),await ke()}),(l,e)=>{const u=f("el-icon"),p=f("el-button"),Q=f("el-switch"),M=f("el-card"),y=f("el-table-column"),D=f("el-tag"),ge=f("el-table"),ye=f("el-pagination"),Y=f("el-dialog"),U=f("el-form-item"),W=f("el-input-number"),he=f("el-input"),we=f("el-form"),Be=je("loading");return x(),I("div",Xe,[t("div",Ge,[t("div",He,[t("div",Qe,[t("div",Ye,[a(u,{size:32},{default:s(()=>[a(c(Ce))]),_:1})]),e[11]||(e[11]=t("div",{class:"header-info"},[t("h1",{class:"page-title"},"数据库备份管理"),t("p",{class:"page-subtitle"},"管理系统数据库的备份、恢复和监控功能")],-1))]),t("div",We,[a(p,{type:"primary",onClick:q,loading:F.value},{default:s(()=>[a(u,null,{default:s(()=>[a(c(N))]),_:1}),e[12]||(e[12]=d(" 开始备份 "))]),_:1,__:[12]},8,["loading"]),a(p,{onClick:z},{default:s(()=>[a(u,null,{default:s(()=>[a(c(ze))]),_:1}),e[13]||(e[13]=d(" 刷新 "))]),_:1,__:[13]})])])]),t("div",Ze,[t("div",ea,[t("div",aa,[t("div",ta,[a(u,{size:24},{default:s(()=>[a(c(xe))]),_:1})]),t("div",la,[t("div",sa,r(k.total_backups),1),e[14]||(e[14]=t("div",{class:"stat-label"},"总备份数",-1))])]),t("div",oa,[t("div",na,[a(u,{size:24},{default:s(()=>[a(c(Ve))]),_:1})]),t("div",ua,[t("div",ia,r(k.success_backups),1),e[15]||(e[15]=t("div",{class:"stat-label"},"成功备份",-1))])]),t("div",da,[t("div",ca,[a(u,{size:24},{default:s(()=>[a(c(Se))]),_:1})]),t("div",ra,[t("div",pa,r(k.failed_backups),1),e[16]||(e[16]=t("div",{class:"stat-label"},"失败备份",-1))])]),t("div",_a,[t("div",fa,[a(u,{size:24},{default:s(()=>[a(c($e))]),_:1})]),t("div",ba,[t("div",va,r(L(Number(k.total_size))),1),e[17]||(e[17]=t("div",{class:"stat-label"},"存储空间",-1))])])])]),t("div",ma,[e[30]||(e[30]=t("h2",{class:"section-title"},"备份操作",-1)),t("div",ka,[a(M,{class:"operation-card",shadow:"hover"},{default:s(()=>[t("div",ga,[a(u,{size:32},{default:s(()=>[a(c(Me))]),_:1})]),e[19]||(e[19]=t("h3",null,"定时备份",-1)),e[20]||(e[20]=t("p",null,"配置自动备份计划",-1)),t("div",ya,[a(Q,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=o=>b.value=o),"active-text":"已启用","inactive-text":"已禁用",onChange:se},null,8,["modelValue"])]),b.value?(x(),I("div",ha,[t("p",null,"当前计划: "+r($.value),1)])):R("",!0),a(p,{type:"success",onClick:de},{default:s(()=>[a(u,null,{default:s(()=>[a(c(De))]),_:1}),e[18]||(e[18]=d(" 配置计划 "))]),_:1,__:[18]})]),_:1,__:[19,20]}),a(M,{class:"operation-card",shadow:"hover"},{default:s(()=>[t("div",wa,[a(u,{size:32},{default:s(()=>[a(c(P))]),_:1})]),e[22]||(e[22]=t("h3",null,"导出备份",-1)),e[23]||(e[23]=t("p",null,"将备份导出到本地",-1)),a(p,{type:"primary",onClick:oe},{default:s(()=>[a(u,null,{default:s(()=>[a(c(P))]),_:1}),e[21]||(e[21]=d(" 导出备份 "))]),_:1,__:[21]})]),_:1,__:[22,23]}),a(M,{class:"operation-card",shadow:"hover"},{default:s(()=>[t("div",Ba,[a(u,{size:32},{default:s(()=>[a(c(N))]),_:1})]),e[25]||(e[25]=t("h3",null,"导入备份",-1)),e[26]||(e[26]=t("p",null,"从本地导入备份文件",-1)),a(p,{type:"warning",onClick:ne},{default:s(()=>[a(u,null,{default:s(()=>[a(c(N))]),_:1}),e[24]||(e[24]=d(" 导入备份 "))]),_:1,__:[24]})]),_:1,__:[25,26]}),a(M,{class:"operation-card",shadow:"hover"},{default:s(()=>[t("div",Ca,[a(u,{size:32},{default:s(()=>[a(c(O))]),_:1})]),e[28]||(e[28]=t("h3",null,"清理备份",-1)),e[29]||(e[29]=t("p",null,"删除过期或不必要的备份",-1)),a(p,{type:"danger",onClick:ue},{default:s(()=>[a(u,null,{default:s(()=>[a(c(O))]),_:1}),e[27]||(e[27]=d(" 清理备份 "))]),_:1,__:[27]})]),_:1,__:[28,29]})])]),t("div",za,[e[34]||(e[34]=t("h2",{class:"section-title"},"备份记录",-1)),Te((x(),Le(ge,{data:h.value,style:{width:"100%"},"header-cell-style":{background:"var(--bg-secondary)",color:"var(--text-primary)"},"row-style":{background:"var(--bg-card)"},border:"",stripe:""},{default:s(()=>[a(y,{prop:"id",label:"ID",width:"80"}),a(y,{prop:"filename",label:"文件名","min-width":"200"}),a(y,{prop:"type",label:"类型",width:"120"},{default:s(({row:o})=>[a(D,{type:J(o.type)},{default:s(()=>[d(r(K(o.type)),1)]),_:2},1032,["type"])]),_:1}),a(y,{prop:"size",label:"大小",width:"120"},{default:s(({row:o})=>[d(r(L(o.size)),1)]),_:1}),a(y,{prop:"status",label:"状态",width:"120"},{default:s(({row:o})=>[a(D,{type:X(o.status)},{default:s(()=>[d(r(G(o.status)),1)]),_:2},1032,["type"])]),_:1}),a(y,{prop:"created_at",label:"创建时间",width:"180"},{default:s(({row:o})=>[d(r(H(o.created_at)),1)]),_:1}),a(y,{label:"操作",width:"250",fixed:"right"},{default:s(({row:o})=>[a(p,{size:"small",type:"primary",onClick:Z=>pe(o),disabled:o.status!=="Success"},{default:s(()=>[a(u,null,{default:s(()=>[a(c(P))]),_:1}),e[31]||(e[31]=d(" 下载 "))]),_:2,__:[31]},1032,["onClick","disabled"]),a(p,{size:"small",type:"warning",onClick:Z=>_e(o),disabled:o.status!=="Success"},{default:s(()=>[a(u,null,{default:s(()=>[a(c(Ue))]),_:1}),e[32]||(e[32]=d(" 恢复 "))]),_:2,__:[32]},1032,["onClick","disabled"]),a(p,{size:"small",type:"danger",onClick:Z=>fe(o)},{default:s(()=>[a(u,null,{default:s(()=>[a(c(O))]),_:1}),e[33]||(e[33]=d(" 删除 "))]),_:2,__:[33]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Be,E.value]]),t("div",xa,[a(ye,{"current-page":V.value,"onUpdate:currentPage":e[1]||(e[1]=o=>V.value=o),"page-size":S.value,"onUpdate:pageSize":e[2]||(e[2]=o=>S.value=o),"page-sizes":[10,20,50,100],total:T.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ce,onCurrentChange:re},null,8,["current-page","page-size","total"])])]),w.value.length>0?(x(),I("div",Va,[a(p,{type:"danger",onClick:be},{default:s(()=>e[35]||(e[35]=[d("批量删除")])),_:1,__:[35]}),a(p,{onClick:ve},{default:s(()=>e[36]||(e[36]=[d("批量下载")])),_:1,__:[36]}),t("span",Sa,"已选择 "+r(w.value.length)+" 个备份",1)])):R("",!0),a(Y,{modelValue:j.value,"onUpdate:modelValue":e[4]||(e[4]=o=>j.value=o),title:"备份详情",width:"600px"},{footer:s(()=>[a(p,{onClick:e[3]||(e[3]=o=>j.value=!1)},{default:s(()=>e[45]||(e[45]=[d("关闭")])),_:1,__:[45]})]),default:s(()=>[m.value?(x(),I("div",$a,[t("div",Ma,[e[37]||(e[37]=t("label",null,"备份ID:",-1)),t("span",null,r(m.value.id),1)]),t("div",Da,[e[38]||(e[38]=t("label",null,"文件名:",-1)),t("span",null,r(m.value.filename),1)]),t("div",Ua,[e[39]||(e[39]=t("label",null,"文件大小:",-1)),t("span",null,r(L(m.value.file_size)),1)]),t("div",Aa,[e[40]||(e[40]=t("label",null,"备份时间:",-1)),t("span",null,r(H(m.value.backup_time)),1)]),t("div",Ia,[e[41]||(e[41]=t("label",null,"备份类型:",-1)),a(D,{type:J(m.value.backup_type)},{default:s(()=>[d(r(K(m.value.backup_type)),1)]),_:1},8,["type"])]),t("div",Ea,[e[42]||(e[42]=t("label",null,"状态:",-1)),a(D,{type:X(m.value.status)},{default:s(()=>[d(r(G(m.value.status)),1)]),_:1},8,["type"])]),t("div",Fa,[e[43]||(e[43]=t("label",null,"文件路径:",-1)),t("span",null,r(m.value.file_path),1)]),t("div",Ta,[e[44]||(e[44]=t("label",null,"描述:",-1)),t("div",ja,r(m.value.description),1)])])):R("",!0)]),_:1},8,["modelValue"]),a(Y,{modelValue:C.value,"onUpdate:modelValue":e[10]||(e[10]=o=>C.value=o),title:"自动备份配置",width:"500px"},{footer:s(()=>[a(p,{onClick:e[9]||(e[9]=o=>C.value=!1)},{default:s(()=>e[48]||(e[48]=[d("取消")])),_:1,__:[48]}),a(p,{type:"primary",onClick:me},{default:s(()=>e[49]||(e[49]=[d("保存配置")])),_:1,__:[49]})]),default:s(()=>[a(we,{model:n,"label-width":"120px"},{default:s(()=>[a(U,{label:"启用自动备份"},{default:s(()=>[a(Q,{modelValue:n.enable_auto_backup,"onUpdate:modelValue":e[5]||(e[5]=o=>n.enable_auto_backup=o)},null,8,["modelValue"])]),_:1}),a(U,{label:"备份间隔"},{default:s(()=>[a(W,{modelValue:n.backup_interval_hours,"onUpdate:modelValue":e[6]||(e[6]=o=>n.backup_interval_hours=o),min:1,max:168,placeholder:"小时",disabled:!n.enable_auto_backup},null,8,["modelValue","disabled"]),e[46]||(e[46]=t("span",{class:"config-desc"},"备份间隔时间（小时）",-1))]),_:1,__:[46]}),a(U,{label:"备份位置"},{default:s(()=>[a(he,{modelValue:n.backup_location,"onUpdate:modelValue":e[7]||(e[7]=o=>n.backup_location=o),placeholder:"备份文件存储路径",disabled:!n.enable_auto_backup},null,8,["modelValue","disabled"])]),_:1}),a(U,{label:"最大备份文件"},{default:s(()=>[a(W,{modelValue:n.max_backup_files,"onUpdate:modelValue":e[8]||(e[8]=o=>n.max_backup_files=o),min:1,max:100,placeholder:"个",disabled:!n.enable_auto_backup},null,8,["modelValue","disabled"]),e[47]||(e[47]=t("span",{class:"config-desc"},"保留的最大备份文件数量",-1))]),_:1,__:[47]})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),qa=Ie(La,[["__scopeId","data-v-86d5c3f3"]]);export{qa as default};
