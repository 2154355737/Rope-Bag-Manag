import{u as K,P as Y,U as Z,H as d}from"../chunks/element-plus-hGoKm610.js";import{l as ee,_ as ae}from"../assets/index-C28i2SJl.js";import{u as R}from"../chunks/users-D39iNwN1.js";import{c as se}from"../chunks/categories-BRHoYYyG.js";import{s as S}from"../chunks/subscriptions-Cah8BEmo.js";import{x as le,r as _,X as D,j as te,y as w,Q as l,I as t,J as N,ar as oe,A as s,H as L,al as n,u as A,O as p,M as g,z as m}from"../chunks/vue-vendor-BleHOoLr.js";import"../chunks/utils-Dq7h7Pqt.js";const re={class:"user-profile"},ne={class:"card-header"},ie={class:"profile-display"},de={class:"profile-info"},ue={class:"avatar-section"},ce=["src"],_e={class:"info-section"},me={class:"info-item"},pe={class:"value"},fe={class:"info-item"},ve={class:"value"},ge={class:"info-item"},be={class:"value"},ye={class:"info-item"},he={class:"value highlight"},we={class:"info-item"},ke={class:"value"},Ve={class:"card-header"},Ue={class:"subscription-content"},qe={class:"avatar-upload-section"},Ce=["src"],xe={key:1,class:"avatar-uploader-icon"},Qe={class:"avatar-input"},ze={class:"dialog-footer"},De=le({__name:"UserProfile",setup(Le){const k=_(null),V=_(!1),U=_(!1),q=_(!1),f=_(!1),u=_({}),b=_([]),c=D({}),C=D({}),r=D({nickname:"",qq_number:"",avatar_url:""}),F={nickname:[{required:!0,message:"请输入昵称",trigger:"blur"},{min:2,max:20,message:"昵称长度在 2 到 20 个字符之间",trigger:"blur"}],qq_number:[{pattern:/^\d{5,12}$/,message:"请输入5-12位数字的QQ号",trigger:"blur"}]},E=async()=>{V.value=!0;try{const a=await R.getCurrentUser();a.code===0&&a.data&&(u.value=a.data,r.nickname=a.data.nickname||"",r.qq_number=a.data.qq_number||"",r.avatar_url=a.data.avatar_url||"")}catch(a){console.error("加载用户信息失败:",a),d.error("加载用户信息失败")}finally{V.value=!1}},B=async()=>{U.value=!0;try{const a=await se.getCategories();a.code===0&&(b.value=a.data?.list||[],await $())}catch(a){console.error("加载分类列表失败:",a),d.error("加载分类列表失败")}finally{U.value=!1}},$=async()=>{try{const a=await S.getUserSubscriptions();a.code===0&&a.data&&(Object.assign(c,a.data),b.value.forEach(e=>{c[e.id]===void 0&&(c[e.id]=!1)}))}catch(a){console.error("加载用户订阅状态失败:",a),b.value.forEach(e=>{c[e.id]===void 0&&(c[e.id]=!1)})}},j=async(a,e)=>{C[a]=!0;try{const i=await S.setSubscription({category_id:a,enabled:e});i.code===0?d.success(e?"已订阅":"已取消订阅"):(d.error(i.message||"操作失败"),c[a]=!e)}catch(i){console.error("切换订阅状态失败:",i),d.error("操作失败"),c[a]=!e}finally{C[a]=!1}},H=a=>{const e=a.type.startsWith("image/"),i=a.size/1024/1024<2;if(!e)return d.error("只能上传图片文件!"),!1;if(!i)return d.error("图片大小不能超过 2MB!"),!1;const v=new FileReader;return v.onload=y=>{r.avatar_url=y.target?.result},v.readAsDataURL(a),!1},O=async()=>{if(k.value)try{await k.value.validate(),q.value=!0;const a=await R.updateCurrentUser(r);a.code===0?(d.success("保存成功"),f.value=!1,await E(),await ee()):d.error(a.message||a.msg||"保存失败")}catch(a){console.error("保存个人信息失败:",a),d.error("保存失败")}finally{q.value=!1}},T=a=>a?new Date(a).toLocaleDateString("zh-CN"):"未知";return te(()=>{E(),B()}),(a,e)=>{const i=n("el-button"),v=n("el-avatar"),y=n("el-icon"),M=n("el-card"),h=n("el-table-column"),J=n("el-tag"),W=n("el-switch"),X=n("el-table"),x=n("el-input"),Q=n("el-form-item"),G=n("el-upload"),I=n("el-dialog"),P=oe("loading");return m(),w("div",re,[l(M,{shadow:"hover",class:"profile-card"},{header:t(()=>[s("div",ne,[e[7]||(e[7]=s("h3",null,"个人信息",-1)),l(i,{type:"primary",size:"small",onClick:e[0]||(e[0]=o=>f.value=!0)},{default:t(()=>e[6]||(e[6]=[g("编辑信息")])),_:1,__:[6]})])]),default:t(()=>[N((m(),w("div",ie,[s("div",de,[s("div",ue,[u.value.avatar_url?(m(),L(v,{key:0,size:80,src:u.value.avatar_url},{default:t(()=>[s("img",{src:u.value.avatar_url},null,8,ce)]),_:1},8,["src"])):(m(),L(v,{key:1,size:80},{default:t(()=>[l(y,null,{default:t(()=>[l(A(K))]),_:1})]),_:1}))]),s("div",_e,[s("div",me,[e[8]||(e[8]=s("span",{class:"label"},"用户名：",-1)),s("span",pe,p(u.value.username||"未设置"),1)]),s("div",fe,[e[9]||(e[9]=s("span",{class:"label"},"昵称：",-1)),s("span",ve,p(u.value.nickname||"未设置"),1)]),s("div",ge,[e[10]||(e[10]=s("span",{class:"label"},"QQ号：",-1)),s("span",be,p(u.value.qq_number||"未设置"),1)]),s("div",ye,[e[11]||(e[11]=s("span",{class:"label"},"积分：",-1)),s("span",he,p(u.value.star||0),1)]),s("div",we,[e[12]||(e[12]=s("span",{class:"label"},"注册时间：",-1)),s("span",ke,p(T(u.value.created_at)),1)])])])])),[[P,V.value]])]),_:1}),l(M,{shadow:"hover",class:"subscription-card"},{header:t(()=>[s("div",Ve,[e[14]||(e[14]=s("h3",null,"资源订阅",-1)),l(i,{type:"text",size:"small",onClick:B},{default:t(()=>e[13]||(e[13]=[g("刷新")])),_:1,__:[13]})])]),default:t(()=>[s("div",Ue,[e[15]||(e[15]=s("p",{class:"subscription-desc"},"订阅您感兴趣的资源分类，我们会在有新资源时通知您。",-1)),N((m(),L(X,{data:b.value,style:{width:"100%"}},{default:t(()=>[l(h,{prop:"name",label:"分类名称"}),l(h,{prop:"description",label:"分类描述","show-overflow-tooltip":""}),l(h,{label:"资源数量",width:"100"},{default:t(({row:o})=>[l(J,{size:"small"},{default:t(()=>[g(p(o.count||0),1)]),_:2},1024)]),_:1}),l(h,{label:"订阅状态",width:"100"},{default:t(({row:o})=>[l(W,{modelValue:c[o.id],"onUpdate:modelValue":z=>c[o.id]=z,onChange:z=>j(o.id,z),loading:C[o.id]},null,8,["modelValue","onUpdate:modelValue","onChange","loading"])]),_:1})]),_:1},8,["data"])),[[P,U.value]])])]),_:1}),l(I,{modelValue:f.value,"onUpdate:modelValue":e[5]||(e[5]=o=>f.value=o),title:"编辑个人信息",width:"500px"},{footer:t(()=>[s("div",ze,[l(i,{onClick:e[4]||(e[4]=o=>f.value=!1)},{default:t(()=>e[17]||(e[17]=[g("取消")])),_:1,__:[17]}),l(i,{type:"primary",onClick:O,loading:q.value},{default:t(()=>e[18]||(e[18]=[g("保存")])),_:1,__:[18]},8,["loading"])])]),default:t(()=>[l(A(Y),{model:r,rules:F,ref_key:"formRef",ref:k,"label-width":"90px"},{default:t(()=>[l(Q,{label:"昵称",prop:"nickname"},{default:t(()=>[l(x,{modelValue:r.nickname,"onUpdate:modelValue":e[1]||(e[1]=o=>r.nickname=o),placeholder:"请输入昵称"},null,8,["modelValue"])]),_:1}),l(Q,{label:"QQ号",prop:"qq_number"},{default:t(()=>[l(x,{modelValue:r.qq_number,"onUpdate:modelValue":e[2]||(e[2]=o=>r.qq_number=o),placeholder:"请输入QQ号"},null,8,["modelValue"])]),_:1}),l(Q,{label:"头像",prop:"avatar_url"},{default:t(()=>[s("div",qe,[l(G,{class:"avatar-uploader",action:"","show-file-list":!1,"before-upload":H,accept:"image/*"},{default:t(()=>[r.avatar_url?(m(),w("img",{key:0,src:r.avatar_url,class:"avatar-preview"},null,8,Ce)):(m(),w("div",xe,[l(y,null,{default:t(()=>[l(A(Z))]),_:1}),e[16]||(e[16]=s("span",null,"上传头像",-1))]))]),_:1}),s("div",Qe,[l(x,{modelValue:r.avatar_url,"onUpdate:modelValue":e[3]||(e[3]=o=>r.avatar_url=o),placeholder:"或粘贴头像图片URL",clearable:""},null,8,["modelValue"])])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Ne=ae(De,[["__scopeId","data-v-64ad24dc"]]);export{Ne as default};
