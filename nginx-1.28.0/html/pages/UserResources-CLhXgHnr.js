import{x as Ae,r as V,X as E,c as M,j as ze,y as v,A as n,Q as t,I as a,M as p,al as r,u as y,O as c,a4 as te,J as Pe,ar as Se,K as z,P,a6 as S,H as x,z as i}from"../chunks/vue-vendor-BleHOoLr.js";import{o as Fe,af as $e,F as le,f as ae,a2 as J,C as De,A as Ee,K as m,E as Me}from"../chunks/element-plus-Cc1YNc_4.js";import{p as Q}from"../chunks/packages-DTwnlaPG.js";import{g as Te,u as oe,_ as je}from"../assets/index-B_N-aWSj.js";import{u as Be}from"../chunks/users-C4D58Onb.js";import{c as Ne}from"../chunks/categories-BGQr79qD.js";import{c as Ke}from"../chunks/posts-B23axQf4.js";import"../chunks/utils-Dq7h7Pqt.js";const Le={class:"user-resource-manage"},qe={class:"page-header"},Oe={class:"header-content"},He={class:"stat-content"},Je={class:"stat-icon"},Qe={class:"stat-info"},Xe={class:"stat-number"},Ge={class:"stat-content"},We={class:"stat-icon"},Ye={class:"stat-info"},Ze={class:"stat-number"},et={class:"stat-content"},tt={class:"stat-icon"},lt={class:"stat-info"},at={class:"stat-number"},ot={class:"stat-content"},st={class:"stat-icon"},nt={class:"stat-info"},dt={class:"stat-number"},rt={key:0,class:"empty-state"},it={key:1,class:"resource-grid"},ut={class:"resource-header"},pt=["onClick"],ct={class:"resource-info"},mt={class:"info-item"},_t={class:"value"},gt={class:"info-item"},ft={class:"value"},vt={class:"info-item"},yt={class:"resource-description"},bt={class:"resource-stats"},Vt={class:"stat-item"},kt={class:"stat-item"},wt={class:"stat-item"},ht={key:2,class:"pagination-wrapper"},Ct={class:"tags-container"},Ut={class:"dialog-footer"},xt={key:0,class:"tags-display"},It={class:"dialog-footer"},Rt=Ae({__name:"UserResources",setup(At){const T=V(null),j=V(null),F=V(!1),B=V(!1),N=V(!1),h=V(!1),R=V(!1),X=Te(),C=V([]),A=V([]),K=V(null),k=E({page:1,pageSize:12,total:0}),w=E({status:"",search:""}),s=E({type:"package",name:"",author:X?.username||"",version:"",description:"",category_id:void 0,file_url:"",tags:[],tagsInput:""}),d=E({name:"",version:"",tagsInput:"",description:"",category_id:void 0,file_url:""}),G={name:[{required:!0,message:"请输入标题",trigger:"blur"},{min:2,max:50,message:"标题长度在 2 到 50 个字符之间",trigger:"blur"}],author:[{required:!0,message:"请输入作者名称",trigger:"blur"}],description:[{required:!0,message:"请输入内容",trigger:"blur"},{min:10,max:500,message:"内容长度在 10 到 500 个字符之间",trigger:"blur"}],file_url:[{pattern:/^https?:\/\/.+/,message:"请输入有效的URL地址",trigger:"blur"}]},L=M(()=>C.value.length),se=M(()=>C.value.filter(o=>o.status==="Active").length),ne=M(()=>C.value.filter(o=>o.status==="Pending").length),de=M(()=>C.value.reduce((o,e)=>o+e.download_count,0)),b=async()=>{F.value=!0;try{const o={page:k.page,pageSize:k.pageSize,status:w.status||void 0};console.log("📤 加载用户资源参数:",o);const e=await Be.getMyResources(o);e.code===0?(console.log("✅ 用户资源加载成功:",e.data),C.value=e.data?.list||[],k.total=e.data?.total||0):(console.warn("❌ 用户资源加载失败:",e),m.error(e.message||"加载资源失败"))}catch(o){console.error("🚫 加载资源列表失败:",o),m.error("加载资源列表失败")}finally{F.value=!1}},re=()=>{w.status="",w.search="",k.page=1,b()},ie=(o,e)=>{switch(o){case"edit":ue(e);break;case"view":window.open(`/resource/${e.id}`,"_blank");break;case"delete":ve(e);break}},ue=o=>{K.value=o,d.name=o.name,d.version=o.version||"",d.description=o.description||"",d.category_id=o.category_id||void 0,d.file_url=o.file_url,d.tags=o.tags||[],d.tagsInput=(o.tags||[]).join(", "),d.is_pinned=o.is_pinned||!1,d.is_featured=o.is_featured||!1,R.value=!0},pe=()=>{if(d.tagsInput){const o=d.tagsInput.split(",").map(e=>e.trim()).filter(e=>e);d.tags=o}else d.tags=[]},ce=o=>{d.tags&&(d.tags=d.tags.filter(e=>e!==o),d.tagsInput=d.tags.join(", "))},me=()=>{const o=s.tagsInput?.trim();o&&o.length>0&&!s.tags.includes(o)&&(s.tags.push(o),s.tagsInput="")},_e=o=>{const e=s.tags.indexOf(o);e>-1&&s.tags.splice(e,1)},ge=async()=>{if(T.value)try{if(s.type==="package"&&!s.file_url){m.error("请填写文件链接");return}if(await T.value.validate(),B.value=!0,s.type==="package"){const o=s.category_id?A.value.find(g=>g.id===s.category_id)?.name:void 0,e={name:s.name,author:"User",description:s.description,category_id:s.category_id,tags:s.tags,file_url:s.file_url||""};console.log("📤 普通用户提交资源数据:",e);const _=await Q.userSubmitResource(e);_.code===0?(m.success("资源上传成功，等待审核"),oe.logUpload("Package",_.data?.id||0,`上传资源: ${s.name}`).catch(g=>console.error("记录上传行为失败:",g)),h.value=!1,W(),b()):m.error(_.message||"上传失败")}else{const o=await Ke({title:s.name,content:s.description,category_id:s.category_id,tags:s.tags,status:"Published"});o.code===0?(m.success("帖子发布成功"),oe.logAction("Create",`创建帖子: ${s.name}`,"Post",o.data?.post_id||0).catch(e=>console.error("记录创建帖子行为失败:",e)),h.value=!1,W(),b()):m.error(o.msg||"发布失败")}}catch(o){console.error("提交失败:",o),m.error(s.type==="package"?"上传失败":"发布失败")}finally{B.value=!1}},fe=async()=>{if(!(!j.value||!K.value))try{await j.value.validate(),N.value=!0;const o=await Q.updatePackage(K.value.id,d);o.code===0?(m.success("资源更新成功"),R.value=!1,b()):m.error(o.message||"更新失败")}catch(o){console.error("更新资源失败:",o),m.error("更新失败")}finally{N.value=!1}},ve=async o=>{try{await Me.confirm(`确定要删除资源 "${o.name}" 吗？此操作不可恢复。`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await Q.deletePackage(o.id);e.code===0?(m.success("删除成功"),b()):m.error(e.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除资源失败:",e),m.error("删除失败"))}},W=()=>{Object.assign(s,{type:"package",name:"",author:X?.username||"",version:"",description:"",category_id:void 0,file_url:"",tags:[],tagsInput:""})},ye=o=>({Active:"success",Pending:"warning",Rejected:"danger",Inactive:"info"})[o]||"info",be=o=>({Active:"已发布",Pending:"审核中",Rejected:"已拒绝",Inactive:"已下架"})[o]||o,Ve=o=>new Date(o).toLocaleDateString("zh-CN"),ke=async()=>{try{console.log("正在加载分类数据...");const o=await Ne.getCategories();console.log("分类API响应:",o),o.code===0&&o.data?(A.value=Array.isArray(o.data)?o.data:o.data.list||[],console.log("加载到的分类:",A.value)):console.error("分类API返回错误:",o)}catch(o){console.error("加载分类失败:",o)}};return ze(()=>{ke(),b()}),(o,e)=>{const _=r("el-button"),g=r("el-icon"),I=r("el-card"),$=r("el-col"),we=r("el-row"),U=r("el-option"),q=r("el-select"),u=r("el-form-item"),f=r("el-input"),he=r("el-empty"),O=r("el-dropdown-item"),Ce=r("el-dropdown-menu"),Ue=r("el-dropdown"),H=r("el-tag"),xe=r("el-pagination"),Y=r("el-radio"),Ie=r("el-radio-group"),Z=r("el-dialog"),ee=r("el-checkbox"),Re=Se("loading");return i(),v("div",Le,[n("div",qe,[n("div",Oe,[e[27]||(e[27]=n("h2",null,"我的内容",-1)),t(_,{type:"primary",icon:"Plus",onClick:e[0]||(e[0]=l=>h.value=!0)},{default:a(()=>e[26]||(e[26]=[p(" 提交内容 ")])),_:1,__:[26]})])]),t(we,{gutter:20,class:"stats-row"},{default:a(()=>[t($,{span:6},{default:a(()=>[t(I,{shadow:"hover",class:"stat-card"},{default:a(()=>[n("div",He,[n("div",Je,[t(g,{color:"#409EFF"},{default:a(()=>[t(y(Fe))]),_:1})]),n("div",Qe,[n("div",Xe,c(L.value),1),e[28]||(e[28]=n("div",{class:"stat-label"},"总内容数",-1))])])]),_:1})]),_:1}),t($,{span:6},{default:a(()=>[t(I,{shadow:"hover",class:"stat-card"},{default:a(()=>[n("div",Ge,[n("div",We,[t(g,{color:"#67C23A"},{default:a(()=>[t(y($e))]),_:1})]),n("div",Ye,[n("div",Ze,c(se.value),1),e[29]||(e[29]=n("div",{class:"stat-label"},"已发布",-1))])])]),_:1})]),_:1}),t($,{span:6},{default:a(()=>[t(I,{shadow:"hover",class:"stat-card"},{default:a(()=>[n("div",et,[n("div",tt,[t(g,{color:"#E6A23C"},{default:a(()=>[t(y(le))]),_:1})]),n("div",lt,[n("div",at,c(ne.value),1),e[30]||(e[30]=n("div",{class:"stat-label"},"审核中",-1))])])]),_:1})]),_:1}),t($,{span:6},{default:a(()=>[t(I,{shadow:"hover",class:"stat-card"},{default:a(()=>[n("div",ot,[n("div",st,[t(g,{color:"#F56C6C"},{default:a(()=>[t(y(ae))]),_:1})]),n("div",nt,[n("div",dt,c(de.value),1),e[31]||(e[31]=n("div",{class:"stat-label"},"总下载量",-1))])])]),_:1})]),_:1})]),_:1}),t(I,{shadow:"hover",class:"filter-card"},{default:a(()=>[t(y(J),{model:w,inline:!0,class:"search-form"},{default:a(()=>[t(u,{label:"状态筛选:"},{default:a(()=>[t(q,{modelValue:w.status,"onUpdate:modelValue":e[1]||(e[1]=l=>w.status=l),placeholder:"全部状态",clearable:"",style:{width:"120px"}},{default:a(()=>[t(U,{label:"全部",value:""}),t(U,{label:"已发布",value:"Active"}),t(U,{label:"审核中",value:"Pending"}),t(U,{label:"已拒绝",value:"Rejected"}),t(U,{label:"已下架",value:"Inactive"})]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"搜索:"},{default:a(()=>[t(f,{modelValue:w.search,"onUpdate:modelValue":e[2]||(e[2]=l=>w.search=l),placeholder:"输入资源名称",clearable:"",style:{width:"200px"},onKeyup:te(b,["enter"])},null,8,["modelValue"])]),_:1}),t(u,null,{default:a(()=>[t(_,{type:"primary",icon:"Search",onClick:b},{default:a(()=>e[32]||(e[32]=[p("搜索")])),_:1,__:[32]}),t(_,{icon:"Refresh",onClick:re},{default:a(()=>e[33]||(e[33]=[p("重置")])),_:1,__:[33]})]),_:1})]),_:1},8,["model"])]),_:1}),t(I,{shadow:"hover",class:"resource-list-card"},{default:a(()=>[Pe((i(),v("div",null,[C.value.length===0&&!F.value?(i(),v("div",rt,[t(he,{description:"还没有提交任何内容"},{default:a(()=>[t(_,{type:"primary",onClick:e[3]||(e[3]=l=>h.value=!0)},{default:a(()=>e[34]||(e[34]=[p(" 立即提交 ")])),_:1,__:[34]})]),_:1})])):(i(),v("div",it,[(i(!0),v(P,null,S(C.value,l=>(i(),v("div",{key:l.id,class:"resource-card"},[n("div",ut,[n("div",{class:"resource-title",onClick:D=>o.$router.push(`/resource/${l.id}`)},c(l.name),9,pt),t(Ue,{onCommand:D=>ie(D,l)},{dropdown:a(()=>[t(Ce,null,{default:a(()=>[t(O,{command:"edit"},{default:a(()=>e[35]||(e[35]=[p("编辑")])),_:1,__:[35]}),t(O,{command:"view"},{default:a(()=>e[36]||(e[36]=[p("查看")])),_:1,__:[36]}),t(O,{command:"delete",divided:""},{default:a(()=>e[37]||(e[37]=[p("删除")])),_:1,__:[37]})]),_:1})]),default:a(()=>[t(_,{link:"",size:"small"},{default:a(()=>[t(g,null,{default:a(()=>[t(y(De))]),_:1})]),_:1})]),_:2},1032,["onCommand"])]),n("div",ct,[n("div",mt,[e[38]||(e[38]=n("span",{class:"label"},"作者:",-1)),n("span",_t,c(l.author),1)]),n("div",gt,[e[39]||(e[39]=n("span",{class:"label"},"版本:",-1)),n("span",ft,c(l.version||"未设置"),1)]),n("div",vt,[e[40]||(e[40]=n("span",{class:"label"},"状态:",-1)),t(H,{type:ye(l.status),size:"small"},{default:a(()=>[p(c(be(l.status)),1)]),_:2},1032,["type"])])]),n("div",yt,c(l.description||"暂无描述"),1),n("div",bt,[n("div",Vt,[t(g,null,{default:a(()=>[t(y(ae))]),_:1}),n("span",null,c(l.download_count),1)]),n("div",kt,[t(g,null,{default:a(()=>[t(y(Ee))]),_:1}),n("span",null,c(l.like_count||0),1)]),n("div",wt,[t(g,null,{default:a(()=>[t(y(le))]),_:1}),n("span",null,c(Ve(l.created_at)),1)])])]))),128))])),L.value>0?(i(),v("div",ht,[t(xe,{"current-page":k.page,"onUpdate:currentPage":e[4]||(e[4]=l=>k.page=l),"page-size":k.pageSize,"onUpdate:pageSize":e[5]||(e[5]=l=>k.pageSize=l),"page-sizes":[10,20,50],total:L.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:b,onCurrentChange:b},null,8,["current-page","page-size","total"])])):z("",!0)])),[[Re,F.value]])]),_:1}),t(Z,{modelValue:h.value,"onUpdate:modelValue":e[15]||(e[15]=l=>h.value=l),title:"提交内容",width:"600px","close-on-click-modal":!1},{footer:a(()=>[n("div",Ut,[t(_,{onClick:e[14]||(e[14]=l=>h.value=!1)},{default:a(()=>e[43]||(e[43]=[p("取消")])),_:1,__:[43]}),t(_,{type:"primary",onClick:ge,loading:B.value},{default:a(()=>[p(c(s.type==="package"?"提交资源":"发布帖子"),1)]),_:1},8,["loading"])])]),default:a(()=>[t(y(J),{model:s,rules:G,ref_key:"uploadFormRef",ref:T,"label-width":"80px"},{default:a(()=>[t(u,{label:"内容类型"},{default:a(()=>[t(Ie,{modelValue:s.type,"onUpdate:modelValue":e[6]||(e[6]=l=>s.type=l)},{default:a(()=>[t(Y,{label:"package"},{default:a(()=>e[41]||(e[41]=[p("资源")])),_:1,__:[41]}),t(Y,{label:"post"},{default:a(()=>e[42]||(e[42]=[p("帖子")])),_:1,__:[42]})]),_:1},8,["modelValue"])]),_:1}),t(u,{label:s.type==="package"?"资源名称":"帖子标题",prop:"name"},{default:a(()=>[t(f,{modelValue:s.name,"onUpdate:modelValue":e[7]||(e[7]=l=>s.name=l),placeholder:s.type==="package"?"请输入资源名称":"请输入帖子标题"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),s.type==="package"?(i(),x(u,{key:0,label:"作者",prop:"author"},{default:a(()=>[t(f,{modelValue:s.author,"onUpdate:modelValue":e[8]||(e[8]=l=>s.author=l),placeholder:"当前用户",disabled:""},null,8,["modelValue"])]),_:1})):z("",!0),s.type==="package"?(i(),x(u,{key:1,label:"版本",prop:"version"},{default:a(()=>[t(f,{modelValue:s.version,"onUpdate:modelValue":e[9]||(e[9]=l=>s.version=l),placeholder:"请输入版本号（可选）"},null,8,["modelValue"])]),_:1})):z("",!0),t(u,{label:s.type==="package"?"资源分类":"帖子分类",prop:"category_id"},{default:a(()=>[t(q,{modelValue:s.category_id,"onUpdate:modelValue":e[10]||(e[10]=l=>s.category_id=l),placeholder:s.type==="package"?"请选择资源分类":"请选择帖子分类",style:{width:"100%"}},{default:a(()=>[(i(!0),v(P,null,S(A.value,l=>(i(),x(U,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),t(u,{label:s.type==="package"?"资源描述":"帖子内容",prop:"description"},{default:a(()=>[t(f,{modelValue:s.description,"onUpdate:modelValue":e[11]||(e[11]=l=>s.description=l),type:"textarea",rows:4,placeholder:s.type==="package"?"请输入资源描述":"请输入帖子内容"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),t(u,{label:"标签"},{default:a(()=>[t(f,{modelValue:s.tagsInput,"onUpdate:modelValue":e[12]||(e[12]=l=>s.tagsInput=l),placeholder:"输入标签，用逗号分隔",onKeyup:te(me,["enter"]),clearable:""},null,8,["modelValue"]),n("div",Ct,[(i(!0),v(P,null,S(s.tags,l=>(i(),x(H,{key:l,closable:"",onClose:D=>_e(l),effect:"light"},{default:a(()=>[p(c(l),1)]),_:2},1032,["onClose"]))),128))])]),_:1}),s.type==="package"?(i(),x(u,{key:2,label:"文件链接",prop:"file_url"},{default:a(()=>[t(f,{modelValue:s.file_url,"onUpdate:modelValue":e[13]||(e[13]=l=>s.file_url=l),placeholder:"请输入文件下载链接"},null,8,["modelValue"])]),_:1})):z("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Z,{modelValue:R.value,"onUpdate:modelValue":e[25]||(e[25]=l=>R.value=l),title:"编辑资源",width:"600px","close-on-click-modal":!1},{footer:a(()=>[n("div",It,[t(_,{onClick:e[24]||(e[24]=l=>R.value=!1)},{default:a(()=>e[46]||(e[46]=[p("取消")])),_:1,__:[46]}),t(_,{type:"primary",onClick:fe,loading:N.value},{default:a(()=>e[47]||(e[47]=[p(" 保存修改 ")])),_:1,__:[47]},8,["loading"])])]),default:a(()=>[t(y(J),{model:d,rules:G,ref_key:"editFormRef",ref:j,"label-width":"80px"},{default:a(()=>[t(u,{label:"资源名称",prop:"name"},{default:a(()=>[t(f,{modelValue:d.name,"onUpdate:modelValue":e[16]||(e[16]=l=>d.name=l),placeholder:"请输入资源名称"},null,8,["modelValue"])]),_:1}),t(u,{label:"版本",prop:"version"},{default:a(()=>[t(f,{modelValue:d.version,"onUpdate:modelValue":e[17]||(e[17]=l=>d.version=l),placeholder:"请输入版本号（可选）"},null,8,["modelValue"])]),_:1}),t(u,{label:"分类",prop:"category_id"},{default:a(()=>[t(q,{modelValue:d.category_id,"onUpdate:modelValue":e[18]||(e[18]=l=>d.category_id=l),placeholder:"请选择分类",style:{width:"100%"}},{default:a(()=>[(i(!0),v(P,null,S(A.value,l=>(i(),x(U,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"资源描述",prop:"description"},{default:a(()=>[t(f,{modelValue:d.description,"onUpdate:modelValue":e[19]||(e[19]=l=>d.description=l),type:"textarea",rows:4,placeholder:"请输入资源描述"},null,8,["modelValue"])]),_:1}),t(u,{label:"文件链接",prop:"file_url"},{default:a(()=>[t(f,{modelValue:d.file_url,"onUpdate:modelValue":e[20]||(e[20]=l=>d.file_url=l),placeholder:"请输入文件下载链接"},null,8,["modelValue"])]),_:1}),t(u,{label:"标签",prop:"tags"},{default:a(()=>[t(f,{modelValue:d.tagsInput,"onUpdate:modelValue":e[21]||(e[21]=l=>d.tagsInput=l),placeholder:"请输入标签，用逗号分隔",onInput:pe},null,8,["modelValue"]),d.tags&&d.tags.length>0?(i(),v("div",xt,[(i(!0),v(P,null,S(d.tags,l=>(i(),x(H,{key:l,closable:"",onClose:D=>ce(l),style:{margin:"4px 4px 0 0"}},{default:a(()=>[p(c(l),1)]),_:2},1032,["onClose"]))),128))])):z("",!0)]),_:1}),t(u,{label:"状态设置"},{default:a(()=>[t(ee,{modelValue:d.is_pinned,"onUpdate:modelValue":e[22]||(e[22]=l=>d.is_pinned=l)},{default:a(()=>e[44]||(e[44]=[p("置顶")])),_:1,__:[44]},8,["modelValue"]),t(ee,{modelValue:d.is_featured,"onUpdate:modelValue":e[23]||(e[23]=l=>d.is_featured=l)},{default:a(()=>e[45]||(e[45]=[p("精华")])),_:1,__:[45]},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Tt=je(Rt,[["__scopeId","data-v-dcdc08ca"]]);export{Tt as default};
