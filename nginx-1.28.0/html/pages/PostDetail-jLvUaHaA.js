import{r as m,c as w,x as De,X as Le,ay as Te,j as Ie,y as c,A as t,Q as s,I as a,M as u,al as v,u as d,H as V,K as g,P as $,O as p,a6 as Q,D as Ue,J as Pe,a4 as Me,V as Ae,ar as Ee,ax as Be,z as r}from"../chunks/vue-vendor-BleHOoLr.js";import{N as Re,u as A,w as $e,k as He,A as X,B as Ke,D as Ne,j as Z,Z as Se,U as ae,_ as Fe,K as _,E as Ye}from"../chunks/element-plus-Cc1YNc_4.js";import{c as G}from"../chunks/comments-CGKKo5_6.js";import{g as je,i as qe,c as Je,_ as Oe}from"../assets/index-B_N-aWSj.js";import{a as Qe,b as Xe,u as Ze,d as Ge}from"../chunks/posts-B23axQf4.js";import{a as We}from"../chunks/tags-BVMB1T7b.js";import{f as et}from"../chunks/format-CUgNVY1-.js";import"../chunks/utils-Dq7h7Pqt.js";function tt(){const x=m(je()),z=m(qe()),H=w(()=>z.value),k=w(()=>x.value),E=C=>{x.value=C,z.value=!!C},l=()=>{Je(),x.value=null,z.value=!1},b=C=>x.value?.role===C,I=w(()=>b("admin")),B=w(()=>b("elder")),U=w(()=>b("moderator"));return{user:x,isAuthenticated:z,isLoggedIn:H,currentUser:k,updateUser:E,logout:l,hasRole:b,isAdmin:I,isElder:B,isModerator:U}}const st={class:"post-detail-container"},ot={class:"top-header"},at={class:"header-wrapper"},lt={class:"header-left"},nt={class:"header-center"},rt={class:"header-right"},it={class:"header-actions"},dt={key:1,class:"user-menu"},ut={class:"user-trigger"},ct={class:"main-content"},_t={class:"content-container"},mt={key:0,class:"loading-state"},vt={class:"glass-panel"},pt={class:"post-main-card glass-panel"},ft={class:"post-header"},gt={class:"post-title-section"},yt={class:"title-row"},ht={class:"post-title"},kt={class:"status-badges"},wt={class:"post-meta-section"},bt={class:"author-info"},Ct={class:"author-details"},Vt={class:"author-name"},zt={class:"post-time"},xt={class:"post-stats"},Dt={class:"stat-item"},Lt={class:"stat-value"},Tt={class:"stat-item"},It={class:"stat-value"},Ut={class:"stat-item"},Pt={class:"stat-value"},Mt={key:0,class:"post-tags"},At={class:"post-body"},Et={class:"content-wrapper"},Bt=["innerHTML"],Rt={key:0,class:"post-actions"},$t={class:"action-group primary-actions"},Ht={class:"action-count"},Kt={class:"action-count"},Nt={key:0,class:"action-group secondary-actions"},St={class:"comments-section glass-panel"},Ft={class:"section-header"},Yt={class:"section-title"},jt={class:"comment-count"},qt={class:"comment-form-container"},Jt={key:0,class:"comment-form glass-inner"},Ot={class:"comment-input-wrapper"},Qt={class:"form-actions"},Xt={class:"comment-tip"},Zt={key:1,class:"login-prompt glass-inner"},Gt={class:"prompt-content"},Wt={class:"comments-list"},es={key:0,class:"empty-comments"},ts={key:1,class:"comment-items"},ss={class:"comment-header"},os={class:"comment-author-section"},as={class:"comment-meta"},ls={class:"author-info"},ns={class:"comment-author-name"},rs={class:"comment-time"},is={key:0,class:"comment-actions"},ds={class:"comment-content"},us={class:"dialog-footer"},cs=De({__name:"PostDetail",setup(x){const z=o=>et(o,"YYYY-MM-DD HH:mm"),H=Te(),k=Be(),E=tt(),l=m(),b=m([]),I=m([]),B=m([]),U=m(!1),C=m(!1),K=m(!1),D=m(!1),N=m(!1),S=m(!1),F=m(),L=m(""),P=m(!1),Y=m(),y=Le({title:"",content:"",tags:[]}),le={title:[{required:!0,message:"请输入标题",trigger:"blur"},{min:1,max:200,message:"标题长度在 1 到 200 个字符",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"},{min:10,message:"内容至少 10 个字符",trigger:"blur"}]},M=w(()=>E.isLoggedIn),f=w(()=>E.currentUser),T=w(()=>parseInt(H.params.id)),W=w(()=>!l.value||!f.value.value?!1:l.value.author_id===f.value.value?.id||f.value.value?.role==="admin"||f.value.value?.role==="elder"),ee=w(()=>!l.value||!f.value.value?!1:l.value.author_id===f.value.value?.id||f.value.value?.role==="admin"),te=async()=>{U.value=!0;try{const o=await Qe(T.value);o.code===0&&o.data?(l.value=o.data,ne(),j()):(_.error("帖子不存在"),k.push("/posts"))}catch(o){console.error("加载帖子失败:",o),_.error("加载帖子失败")}finally{U.value=!1}},ne=async()=>{try{const o=await Xe(T.value);o.code===0&&o.data&&(b.value=o.data)}catch(o){console.error("加载标签失败:",o)}},j=async()=>{C.value=!0;try{const o=await G.getPostComments(T.value);o.code===0&&o.data&&(I.value=o.data.list)}catch(o){console.error("加载评论失败:",o)}finally{C.value=!1}},re=async()=>{try{const o=await We();o.code===0&&o.data&&(B.value=o.data)}catch(o){console.error("加载所有标签失败:",o)}},ie=o=>o.replace(/\n/g,"<br>"),de=async()=>{if(!M.value){_.warning("请先登录");return}K.value=!0;try{D.value=!D.value,l.value&&(l.value.like_count+=D.value?1:-1),_.success(D.value?"点赞成功":"取消点赞成功")}catch(o){console.error("点赞失败:",o),_.error("操作失败")}finally{K.value=!1}},ue=()=>{F.value&&F.value.focus()},se=async()=>{if(L.value.trim()){N.value=!0;try{const o=await G.createComment({target_type:"Post",target_id:T.value,content:L.value});o.code===0?(_.success("评论发表成功"),L.value="",j(),l.value&&l.value.comment_count++):_.error(o.msg||o.message||"评论发表失败")}catch(o){console.error("发表评论失败:",o),_.error("发表评论失败")}finally{N.value=!1}}},ce=()=>{l.value&&(y.title=l.value.title,y.content=l.value.content,y.tags=b.value.map(o=>o.name),P.value=!0)},_e=async()=>{if(Y.value)try{await Y.value.validate(),S.value=!0;const o=await Ze(T.value,y);o.code===0?(_.success("帖子更新成功"),P.value=!1,te()):_.error(o.msg||"更新失败")}catch(o){console.error("更新帖子失败:",o),_.error("更新帖子失败")}finally{S.value=!1}},me=()=>{Ye.confirm("确定要删除这个帖子吗？删除后无法恢复。","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const o=await Ge(T.value);o.code===0?(_.success("帖子删除成功"),k.push("/posts")):_.error(o.msg||"删除失败")}catch(o){console.error("删除帖子失败:",o),_.error("删除帖子失败")}})},ve=async o=>{try{const e=await G.deleteComment(o);e.code===0?(_.success("评论删除成功"),j(),l.value&&l.value.comment_count--):_.error(e.msg||e.message||"删除失败")}catch(e){console.error("删除评论失败:",e),_.error("删除评论失败")}},pe=o=>f.value.value?o.user_id===f.value.value?.id||f.value.value?.role==="admin"||f.value.value?.role==="elder":!1,oe=()=>{k.push("/login")},fe=()=>{const o=f.value.value;if(!o){k.push("/login");return}o.role==="admin"||o.role==="moderator"?k.push("/admin"):o.role==="elder"?k.push("/elder"):o.role==="user"?k.push("/user"):k.push("/403")};return Ie(()=>{te(),re()}),(o,e)=>{const i=v("el-icon"),h=v("el-button"),q=v("el-avatar"),ge=v("el-dropdown-item"),ye=v("el-dropdown-menu"),he=v("el-dropdown"),ke=v("el-skeleton"),R=v("el-tag"),J=v("el-input"),we=v("el-empty"),O=v("el-form-item"),be=v("el-option"),Ce=v("el-select"),Ve=v("el-form"),ze=v("el-dialog"),xe=Ee("loading");return r(),c("div",st,[e[30]||(e[30]=t("div",{class:"background-layer"},[t("div",{class:"gradient-bg"}),t("div",{class:"pattern-overlay"})],-1)),t("header",ot,[t("div",at,[t("div",lt,[t("div",{class:"brand",onClick:e[0]||(e[0]=n=>o.$router.push("/home"))},e[8]||(e[8]=[t("div",{class:"brand-icon"},"🏘️",-1),t("div",{class:"brand-text"},[t("h1",null,"智圆社区"),t("span",null,"分享、发现、学习")],-1)]))]),t("div",nt,[s(h,{onClick:e[1]||(e[1]=n=>o.$router.push("/home")),type:"primary",plain:"",class:"back-btn"},{default:a(()=>[s(i,null,{default:a(()=>[s(d(Re))]),_:1}),e[9]||(e[9]=u(" 返回首页 "))]),_:1,__:[9]})]),t("div",rt,[t("div",it,[M.value?g("",!0):(r(),V(h,{key:0,type:"primary",size:"default",onClick:oe},{default:a(()=>[s(i,null,{default:a(()=>[s(d(A))]),_:1}),e[10]||(e[10]=u(" 登录 "))]),_:1,__:[10]})),M.value?(r(),c("div",dt,[s(he,{trigger:"click",placement:"bottom-end"},{dropdown:a(()=>[s(ye,null,{default:a(()=>[s(ge,{onClick:fe},{default:a(()=>[s(i,null,{default:a(()=>[s(d(He))]),_:1}),e[11]||(e[11]=u(" 管理后台 "))]),_:1,__:[11]})]),_:1})]),default:a(()=>[t("div",ut,[s(q,{size:32},{default:a(()=>[s(i,null,{default:a(()=>[s(d(A))]),_:1})]),_:1}),s(i,{class:"dropdown-arrow"},{default:a(()=>[s(d($e))]),_:1})])]),_:1})])):g("",!0)])])])]),t("main",ct,[t("div",_t,[U.value?(r(),c("div",mt,[t("div",vt,[s(ke,{rows:8,animated:""})])])):l.value?(r(),c($,{key:1},[t("article",pt,[t("header",ft,[t("div",gt,[t("div",yt,[t("h1",ht,p(l.value.title),1),t("div",kt,[l.value.is_pinned?(r(),V(R,{key:0,type:"warning",size:"small",effect:"dark"},{default:a(()=>[s(i,null,{default:a(()=>[s(d(X))]),_:1}),e[12]||(e[12]=u(" 置顶 "))]),_:1,__:[12]})):g("",!0),l.value.is_featured?(r(),V(R,{key:1,type:"success",size:"small",effect:"dark"},{default:a(()=>[s(i,null,{default:a(()=>[s(d(Ke))]),_:1}),e[13]||(e[13]=u(" 精选 "))]),_:1,__:[13]})):g("",!0),l.value.status==="Draft"?(r(),V(R,{key:2,type:"info",size:"small",effect:"dark"},{default:a(()=>e[14]||(e[14]=[u(" 草稿 ")])),_:1,__:[14]})):g("",!0)])]),t("div",wt,[t("div",bt,[s(q,{size:48,class:"author-avatar"},{default:a(()=>[s(i,null,{default:a(()=>[s(d(A))]),_:1})]),_:1}),t("div",Ct,[t("div",Vt,p(l.value.author_name),1),t("div",zt,p(z(l.value.created_at)),1)])]),t("div",xt,[t("div",Dt,[s(i,{class:"stat-icon"},{default:a(()=>[s(d(Ne))]),_:1}),t("span",Lt,p(l.value.view_count),1),e[15]||(e[15]=t("span",{class:"stat-label"},"浏览",-1))]),t("div",Tt,[s(i,{class:"stat-icon"},{default:a(()=>[s(d(Z))]),_:1}),t("span",It,p(l.value.comment_count),1),e[16]||(e[16]=t("span",{class:"stat-label"},"评论",-1))]),t("div",Ut,[s(i,{class:"stat-icon"},{default:a(()=>[s(d(X))]),_:1}),t("span",Pt,p(l.value.like_count),1),e[17]||(e[17]=t("span",{class:"stat-label"},"点赞",-1))])])]),b.value.length>0?(r(),c("div",Mt,[(r(!0),c($,null,Q(b.value,n=>(r(),V(R,{key:n.id,color:n.color,class:"tag-item",effect:"light"},{default:a(()=>[u(p(n.name),1)]),_:2},1032,["color"]))),128))])):g("",!0)])]),t("div",At,[t("div",Et,[t("div",{class:"post-content",innerHTML:ie(l.value.content)},null,8,Bt)])]),M.value?(r(),c("div",Rt,[t("div",$t,[s(h,{type:"primary",size:"large",onClick:de,loading:K.value,class:Ue(["action-btn like-btn",{liked:D.value}])},{default:a(()=>[s(i,null,{default:a(()=>[s(d(X))]),_:1}),u(" "+p(D.value?"已点赞":"点赞")+" ",1),t("span",Ht,"("+p(l.value.like_count)+")",1)]),_:1},8,["loading","class"]),s(h,{type:"default",size:"large",onClick:ue,class:"action-btn comment-btn"},{default:a(()=>[s(i,null,{default:a(()=>[s(d(Z))]),_:1}),e[18]||(e[18]=u(" 评论 ")),t("span",Kt,"("+p(l.value.comment_count)+")",1)]),_:1,__:[18]})]),W.value||ee.value?(r(),c("div",Nt,[W.value?(r(),V(h,{key:0,type:"warning",size:"large",onClick:ce,class:"action-btn edit-btn"},{default:a(()=>[s(i,null,{default:a(()=>[s(d(Se))]),_:1}),e[19]||(e[19]=u(" 编辑 "))]),_:1,__:[19]})):g("",!0),ee.value?(r(),V(h,{key:1,type:"danger",size:"large",onClick:me,class:"action-btn delete-btn"},{default:a(()=>[s(i,null,{default:a(()=>[s(d(ae))]),_:1}),e[20]||(e[20]=u(" 删除 "))]),_:1,__:[20]})):g("",!0)])):g("",!0)])):g("",!0)]),t("section",St,[t("div",Ft,[t("h2",Yt,[s(i,null,{default:a(()=>[s(d(Z))]),_:1}),e[21]||(e[21]=u(" 评论讨论 ")),t("span",jt,"("+p(l.value?.comment_count||0)+")",1)])]),t("div",qt,[M.value?(r(),c("div",Jt,[e[24]||(e[24]=t("h3",{class:"form-title"},"发表评论",-1)),t("div",Ot,[s(J,{ref_key:"commentInputRef",ref:F,modelValue:L.value,"onUpdate:modelValue":e[2]||(e[2]=n=>L.value=n),type:"textarea",rows:4,placeholder:"写下你的评论...",onKeydown:Me(Ae(se,["ctrl"]),["enter"]),class:"comment-textarea"},null,8,["modelValue","onKeydown"])]),t("div",Qt,[t("div",Xt,[s(i,null,{default:a(()=>[s(d(Fe))]),_:1}),e[22]||(e[22]=u(" Ctrl + Enter 快速发表 "))]),s(h,{type:"primary",onClick:se,loading:N.value,disabled:!L.value.trim(),class:"submit-btn"},{default:a(()=>e[23]||(e[23]=[u(" 发表评论 ")])),_:1,__:[23]},8,["loading","disabled"])])])):(r(),c("div",Zt,[t("div",Gt,[s(i,{class:"prompt-icon"},{default:a(()=>[s(d(A))]),_:1}),e[26]||(e[26]=t("div",{class:"prompt-text"},[t("h4",null,"登录后参与讨论"),t("p",null,"登录后即可发表评论，与作者和其他用户互动")],-1)),s(h,{type:"primary",onClick:oe,class:"login-btn"},{default:a(()=>e[25]||(e[25]=[u(" 立即登录 ")])),_:1,__:[25]})])]))]),Pe((r(),c("div",Wt,[I.value.length===0&&!C.value?(r(),c("div",es,[s(we,{description:"暂无评论，来发表第一个评论吧！","image-size":100})])):(r(),c("div",ts,[(r(!0),c($,null,Q(I.value,n=>(r(),c("div",{key:n.id,class:"comment-item glass-inner"},[t("div",ss,[t("div",os,[s(q,{size:40,class:"comment-avatar"},{default:a(()=>[s(i,null,{default:a(()=>[s(d(A))]),_:1})]),_:1}),t("div",as,[t("div",ls,[t("span",ns,p(n.username),1),t("span",rs,p(z(n.created_at)),1)])])]),pe(n)?(r(),c("div",is,[s(h,{type:"danger",size:"small",onClick:_s=>ve(n.id),link:"",class:"delete-comment-btn"},{default:a(()=>[s(i,null,{default:a(()=>[s(d(ae))]),_:1}),e[27]||(e[27]=u(" 删除 "))]),_:2,__:[27]},1032,["onClick"])])):g("",!0)]),t("div",ds,p(n.content),1)]))),128))]))])),[[xe,C.value]])])],64)):g("",!0)])]),s(ze,{modelValue:P.value,"onUpdate:modelValue":e[7]||(e[7]=n=>P.value=n),title:"编辑帖子",width:"70%",class:"edit-dialog"},{footer:a(()=>[t("div",us,[s(h,{onClick:e[6]||(e[6]=n=>P.value=!1),size:"large"},{default:a(()=>e[28]||(e[28]=[u("取消")])),_:1,__:[28]}),s(h,{type:"primary",onClick:_e,loading:S.value,size:"large"},{default:a(()=>e[29]||(e[29]=[u(" 保存修改 ")])),_:1,__:[29]},8,["loading"])])]),default:a(()=>[s(Ve,{ref_key:"editFormRef",ref:Y,model:y,rules:le,"label-width":"80px",class:"edit-form"},{default:a(()=>[s(O,{label:"标题",prop:"title"},{default:a(()=>[s(J,{modelValue:y.title,"onUpdate:modelValue":e[3]||(e[3]=n=>y.title=n),placeholder:"请输入帖子标题",size:"large"},null,8,["modelValue"])]),_:1}),s(O,{label:"内容",prop:"content"},{default:a(()=>[s(J,{modelValue:y.content,"onUpdate:modelValue":e[4]||(e[4]=n=>y.content=n),type:"textarea",rows:10,placeholder:"请输入帖子内容"},null,8,["modelValue"])]),_:1}),s(O,{label:"标签"},{default:a(()=>[s(Ce,{modelValue:y.tags,"onUpdate:modelValue":e[5]||(e[5]=n=>y.tags=n),multiple:"",filterable:"","allow-create":"",placeholder:"选择或创建标签",style:{width:"100%"}},{default:a(()=>[(r(!0),c($,null,Q(B.value,n=>(r(),V(be,{key:n.id,label:n.name,value:n.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),ws=Oe(cs,[["__scopeId","data-v-1a48feaf"]]);export{ws as default};
