import{x as De,r as m,X as Ae,j as Me,y as D,A as u,Q as t,I as l,al as d,a4 as $e,u as v,P as N,a6 as Y,H as V,M as n,J as Ue,K as A,ar as Te,O as b,ax as Se,z as p}from"../chunks/vue-vendor-BleHOoLr.js";import{v as Z,H as Ie,D as G,j as Fe,A as Ee,Z as Re,w as Be,K as f,E as M}from"../chunks/element-plus-Cc1YNc_4.js";import{_ as He}from"../assets/index-B_N-aWSj.js";import{c as Ke}from"../chunks/categories-BGQr79qD.js";import{g as Ne,b as Ye,u as W,d as je}from"../chunks/posts-B23axQf4.js";import{a as qe}from"../chunks/tags-BVMB1T7b.js";import{f as Le}from"../chunks/format-CUgNVY1-.js";import"../chunks/utils-Dq7h7Pqt.js";const Qe={class:"post-manage"},Je={class:"filters"},Oe={class:"search-buttons"},Xe={class:"table-container"},Ze={class:"post-title"},Ge={class:"post-badges"},We={class:"post-stats"},et={key:0,class:"batch-actions"},tt={class:"pagination"},lt={class:"dialog-footer"},at=De({__name:"PostManage",setup(ot){const ee=Se(),te=o=>Le(o,"YYYY-MM-DD HH:mm"),I=m(!1),F=m(!1),j=m([]),E=m([]),q=m([]),k=m([]),L=m(0),$=m(1),R=m(20),U=m(""),T=m(""),h=m(""),x=m(!1),B=m(),s=Ae({title:"",content:"",category_id:void 0,tags:[],status:"Draft",is_pinned:!1,is_featured:!1}),le={title:[{required:!0,message:"请输入标题",trigger:"blur"},{min:1,max:200,message:"标题长度在 1 到 200 个字符",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"},{min:10,message:"内容至少 10 个字符",trigger:"blur"}]},c=async()=>{I.value=!0;try{console.log("🔍 [PostManage] 开始加载帖子");const o={page:$.value,page_size:R.value,search:U.value||void 0,status:T.value||void 0,category_id:h.value?parseInt(h.value):void 0};console.log("🔍 [PostManage] 请求参数:",o);const e=await Ne(o);if(console.log("🔍 [PostManage] API响应:",e),e.code===0&&e.data){const r=Array.isArray(e.data)?e.data:e.data.list||[],y=Array.isArray(e.data)?e.data.length:e.data.total||r.length;console.log("🔍 [PostManage] 解析后的帖子列表:",r),console.log("🔍 [PostManage] 总数:",y),j.value=r,L.value=y,r.length===0&&console.warn("⚠️ [PostManage] 帖子列表为空")}else console.error("❌ [PostManage] API返回错误:",e),f.error(e.msg||e.message||"加载帖子失败")}catch(o){console.error("❌ [PostManage] 请求异常:",o),f.error("加载帖子失败")}finally{I.value=!1}},ae=async()=>{try{const o=await Ke.getCategories();o.code===0&&o.data&&(E.value=o.data?.list||o.data||[])}catch(o){console.error("加载分类失败:",o)}},oe=async()=>{try{const o=await qe();o.code===0&&o.data&&(q.value=o.data)}catch(o){console.error("加载标签失败:",o)}},se=()=>{U.value="",T.value="",h.value="",$.value=1,c()},ne=o=>{k.value=o},Q=o=>{ee.push(`/posts/${o}`)},de=o=>{s.id=o.id,s.title=o.title,s.content=o.content,s.category_id=o.category_id,s.status=o.status,s.is_pinned=o.is_pinned,s.is_featured=o.is_featured,s.tags=[],x.value=!0,re(o.id)},re=async o=>{try{const e=await Ye(o);e.code===0&&e.data&&(s.tags=e.data.map(r=>r.name))}catch(e){console.error("加载帖子标签失败:",e)}},ie=()=>{s.id=void 0,s.title="",s.content="",s.category_id=void 0,s.status="Draft",s.is_pinned=!1,s.is_featured=!1,s.tags=[]},ue=async()=>{if(B.value)try{await B.value.validate(),F.value=!0;const{id:o,...e}=s,r=await W(o,e);r.code===0?(f.success("帖子更新成功"),x.value=!1,c()):f.error(r.msg||"更新失败")}catch(o){console.error("保存帖子失败:",o),f.error("保存失败")}finally{F.value=!1}},_e=async(o,e)=>{const[r,y]=o.split("-"),C=parseInt(y);try{let i={},g="";switch(r){case"pin":i.is_pinned=!e.is_pinned,g=e.is_pinned?"取消置顶成功":"置顶成功";break;case"feature":i.is_featured=!e.is_featured,g=e.is_featured?"取消精选成功":"设为精选成功";break;case"archive":i.status="Archived",g="归档成功";break;case"publish":i.status="Published",g="发布成功";break;case"delete":await M.confirm("确定要删除这个帖子吗？","确认删除",{type:"warning"}),(await je(C)).code===0&&(f.success("删除成功"),c());return}const _=await W(C,i);_.code===0?(f.success(g),c()):f.error(_.msg||"操作失败")}catch(i){i!=="cancel"&&(console.error("操作失败:",i),f.error("操作失败"))}},me=async()=>{try{await M.confirm(`确定要置顶选中的 ${k.value.length} 个帖子吗？`,"批量置顶"),f.info("批量置顶功能开发中...")}catch{}},ce=async()=>{try{await M.confirm(`确定要将选中的 ${k.value.length} 个帖子设为精选吗？`,"批量精选"),f.info("批量精选功能开发中...")}catch{}},pe=async()=>{try{await M.confirm(`确定要归档选中的 ${k.value.length} 个帖子吗？`,"批量归档"),f.info("批量归档功能开发中...")}catch{}},fe=async()=>{try{await M.confirm(`确定要删除选中的 ${k.value.length} 个帖子吗？此操作不可恢复！`,"批量删除",{type:"warning"}),f.info("批量删除功能开发中...")}catch{}},ge=()=>{c()},ve=o=>{switch(o){case"Published":return"success";case"Draft":return"info";case"Archived":return"warning";default:return"info"}},be=o=>{switch(o){case"Published":return"已发布";case"Draft":return"草稿";case"Archived":return"已归档";default:return o}};return Me(()=>{c(),ae(),oe()}),(o,e)=>{const r=d("el-icon"),y=d("el-input"),C=d("el-col"),i=d("el-option"),g=d("el-select"),_=d("el-button"),J=d("el-row"),w=d("el-table-column"),ye=d("el-link"),H=d("el-tag"),z=d("el-dropdown-item"),we=d("el-dropdown-menu"),Ve=d("el-dropdown"),O=d("el-button-group"),ke=d("el-table"),Ce=d("el-pagination"),P=d("el-form-item"),K=d("el-radio"),Pe=d("el-radio-group"),X=d("el-checkbox"),he=d("el-form"),xe=d("el-dialog"),ze=Te("loading");return p(),D("div",Qe,[e[36]||(e[36]=u("div",{class:"page-header"},[u("h1",null,"帖子管理"),u("p",null,"管理社区帖子内容")],-1)),u("div",Je,[t(J,{gutter:16},{default:l(()=>[t(C,{span:6},{default:l(()=>[t(y,{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=a=>U.value=a),placeholder:"搜索帖子标题或内容...",clearable:"",onKeyup:$e(c,["enter"]),onClear:c},{prefix:l(()=>[t(r,null,{default:l(()=>[t(v(Z))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(C,{span:4},{default:l(()=>[t(g,{modelValue:T.value,"onUpdate:modelValue":e[1]||(e[1]=a=>T.value=a),placeholder:"选择状态",clearable:"",onChange:c},{default:l(()=>[t(i,{label:"全部",value:""}),t(i,{label:"已发布",value:"Published"}),t(i,{label:"草稿",value:"Draft"}),t(i,{label:"已归档",value:"Archived"})]),_:1},8,["modelValue"])]),_:1}),t(C,{span:4},{default:l(()=>[t(g,{modelValue:h.value,"onUpdate:modelValue":e[2]||(e[2]=a=>h.value=a),placeholder:"选择分类",clearable:"",onChange:c},{default:l(()=>[t(i,{label:"全部",value:""}),(p(!0),D(N,null,Y(E.value,a=>(p(),V(i,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(C,{span:6},{default:l(()=>[u("div",Oe,[t(_,{onClick:ge},{default:l(()=>[t(r,null,{default:l(()=>[t(v(Ie))]),_:1}),e[14]||(e[14]=n(" 刷新 "))]),_:1,__:[14]}),t(_,{type:"primary",onClick:c},{default:l(()=>[t(r,null,{default:l(()=>[t(v(Z))]),_:1}),e[15]||(e[15]=n(" 查询 "))]),_:1,__:[15]})]),t(_,{onClick:se,style:{"margin-top":"10px"}},{default:l(()=>e[16]||(e[16]=[n("重置")])),_:1,__:[16]})]),_:1})]),_:1})]),u("div",Xe,[Ue((p(),V(ke,{data:j.value,stripe:"",style:{width:"100%"},onSelectionChange:ne},{default:l(()=>[t(w,{type:"selection",width:"55"}),t(w,{prop:"id",label:"ID",width:"80"}),t(w,{prop:"title",label:"标题","min-width":"200"},{default:l(({row:a})=>[u("div",Ze,[t(ye,{type:"primary",onClick:S=>Q(a.id)},{default:l(()=>[n(b(a.title),1)]),_:2},1032,["onClick"]),u("div",Ge,[a.is_pinned?(p(),V(H,{key:0,type:"warning",size:"small"},{default:l(()=>e[17]||(e[17]=[n("置顶")])),_:1,__:[17]})):A("",!0),a.is_featured?(p(),V(H,{key:1,type:"success",size:"small"},{default:l(()=>e[18]||(e[18]=[n("精选")])),_:1,__:[18]})):A("",!0)])])]),_:1}),t(w,{prop:"author_name",label:"作者",width:"120"}),t(w,{prop:"status",label:"状态",width:"100"},{default:l(({row:a})=>[t(H,{type:ve(a.status),size:"small"},{default:l(()=>[n(b(be(a.status)),1)]),_:2},1032,["type"])]),_:1}),t(w,{label:"统计",width:"120"},{default:l(({row:a})=>[u("div",We,[u("span",null,[t(r,null,{default:l(()=>[t(v(G))]),_:1}),n(" "+b(a.view_count),1)]),u("span",null,[t(r,null,{default:l(()=>[t(v(Fe))]),_:1}),n(" "+b(a.comment_count),1)]),u("span",null,[t(r,null,{default:l(()=>[t(v(Ee))]),_:1}),n(" "+b(a.like_count),1)])])]),_:1}),t(w,{prop:"created_at",label:"创建时间",width:"160"},{default:l(({row:a})=>[n(b(te(a.created_at)),1)]),_:1}),t(w,{label:"操作",width:"300",fixed:"right"},{default:l(({row:a})=>[t(O,null,{default:l(()=>[t(_,{size:"small",onClick:S=>Q(a.id)},{default:l(()=>[t(r,null,{default:l(()=>[t(v(G))]),_:1}),e[19]||(e[19]=n(" 查看 "))]),_:2,__:[19]},1032,["onClick"]),t(_,{size:"small",type:"primary",onClick:S=>de(a)},{default:l(()=>[t(r,null,{default:l(()=>[t(v(Re))]),_:1}),e[20]||(e[20]=n(" 编辑 "))]),_:2,__:[20]},1032,["onClick"]),t(Ve,{onCommand:S=>_e(S,a)},{dropdown:l(()=>[t(we,null,{default:l(()=>[t(z,{command:`pin-${a.id}`},{default:l(()=>[n(b(a.is_pinned?"取消置顶":"置顶"),1)]),_:2},1032,["command"]),t(z,{command:`feature-${a.id}`},{default:l(()=>[n(b(a.is_featured?"取消精选":"设为精选"),1)]),_:2},1032,["command"]),a.status!=="Archived"?(p(),V(z,{key:0,command:`archive-${a.id}`},{default:l(()=>e[22]||(e[22]=[n(" 归档 ")])),_:2,__:[22]},1032,["command"])):A("",!0),a.status!=="Published"?(p(),V(z,{key:1,command:`publish-${a.id}`},{default:l(()=>e[23]||(e[23]=[n(" 发布 ")])),_:2,__:[23]},1032,["command"])):A("",!0),t(z,{command:`delete-${a.id}`,divided:""},{default:l(()=>e[24]||(e[24]=[u("span",{style:{color:"#f56c6c"}},"删除",-1)])),_:2,__:[24]},1032,["command"])]),_:2},1024)]),default:l(()=>[t(_,{size:"small"},{default:l(()=>[e[21]||(e[21]=n(" 更多")),t(r,{class:"el-icon--right"},{default:l(()=>[t(v(Be))]),_:1})]),_:1,__:[21]})]),_:2},1032,["onCommand"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ze,I.value]]),k.value.length>0?(p(),D("div",et,[u("span",null,"已选择 "+b(k.value.length)+" 个帖子",1),t(O,null,{default:l(()=>[t(_,{size:"small",onClick:me},{default:l(()=>e[25]||(e[25]=[n("批量置顶")])),_:1,__:[25]}),t(_,{size:"small",onClick:ce},{default:l(()=>e[26]||(e[26]=[n("批量精选")])),_:1,__:[26]}),t(_,{size:"small",onClick:pe},{default:l(()=>e[27]||(e[27]=[n("批量归档")])),_:1,__:[27]}),t(_,{size:"small",type:"danger",onClick:fe},{default:l(()=>e[28]||(e[28]=[n("批量删除")])),_:1,__:[28]})]),_:1})])):A("",!0),u("div",tt,[t(Ce,{"current-page":$.value,"onUpdate:currentPage":e[3]||(e[3]=a=>$.value=a),"page-size":R.value,"onUpdate:pageSize":e[4]||(e[4]=a=>R.value=a),"page-sizes":[10,20,50,100],total:L.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:c,onCurrentChange:c},null,8,["current-page","page-size","total"])])]),t(xe,{modelValue:x.value,"onUpdate:modelValue":e[13]||(e[13]=a=>x.value=a),title:"编辑帖子",width:"800px",onClose:ie},{footer:l(()=>[u("span",lt,[t(_,{onClick:e[12]||(e[12]=a=>x.value=!1)},{default:l(()=>e[34]||(e[34]=[n("取消")])),_:1,__:[34]}),t(_,{type:"primary",onClick:ue,loading:F.value},{default:l(()=>e[35]||(e[35]=[n(" 保存 ")])),_:1,__:[35]},8,["loading"])])]),default:l(()=>[t(he,{ref_key:"editFormRef",ref:B,model:s,rules:le,"label-width":"100px"},{default:l(()=>[t(P,{label:"标题",prop:"title"},{default:l(()=>[t(y,{modelValue:s.title,"onUpdate:modelValue":e[5]||(e[5]=a=>s.title=a),maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(P,{label:"内容",prop:"content"},{default:l(()=>[t(y,{modelValue:s.content,"onUpdate:modelValue":e[6]||(e[6]=a=>s.content=a),type:"textarea",rows:10,maxlength:"10000","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(P,{label:"分类"},{default:l(()=>[t(g,{modelValue:s.category_id,"onUpdate:modelValue":e[7]||(e[7]=a=>s.category_id=a),placeholder:"选择分类"},{default:l(()=>[(p(!0),D(N,null,Y(E.value,a=>(p(),V(i,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(P,{label:"标签"},{default:l(()=>[t(g,{modelValue:s.tags,"onUpdate:modelValue":e[8]||(e[8]=a=>s.tags=a),multiple:"",filterable:"","allow-create":"",placeholder:"选择或创建标签"},{default:l(()=>[(p(!0),D(N,null,Y(q.value,a=>(p(),V(i,{key:a.id,label:a.name,value:a.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(P,{label:"状态"},{default:l(()=>[t(Pe,{modelValue:s.status,"onUpdate:modelValue":e[9]||(e[9]=a=>s.status=a)},{default:l(()=>[t(K,{label:"Draft"},{default:l(()=>e[29]||(e[29]=[n("草稿")])),_:1,__:[29]}),t(K,{label:"Published"},{default:l(()=>e[30]||(e[30]=[n("已发布")])),_:1,__:[30]}),t(K,{label:"Archived"},{default:l(()=>e[31]||(e[31]=[n("已归档")])),_:1,__:[31]})]),_:1},8,["modelValue"])]),_:1}),t(P,{label:"选项"},{default:l(()=>[t(X,{modelValue:s.is_pinned,"onUpdate:modelValue":e[10]||(e[10]=a=>s.is_pinned=a)},{default:l(()=>e[32]||(e[32]=[n("置顶")])),_:1,__:[32]},8,["modelValue"]),t(X,{modelValue:s.is_featured,"onUpdate:modelValue":e[11]||(e[11]=a=>s.is_featured=a)},{default:l(()=>e[33]||(e[33]=[n("精选")])),_:1,__:[33]},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),ct=He(at,[["__scopeId","data-v-6fed0bb8"]]);export{ct as default};
