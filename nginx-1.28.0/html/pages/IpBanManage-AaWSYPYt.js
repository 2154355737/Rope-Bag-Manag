import{x as ye,r as i,X as A,c as we,j as Ve,y as q,Q as t,I as a,A as n,J as Ie,al as r,O as f,a4 as xe,u as E,M as u,ar as Ce,H as K,K as G,z as C}from"../chunks/vue-vendor-BleHOoLr.js";import{v as Pe,z as Y,K as d,E as j}from"../chunks/element-plus-Cc1YNc_4.js";import{a as v}from"../chunks/admin-DseeQ8_4.js";import{_ as he}from"../assets/index-B_N-aWSj.js";import"../chunks/utils-Dq7h7Pqt.js";const ke={class:"ip-ban-manage"},Be={class:"card-header"},ze={class:"stat-item"},Ue={class:"stat-number"},Fe={class:"stat-item"},Te={class:"stat-number"},$e={class:"stat-number"},Me={class:"stat-item"},Re={class:"stat-number"},Se={class:"search-bar"},De={key:0},We={key:1,class:"text-muted"},Ne={class:"pagination-container"},qe={class:"card-header"},Ee=ye({__name:"IpBanManage",setup(Ke){const $=i(!1),b=i(!1),P=i(""),h=i("all"),k=i("all"),y=i(1),M=i(20),Z=i(0),Q=i([]),R=i([]),F=i({}),B=i(!1),z=i(!1),o=A({ip_address:"",reason:"",ban_type:"temporary",duration_hours:24,notes:""}),c=A({ip_address:"",description:""}),ee={ip_address:[{required:!0,message:"请输入IP地址",trigger:"blur"},{pattern:/^(\d{1,3}\.){3}\d{1,3}$/,message:"请输入有效的IP地址",trigger:"blur"}],reason:[{required:!0,message:"请输入封禁原因",trigger:"blur"}],ban_type:[{required:!0,message:"请选择封禁类型",trigger:"change"}]},te={ip_address:[{required:!0,message:"请输入IP地址",trigger:"blur"},{pattern:/^(\d{1,3}\.){3}\d{1,3}$/,message:"请输入有效的IP地址",trigger:"blur"}]},S=i(),D=i(),ae=we(()=>{let s=Q.value;return P.value&&(s=s.filter(e=>e.ip_address.includes(P.value))),h.value!=="all"&&(s=s.filter(e=>e.ban_type===h.value)),k.value!=="all"&&(s=s.filter(e=>k.value==="active"?e.is_active:!e.is_active)),s}),w=async()=>{try{$.value=!0;const s=await v.getBanStats();s.code===0&&(F.value=s.data);const e=await v.getIpBans();e.code===0&&(Q.value=e.data.bans||[]);const V=await v.getIpWhitelist();V.code===0&&(R.value=V.data.whitelist||[])}catch(s){console.error("获取数据失败:",s),d.error("获取数据失败: "+(s.message||"网络错误"))}finally{$.value=!1}},le=async()=>{try{await S.value.validate(),b.value=!0;const s=await v.banIp({ip_address:o.ip_address,reason:o.reason,ban_type:o.ban_type,duration_hours:o.ban_type==="temporary"?o.duration_hours:void 0,notes:o.notes});s.code===0?(d.success("IP封禁成功"),B.value=!1,pe(),w()):d.error(s.message||"封禁失败")}catch(s){console.error("封禁失败:",s),d.error("封禁失败: "+(s.message||"网络错误"))}finally{b.value=!1}},se=async s=>{try{await j.confirm(`确定要解除IP ${s} 的封禁吗？`,"确认解除封禁",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await v.unbanIp({ip_address:s});e.code===0?(d.success("IP封禁解除成功"),w()):d.error(e.message||"解除封禁失败")}catch(e){e!=="cancel"&&(console.error("解除封禁失败:",e),d.error("解除封禁失败: "+(e.message||"网络错误")))}},oe=async s=>{try{await j.confirm("确定要删除这条封禁记录吗？此操作不可恢复。","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await v.deleteIpBan(s);e.code===0?(d.success("封禁记录删除成功"),w()):d.error(e.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),d.error("删除失败: "+(e.message||"网络错误")))}},ne=async()=>{try{await D.value.validate(),b.value=!0;const s=await v.addIpToWhitelist({ip_address:c.ip_address,description:c.description});s.code===0?(d.success("IP已添加到白名单"),z.value=!1,me(),w()):d.error(s.message||"添加失败")}catch(s){console.error("添加失败:",s),d.error("添加失败: "+(s.message||"网络错误"))}finally{b.value=!1}},re=async s=>{try{await j.confirm(`确定要从白名单中移除IP ${s} 吗？`,"确认移除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await v.removeIpFromWhitelist({ip_address:s});e.code===0?(d.success("IP已从白名单移除"),w()):d.error(e.message||"移除失败")}catch(e){e!=="cancel"&&(console.error("移除失败:",e),d.error("移除失败: "+(e.message||"网络错误")))}},U=()=>{y.value=1},de=()=>{P.value="",h.value="all",k.value="all",y.value=1,U()},ie=s=>{M.value=s,y.value=1,U()},ue=s=>{y.value=s,U()},pe=()=>{o.ip_address="",o.reason="",o.ban_type="temporary",o.duration_hours=24,o.notes="",S.value?.resetFields()},me=()=>{c.ip_address="",c.description="",D.value?.resetFields()},W=s=>s?new Date(s).toLocaleString("zh-CN"):"",_e=s=>({temporary:"临时封禁",permanent:"永久封禁",download_only:"下载限制"})[s]||s,ce=s=>({temporary:"warning",permanent:"danger",download_only:"info"})[s]||"default";return Ve(()=>{w()}),(s,e)=>{const V=r("el-icon"),m=r("el-button"),I=r("el-card"),T=r("el-col"),fe=r("el-row"),x=r("el-input"),_=r("el-option"),N=r("el-select"),p=r("el-table-column"),H=r("el-tag"),J=r("el-table"),ve=r("el-pagination"),g=r("el-form-item"),ge=r("el-input-number"),L=r("el-form"),O=r("el-dialog"),be=Ce("loading");return C(),q("div",ke,[t(I,{class:"manage-card"},{header:a(()=>[n("div",Be,[e[19]||(e[19]=n("span",null,"IP封禁管理",-1)),t(m,{type:"primary",onClick:e[0]||(e[0]=l=>B.value=!0)},{default:a(()=>[t(V,null,{default:a(()=>[t(E(Y))]),_:1}),e[18]||(e[18]=u(" 封禁IP "))]),_:1,__:[18]})])]),default:a(()=>[t(fe,{gutter:20,class:"stats-overview"},{default:a(()=>[t(T,{span:6},{default:a(()=>[t(I,{class:"stat-card"},{default:a(()=>[n("div",ze,[n("div",Ue,f(F.value.total_bans||0),1),e[20]||(e[20]=n("div",{class:"stat-label"},"总封禁数",-1)),e[21]||(e[21]=n("div",{class:"stat-desc"},"历史封禁记录总数",-1))])]),_:1})]),_:1}),t(T,{span:6},{default:a(()=>[t(I,{class:"stat-card"},{default:a(()=>[n("div",Fe,[n("div",Te,f(F.value.active_bans||0),1),e[22]||(e[22]=n("div",{class:"stat-label"},"活跃封禁",-1)),e[23]||(e[23]=n("div",{class:"stat-desc"},"当前生效的封禁",-1))])]),_:1})]),_:1}),t(T,{span:6},{default:a(()=>[t(I,{class:"stat-card"},{default:a(()=>[n("div",$e,f(F.value.recent_bans_24h||0),1),e[24]||(e[24]=n("div",{class:"stat-label"},"24小时内",-1)),e[25]||(e[25]=n("div",{class:"stat-desc"},"最近24小时新增封禁",-1))]),_:1,__:[24,25]})]),_:1}),t(T,{span:6},{default:a(()=>[t(I,{class:"stat-card"},{default:a(()=>[n("div",Me,[n("div",Re,f(R.value.length),1),e[26]||(e[26]=n("div",{class:"stat-label"},"白名单IP",-1)),e[27]||(e[27]=n("div",{class:"stat-desc"},"豁免封禁的IP数量",-1))])]),_:1})]),_:1})]),_:1}),n("div",Se,[t(x,{modelValue:P.value,"onUpdate:modelValue":e[1]||(e[1]=l=>P.value=l),placeholder:"搜索IP地址...",style:{width:"300px","margin-right":"16px"},clearable:"",onKeyup:xe(U,["enter"])},{prefix:a(()=>[t(V,null,{default:a(()=>[t(E(Pe))]),_:1})]),_:1},8,["modelValue"]),t(N,{modelValue:h.value,"onUpdate:modelValue":e[2]||(e[2]=l=>h.value=l),placeholder:"封禁类型",style:{width:"150px","margin-right":"16px"}},{default:a(()=>[t(_,{label:"全部",value:"all"}),t(_,{label:"临时封禁",value:"temporary"}),t(_,{label:"永久封禁",value:"permanent"}),t(_,{label:"下载限制",value:"download_only"})]),_:1},8,["modelValue"]),t(N,{modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=l=>k.value=l),placeholder:"状态",style:{width:"120px","margin-right":"16px"}},{default:a(()=>[t(_,{label:"全部",value:"all"}),t(_,{label:"活跃",value:"active"}),t(_,{label:"已解除",value:"inactive"})]),_:1},8,["modelValue"]),t(m,{type:"primary",onClick:U},{default:a(()=>e[28]||(e[28]=[u("搜索")])),_:1,__:[28]}),t(m,{onClick:de},{default:a(()=>e[29]||(e[29]=[u("重置")])),_:1,__:[29]})]),Ie((C(),K(J,{data:ae.value,style:{width:"100%"}},{default:a(()=>[t(p,{prop:"ip_address",label:"IP地址",width:"150"}),t(p,{prop:"reason",label:"封禁原因","min-width":"200"}),t(p,{prop:"ban_type",label:"封禁类型",width:"120"},{default:a(({row:l})=>[t(H,{type:ce(l.ban_type)},{default:a(()=>[u(f(_e(l.ban_type)),1)]),_:2},1032,["type"])]),_:1}),t(p,{prop:"created_at",label:"封禁时间",width:"180"},{default:a(({row:l})=>[u(f(W(l.created_at)),1)]),_:1}),t(p,{prop:"expires_at",label:"过期时间",width:"180"},{default:a(({row:l})=>[l.expires_at?(C(),q("span",De,f(W(l.expires_at)),1)):(C(),q("span",We,"永久"))]),_:1}),t(p,{prop:"is_active",label:"状态",width:"100"},{default:a(({row:l})=>[t(H,{type:l.is_active?"danger":"success"},{default:a(()=>[u(f(l.is_active?"活跃":"已解除"),1)]),_:2},1032,["type"])]),_:1}),t(p,{prop:"created_by",label:"操作者",width:"120"}),t(p,{label:"操作",width:"200",fixed:"right"},{default:a(({row:l})=>[l.is_active?(C(),K(m,{key:0,size:"small",type:"success",onClick:X=>se(l.ip_address)},{default:a(()=>e[30]||(e[30]=[u(" 解除封禁 ")])),_:2,__:[30]},1032,["onClick"])):G("",!0),t(m,{size:"small",type:"danger",onClick:X=>oe(l.id)},{default:a(()=>e[31]||(e[31]=[u(" 删除记录 ")])),_:2,__:[31]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[be,$.value]]),n("div",Ne,[t(ve,{"current-page":y.value,"onUpdate:currentPage":e[4]||(e[4]=l=>y.value=l),"page-size":M.value,"onUpdate:pageSize":e[5]||(e[5]=l=>M.value=l),"page-sizes":[10,20,50,100],total:Z.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ie,onCurrentChange:ue},null,8,["current-page","page-size","total"])])]),_:1}),t(O,{modelValue:B.value,"onUpdate:modelValue":e[12]||(e[12]=l=>B.value=l),title:"封禁IP",width:"500px"},{footer:a(()=>[t(m,{onClick:e[11]||(e[11]=l=>B.value=!1)},{default:a(()=>e[33]||(e[33]=[u("取消")])),_:1,__:[33]}),t(m,{type:"primary",onClick:le,loading:b.value},{default:a(()=>e[34]||(e[34]=[u("确认封禁")])),_:1,__:[34]},8,["loading"])]),default:a(()=>[t(L,{model:o,rules:ee,ref_key:"banFormRef",ref:S,"label-width":"100px"},{default:a(()=>[t(g,{label:"IP地址",prop:"ip_address"},{default:a(()=>[t(x,{modelValue:o.ip_address,"onUpdate:modelValue":e[6]||(e[6]=l=>o.ip_address=l),placeholder:"请输入IP地址"},null,8,["modelValue"])]),_:1}),t(g,{label:"封禁原因",prop:"reason"},{default:a(()=>[t(x,{modelValue:o.reason,"onUpdate:modelValue":e[7]||(e[7]=l=>o.reason=l),type:"textarea",placeholder:"请输入封禁原因"},null,8,["modelValue"])]),_:1}),t(g,{label:"封禁类型",prop:"ban_type"},{default:a(()=>[t(N,{modelValue:o.ban_type,"onUpdate:modelValue":e[8]||(e[8]=l=>o.ban_type=l),placeholder:"选择封禁类型"},{default:a(()=>[t(_,{label:"临时封禁",value:"temporary"}),t(_,{label:"永久封禁",value:"permanent"}),t(_,{label:"下载限制",value:"download_only"})]),_:1},8,["modelValue"])]),_:1}),o.ban_type==="temporary"?(C(),K(g,{key:0,label:"封禁时长",prop:"duration_hours"},{default:a(()=>[t(ge,{modelValue:o.duration_hours,"onUpdate:modelValue":e[9]||(e[9]=l=>o.duration_hours=l),min:1,max:8760},null,8,["modelValue"]),e[32]||(e[32]=n("span",{style:{"margin-left":"8px"}},"小时",-1))]),_:1,__:[32]})):G("",!0),t(g,{label:"备注",prop:"notes"},{default:a(()=>[t(x,{modelValue:o.notes,"onUpdate:modelValue":e[10]||(e[10]=l=>o.notes=l),type:"textarea",placeholder:"可选备注信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(I,{class:"whitelist-card"},{header:a(()=>[n("div",qe,[e[36]||(e[36]=n("span",null,"IP白名单管理",-1)),t(m,{type:"success",onClick:e[13]||(e[13]=l=>z.value=!0)},{default:a(()=>[t(V,null,{default:a(()=>[t(E(Y))]),_:1}),e[35]||(e[35]=u(" 添加白名单 "))]),_:1,__:[35]})])]),default:a(()=>[t(J,{data:R.value,style:{width:"100%"}},{default:a(()=>[t(p,{prop:"ip_address",label:"IP地址",width:"200"}),t(p,{prop:"description",label:"描述","min-width":"200"}),t(p,{prop:"created_at",label:"添加时间",width:"180"},{default:a(({row:l})=>[u(f(W(l.created_at)),1)]),_:1}),t(p,{prop:"created_by",label:"添加者",width:"120"}),t(p,{label:"操作",width:"120"},{default:a(({row:l})=>[t(m,{size:"small",type:"danger",onClick:X=>re(l.ip_address)},{default:a(()=>e[37]||(e[37]=[u(" 移除 ")])),_:2,__:[37]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),t(O,{modelValue:z.value,"onUpdate:modelValue":e[17]||(e[17]=l=>z.value=l),title:"添加IP白名单",width:"400px"},{footer:a(()=>[t(m,{onClick:e[16]||(e[16]=l=>z.value=!1)},{default:a(()=>e[38]||(e[38]=[u("取消")])),_:1,__:[38]}),t(m,{type:"primary",onClick:ne,loading:b.value},{default:a(()=>e[39]||(e[39]=[u("确认添加")])),_:1,__:[39]},8,["loading"])]),default:a(()=>[t(L,{model:c,rules:te,ref_key:"whitelistFormRef",ref:D,"label-width":"80px"},{default:a(()=>[t(g,{label:"IP地址",prop:"ip_address"},{default:a(()=>[t(x,{modelValue:c.ip_address,"onUpdate:modelValue":e[14]||(e[14]=l=>c.ip_address=l),placeholder:"请输入IP地址"},null,8,["modelValue"])]),_:1}),t(g,{label:"描述",prop:"description"},{default:a(()=>[t(x,{modelValue:c.description,"onUpdate:modelValue":e[15]||(e[15]=l=>c.description=l),placeholder:"可选描述信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Oe=he(Ee,[["__scopeId","data-v-2431302f"]]);export{Oe as default};
