import{x as we,c as B,ay as ze,r as p,X as xe,y as _,A as s,az as j,P as M,a6 as K,C as be,Q as a,H as g,K as f,I as o,M as u,u as v,al as y,O as d,ax as Se,z as n}from"../chunks/vue-vendor-BleHOoLr.js";import{u as J,j as Ie,J as Ae,C as De,f as O,t as R,K as Me,L as Pe,M as Te,H as r,E as qe}from"../chunks/element-plus-hGoKm610.js";import{T as Ee}from"../chunks/ThemeSwitcher--hNdK5mb.js";import{g as P}from"../assets/index-D3Kp6etV.js";import{p as X}from"../chunks/packages-B3dEIScr.js";import{c as b}from"../chunks/comments-C3QNE2E1.js";import{c as Fe}from"../chunks/categories-Cxelk8WM.js";import"../chunks/utils-Dq7h7Pqt.js";const Ne={class:"resource-detail-container"},Ve={class:"dynamic-background"},$e={class:"floating-particles"},Le={class:"header"},Be={class:"header-content"},Re={class:"actions"},Ue={class:"main"},He={class:"main-content"},Qe={key:0,class:"loading-container"},je={key:1,class:"not-found"},Ke={class:"resource-header"},Je={class:"resource-title-area"},Oe={class:"resource-title"},Xe={class:"resource-meta"},Ge={class:"meta-item"},We={class:"meta-item"},Ye={class:"meta-item"},Ze={class:"meta-item"},et={class:"resource-content"},tt={class:"resource-description"},at={class:"description-content"},st={class:"resource-actions"},ot={class:"comments-section"},lt={key:0,class:"no-comments"},nt={key:1,class:"comment-list"},rt={class:"comment-header"},it={class:"comment-meta"},ct={class:"comment-author"},ut={key:1,class:"comment-qq ml-1"},dt={class:"comment-time"},mt={class:"comment-content"},vt={class:"comment-actions"},_t={key:2,class:"pagination"},pt={class:"comment-form"},ft={class:"form-actions"},St=we({__name:"ResourceDetail",setup(gt){const G=ze(),z=Se(),h=B(()=>Number(G.params.id)||0),T=p(!0),i=p(null),C=p([]),q=p([]),E=p(""),S=p(0),x=p(1),I=p(10),U=p(!1),F=p(!1),N=p(!1),k=xe({content:"",parentId:null}),w=B(()=>localStorage.getItem("isLoggedIn")==="true");B(()=>{const e=P();return e?e.id:null});const H=e=>new Date(e).toLocaleDateString("zh-CN"),W=e=>e?{admin:"ç®¡ç†å‘˜",moderator:"ç‰ˆä¸»",elder:"é•¿è€",user:"ç”¨æˆ·"}[e]||e:"",V=()=>{z.push("/home")},Y=()=>{z.push("/login")},Z=()=>{const e=P();if(!e){z.push("/login");return}e.role==="admin"||e.role==="moderator"?z.push("/admin"):e.role==="elder"?z.push("/elder"):e.role==="user"?z.push("/user"):z.push("/403")},ee=async()=>{if(h.value)try{T.value=!0;const e=await X.getPackage(h.value);e.code===0&&e.data?(i.value=e.data,i.value.category_id&&await ae(i.value.category_id)):(r.error(e.message||"åŠ è½½èµ„æºå¤±è´¥"),i.value=null)}catch(e){console.error("åŠ è½½èµ„æºå‡ºé”™:",e),r.error("åŠ è½½èµ„æºæ—¶å‘ç”Ÿé”™è¯¯"),i.value=null}finally{T.value=!1}},A=async()=>{if(h.value)try{const e=await b.getPackageComments(h.value,{page:x.value,size:I.value});e.code===0&&e.data?(C.value=e.data.list||[],S.value=e.data.total||0):(console.warn("åŠ è½½è¯„è®ºè¿”å›žé”™è¯¯:",e.message),C.value=[],S.value=0)}catch(e){console.error("åŠ è½½è¯„è®ºå‡ºé”™:",e),C.value=[],S.value=0}},te=async()=>{try{const e=await Fe.getCategories();e.code===0&&e.data&&(q.value=e.data.list||[])}catch(e){console.error("åŠ è½½åˆ†ç±»å‡ºé”™:",e)}},ae=async e=>{q.value.length===0&&await te();const t=q.value.find(c=>c.id===e);E.value=t?t.name:"æœªåˆ†ç±»"},se=e=>e&&{1:"#409EFF",2:"#67C23A",3:"#E6A23C",4:"#F56C6C",5:"#909399"}[e]||"#409EFF",oe=async()=>{if(h.value)try{const e=await X.downloadPackage(h.value);e.code===0?(e.data&&typeof e.data=="string"&&window.open(e.data,"_blank"),r.success("ä¸‹è½½å¼€å§‹"),ee()):r.error(e.message||"ä¸‹è½½å¤±è´¥")}catch(e){console.error("ä¸‹è½½å¤±è´¥:",e),r.error("ä¸‹è½½èµ„æºæ—¶å‘ç”Ÿé”™è¯¯")}},le=async()=>{if(!w.value){r.warning("è¯·å…ˆç™»å½•åŽå†ç‚¹èµž");return}if(h.value)try{F.value=!0,{code:0,message:"ç‚¹èµžæˆåŠŸ"}.code===0&&(r.success("ç‚¹èµžæˆåŠŸ"),U.value=!0,i.value&&(i.value.like_count+=1))}catch(e){console.error("ç‚¹èµžå¤±è´¥:",e),r.error("ç‚¹èµžæ—¶å‘ç”Ÿé”™è¯¯")}finally{F.value=!1}},ne=async()=>{if(!w.value){r.warning("è¯·å…ˆç™»å½•åŽå†å‘è¡¨è¯„è®º");return}if(!k.content.trim()){r.warning("è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º");return}if(h.value)try{N.value=!0;const e=await b.createComment({content:k.content.trim(),target_id:h.value,target_type:"Package",parent_id:k.parentId??void 0});e.code===0?(r.success("è¯„è®ºå‘å¸ƒæˆåŠŸ"),k.content="",k.parentId=null,A()):r.error(e.message||"å‘å¸ƒè¯„è®ºå¤±è´¥")}catch(e){console.error("å‘å¸ƒè¯„è®ºå¤±è´¥:",e),r.error("å‘å¸ƒè¯„è®ºæ—¶å‘ç”Ÿé”™è¯¯")}finally{N.value=!1}},re=async e=>{try{const t=await b.likeComment(e,!0);if(t.code===0){r.success("ç‚¹èµžæˆåŠŸ");const c=C.value.find(m=>m.id===e);c&&(c.likes=t.data??c.likes+1)}else r.error(t.message||"ç‚¹èµžå¤±è´¥")}catch(t){console.error("ç‚¹èµžå¤±è´¥:",t),r.error("ç‚¹èµžæ—¶å‘ç”Ÿé”™è¯¯")}},ie=e=>{k.parentId=e,setTimeout(()=>{document.querySelector(".comment-form")?.scrollIntoView({behavior:"smooth"})},100)},ce=async e=>{try{await qe.confirm("ç¡®å®šè¦åˆ é™¤æ­¤è¯„è®ºå—ï¼Ÿ","æç¤º",{confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",type:"warning"});const t=await b.deleteComment(e);t.code===0?(r.success("åˆ é™¤æˆåŠŸ"),A()):r.error(t.message||"åˆ é™¤å¤±è´¥")}catch(t){t!=="cancel"&&(console.error("åˆ é™¤è¯„è®ºå¤±è´¥:",t),r.error("åˆ é™¤è¯„è®ºæ—¶å‘ç”Ÿé”™è¯¯"))}},ue=e=>{if(!w.value)return!1;const t=P();return t?t.role==="admin"||t.role==="moderator"?!0:e.user_id===t.id:!1},de=e=>{if(!w.value)return!1;const t=P();return!t||!i.value?!1:t.role==="Admin"||t.role==="Elder"||t.username===i.value.author},me=async e=>{try{const t=await b.pinComment(e.id,!e.pinned);t.code===0?(r.success(e.pinned?"å–æ¶ˆç½®é¡¶æˆåŠŸ":"ç½®é¡¶æˆåŠŸ"),e.pinned=!e.pinned):r.error(t.message||"æ“ä½œå¤±è´¥")}catch(t){console.error("ç½®é¡¶å¤±è´¥:",t),r.error("ç½®é¡¶æ—¶å‘ç”Ÿé”™è¯¯")}},ve=e=>i.value?(console.log("æ£€æŸ¥ä½œè€…èº«ä»½:",{comment_author:e.username,resource_author:i.value.author,is_match:e.username===i.value.author}),e.username===i.value.author):!1,_e=e=>{I.value=e,x.value=1,A()},pe=e=>{x.value=e,A()},fe=e=>{const t=Math.random()*4+2,c=Math.random()*100,m=Math.random()*20,$=Math.random()*10+10;return{width:`${t}px`,height:`${t}px`,left:`${c}%`,animationDelay:`${m}s`,animationDuration:`${$}s`}};return(e,t)=>{const c=y("el-icon"),m=y("el-button"),$=y("el-skeleton"),ge=y("el-empty"),D=y("el-tag"),Q=y("el-divider"),ye=y("el-avatar"),he=y("el-pagination"),ke=y("el-alert"),Ce=y("el-input");return n(),_("div",Ne,[s("div",Ve,[t[3]||(t[3]=j('<div class="gradient-layer"></div><div class="geometric-shapes"><div class="shape triangle-1"></div><div class="shape triangle-2"></div><div class="shape circle-1"></div><div class="shape circle-2"></div><div class="shape square-1"></div><div class="shape circle-3"></div><div class="shape triangle-3"></div><div class="shape square-2"></div></div>',2)),s("div",$e,[(n(),_(M,null,K(20,l=>s("div",{class:"particle",key:l,style:be(fe())},null,4)),64))]),t[4]||(t[4]=j('<div class="ripple-effects"><div class="ripple ripple-1"></div><div class="ripple ripple-2"></div><div class="ripple ripple-3"></div><div class="ripple ripple-4"></div><div class="ripple ripple-5"></div></div>',1))]),s("header",Le,[s("div",Be,[s("div",{class:"logo",onClick:V},t[5]||(t[5]=[s("div",{class:"logo-icon"},"ðŸ“š",-1),s("div",{class:"logo-text"},[s("h1",null,"èµ„æºç¤¾åŒº"),s("p",null,"åˆ†äº«ã€å‘çŽ°ã€å­¦ä¹ ")],-1)])),s("div",Re,[a(Ee),w.value?f("",!0):(n(),g(m,{key:0,type:"primary",size:"large",onClick:Y},{default:o(()=>[a(c,null,{default:o(()=>[a(v(J))]),_:1}),t[6]||(t[6]=u(" ç™»å½• "))]),_:1,__:[6]})),w.value?(n(),g(m,{key:1,type:"success",size:"large",onClick:Z},{default:o(()=>[a(c,null,{default:o(()=>[a(v(Ie))]),_:1}),t[7]||(t[7]=u(" ç®¡ç†åŽå° "))]),_:1,__:[7]})):f("",!0)])])]),s("main",Ue,[s("div",He,[a(m,{class:"back-btn",onClick:V,type:"default",plain:""},{default:o(()=>[a(c,null,{default:o(()=>[a(v(Ae))]),_:1}),t[8]||(t[8]=u(" è¿”å›žåˆ—è¡¨ "))]),_:1,__:[8]}),T.value?(n(),_("div",Qe,[a($,{rows:10,animated:""})])):i.value?(n(),_(M,{key:2},[s("div",Ke,[s("div",Je,[s("h1",Oe,d(i.value.name),1),E.value?(n(),g(D,{key:0,class:"resource-category",size:"large",color:se(i.value.category_id)},{default:o(()=>[u(d(E.value),1)]),_:1},8,["color"])):f("",!0)]),s("div",Xe,[s("span",Ge,[a(c,null,{default:o(()=>[a(v(J))]),_:1}),u(" ä½œè€…: "+d(i.value.author),1)]),s("span",We,[a(c,null,{default:o(()=>[a(v(De))]),_:1}),u(" å‘å¸ƒæ—¶é—´: "+d(H(i.value.created_at)),1)]),s("span",Ye,[a(c,null,{default:o(()=>[a(v(O))]),_:1}),u(" ä¸‹è½½æ¬¡æ•°: "+d(i.value.download_count),1)]),s("span",Ze,[a(c,null,{default:o(()=>[a(v(R))]),_:1}),u(" ç‚¹èµžæ•°: "+d(i.value.like_count),1)])])]),a(Q),s("div",et,[s("div",tt,[t[10]||(t[10]=s("h2",null,"èµ„æºæè¿°",-1)),s("div",at,d(i.value.description||"æš‚æ— æè¿°ä¿¡æ¯"),1)]),s("div",st,[a(m,{type:"primary",size:"large",onClick:oe},{default:o(()=>[a(c,null,{default:o(()=>[a(v(O))]),_:1}),t[11]||(t[11]=u(" ä¸‹è½½èµ„æº "))]),_:1,__:[11]}),a(m,{type:"default",size:"large",onClick:le,loading:F.value},{default:o(()=>[a(c,null,{default:o(()=>[a(v(R))]),_:1}),u(" "+d(U.value?"å·²ç‚¹èµž":"ç‚¹èµž"),1)]),_:1},8,["loading"])])]),a(Q),s("div",ot,[s("h2",null,"ç”¨æˆ·è¯„è®º ("+d(C.value.length)+")",1),C.value.length===0?(n(),_("div",lt,t[12]||(t[12]=[s("p",null,"æš‚æ— è¯„è®ºï¼Œæˆä¸ºç¬¬ä¸€ä¸ªè¯„è®ºçš„ç”¨æˆ·å§ï¼",-1)]))):(n(),_("div",nt,[(n(!0),_(M,null,K(C.value,l=>(n(),_("div",{key:l.id,class:"comment-item"},[s("div",rt,[a(ye,{src:l.author_avatar,size:"small",class:"comment-avatar"},{default:o(()=>[u(d((l.author_name||"åŒ¿").charAt(0)),1)]),_:2},1032,["src"]),s("div",it,[s("span",ct,[u(d(l.author_name||"åŒ¿åç”¨æˆ·")+" ",1),ve(l)?(n(),g(D,{key:0,size:"small",type:"warning",class:"ml-1"},{default:o(()=>t[13]||(t[13]=[u("ä½œè€…")])),_:1,__:[13]})):f("",!0),l.pinned?(n(),g(D,{key:1,size:"small",type:"primary",class:"ml-1"},{default:o(()=>t[14]||(t[14]=[u("ç½®é¡¶")])),_:1,__:[14]})):f("",!0)]),l.author_role?(n(),g(D,{key:0,size:"small",type:"success",class:"ml-1"},{default:o(()=>[u(d(W(l.author_role)),1)]),_:2},1024)):f("",!0),l.author_qq?(n(),_("span",ut,"QQ: "+d(l.author_qq),1)):f("",!0)]),s("div",dt,d(H(l.created_at)),1)]),s("div",mt,d(l.content),1),s("div",vt,[a(m,{link:"",size:"small",onClick:L=>re(l.id)},{default:o(()=>[a(c,null,{default:o(()=>[a(v(R))]),_:1}),u(" ç‚¹èµž ("+d(l.likes||0)+") ",1)]),_:2},1032,["onClick"]),w.value?(n(),g(m,{key:0,link:"",size:"small",onClick:L=>ie(l.id)},{default:o(()=>[a(c,null,{default:o(()=>[a(v(Me))]),_:1}),t[15]||(t[15]=u(" å›žå¤ "))]),_:2,__:[15]},1032,["onClick"])):f("",!0),ue(l)?(n(),g(m,{key:1,link:"",size:"small",onClick:L=>ce(l.id)},{default:o(()=>[a(c,null,{default:o(()=>[a(v(Pe))]),_:1}),t[16]||(t[16]=u(" åˆ é™¤ "))]),_:2,__:[16]},1032,["onClick"])):f("",!0),de()?(n(),g(m,{key:2,link:"",size:"small",onClick:L=>me(l)},{default:o(()=>[a(c,null,{default:o(()=>[a(v(Te))]),_:1}),u(" "+d(l.pinned?"å–æ¶ˆç½®é¡¶":"ç½®é¡¶"),1)]),_:2},1032,["onClick"])):f("",!0)])]))),128))])),C.value.length>0?(n(),_("div",_t,[a(he,{"current-page":x.value,"onUpdate:currentPage":t[0]||(t[0]=l=>x.value=l),"page-size":I.value,"onUpdate:pageSize":t[1]||(t[1]=l=>I.value=l),total:S.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:_e,onCurrentChange:pe,background:""},null,8,["current-page","page-size","total"])])):f("",!0),s("div",pt,[t[18]||(t[18]=s("h3",null,"å‘è¡¨è¯„è®º",-1)),w.value?(n(),_(M,{key:1},[a(Ce,{modelValue:k.content,"onUpdate:modelValue":t[2]||(t[2]=l=>k.content=l),type:"textarea",rows:4,placeholder:"è¯·è¾“å…¥æ‚¨çš„è¯„è®º",maxlength:500,"show-word-limit":""},null,8,["modelValue"]),s("div",ft,[a(m,{type:"primary",onClick:ne,loading:N.value,disabled:!k.content},{default:o(()=>t[17]||(t[17]=[u(" æäº¤è¯„è®º ")])),_:1,__:[17]},8,["loading","disabled"])])],64)):(n(),g(ke,{key:0,title:"è¯·å…ˆç™»å½•åŽå†å‘è¡¨è¯„è®º",type:"warning",closable:!1,"show-icon":""}))])])],64)):(n(),_("div",je,[a(ge,{description:"èµ„æºä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤"}),a(m,{type:"primary",onClick:V},{default:o(()=>t[9]||(t[9]=[u("è¿”å›žé¦–é¡µ")])),_:1,__:[9]})]))])])])}}});export{St as default};
