import{x as G,r as p,X as U,y as J,az as P,A as a,H as M,K as B,D as $,Q as o,I as l,u as f,al as y,M as v,V as h,O as Y,ax as Z,z as E}from"../chunks/vue-vendor-BleHOoLr.js";import{l as q,m as O,u as ee,$ as se,a0 as oe,K as i}from"../chunks/element-plus-Cc1YNc_4.js";import{d as ae,s as le,e as re,g as te,f as ne,i as ie,h as A,u as D,_ as de}from"../assets/index-B_N-aWSj.js";import{a as S}from"../chunks/auth-BPpt1DgZ.js";import"../chunks/utils-Dq7h7Pqt.js";const ue={class:"login-container"},ce={class:"login-card"},me={class:"login-form-section"},ge={class:"login-options"},pe={class:"form-options"},fe={class:"code-input-group"},ve={class:"register-link"},_e={class:"footer"},be={class:"theme-toggle"},ye=G({__name:"Login",setup(we){const w=Z(),x=p(),V=p(),_=p(!1),C=p(!1),k=p(!1),m=p("password"),b=p(0),r=U({username:"",password:""}),t=U({email:"",code:""}),K={username:[{required:!0,message:"请输入用户名或邮箱",trigger:"blur"},{min:3,max:50,message:"用户名长度在 3 到 50 个字符",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,max:20,message:"密码长度在 6 到 20 个字符",trigger:"blur"}]},H={email:[{required:!0,message:"请输入邮箱地址",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],code:[{required:!0,message:"请输入验证码",trigger:"blur"},{len:6,message:"验证码为6位数字",trigger:"blur"}]};function T(s){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)}function Q(){b.value=60;const s=setInterval(()=>{b.value--,b.value<=0&&clearInterval(s)},1e3)}async function W(){if(!T(t.email)){i.error("请输入正确的邮箱格式");return}try{C.value=!0;const s=await S.sendLoginCode({email:t.email});s.code===0?(i.success("验证码已发送，请查收邮件"),Q()):i.error(s.message||"发送验证码失败")}catch(s){console.error("发送验证码失败:",s),i.error("发送验证码失败，请稍后重试")}finally{C.value=!1}}async function z(){if(V.value)try{await V.value.validate(),_.value=!0;const s=await S.loginByEmail({email:t.email,code:t.code});s.code===0?F(s,t.email):i.error(s.message||"验证码登录失败")}catch(s){console.error("验证码登录失败:",s),i.error("验证码登录失败，请稍后重试")}finally{_.value=!1}}function F(s,e){console.log("🎉 开始处理登录成功:",s);const g=s.data?.token??"",d=s.data?.user;console.log("📝 登录数据:",{token:g?"存在":"无",user:d}),le(g),re(d?.username||e,g,d),setTimeout(()=>{const u=te(),L=ne(),c=ie();console.log("✅ 登录状态验证:",{savedUserInfo:u,savedToken:L?"存在":"无",isLoggedInStatus:c})},100),k.value&&m.value==="password"?A(!0,{username:r.username,password:r.password}):A(!1),i.success("登录成功，欢迎回来！"),setTimeout(()=>{D.logLogin(e,!0).catch(u=>console.error("记录登录行为失败:",u)),d?.role==="admin"?(console.log("🚀 跳转到管理员后台"),w.push("/admin")):d?.role==="elder"?(console.log("🚀 跳转到长老后台"),w.push("/elder")):(console.log("🚀 跳转到用户后台"),w.push("/user"))},500)}async function I(){if(x.value)try{await x.value.validate(),_.value=!0;const s=await S.login({username:r.username,password:r.password});if(s.code===0){F(s,r.username);return}else D.logLogin(r.username,!1,s.msg||s.message).catch(e=>console.error("记录登录失败行为失败:",e)),i.error(s.msg||s.message||"登录失败，请检查用户名和密码")}catch(s){if(console.error("登录失败:",s),s.response&&s.response.data&&s.response.data.message)i.error(s.response.data.message);else{const e=s instanceof Error?s.message:String(s);e.includes("fetch")||e.includes("network")||e.includes("Failed to fetch")||e.includes("ERR_NETWORK")||e.includes("ERR_CONNECTION_REFUSED")||e.includes("Service unavailable")?i.error("服务连接失败，请检查网络连接"):i.error("登录失败，请稍后重试")}}finally{_.value=!1}}const R=ae();R&&(r.username=R.username||"",r.password=R.password||"",k.value=!0);function X(){w.push("/register")}function j(){w.push("/forgot-password")}return(s,e)=>{const g=y("el-icon"),d=y("el-input"),u=y("el-form-item"),L=y("el-checkbox"),c=y("el-button"),N=y("el-form");return E(),J("div",ue,[e[17]||(e[17]=P('<div class="animated-background" data-v-b3a36247><div class="gradient-circle circle-1" data-v-b3a36247></div><div class="gradient-circle circle-2" data-v-b3a36247></div><div class="gradient-circle circle-3" data-v-b3a36247></div><div class="pattern-grid" data-v-b3a36247></div></div>',1)),a("div",ce,[a("div",me,[e[15]||(e[15]=a("div",{class:"login-header"},[a("h2",{class:"login-title"},"欢迎回来"),a("p",{class:"login-subtitle"},"登录您的账号继续访问")],-1)),a("div",ge,[a("div",{class:$(["login-option",{active:m.value==="password"}]),onClick:e[0]||(e[0]=n=>m.value="password")},[o(g,null,{default:l(()=>[o(f(q))]),_:1}),e[7]||(e[7]=a("span",null,"密码登录",-1))],2),a("div",{class:$(["login-option",{active:m.value==="code"}]),onClick:e[1]||(e[1]=n=>m.value="code")},[o(g,null,{default:l(()=>[o(f(O))]),_:1}),e[8]||(e[8]=a("span",null,"验证码登录",-1))],2)]),m.value==="password"?(E(),M(N,{key:0,ref_key:"loginFormRef",ref:x,model:r,rules:K,class:"form",onSubmit:h(I,["prevent"])},{default:l(()=>[o(u,{prop:"username"},{default:l(()=>[o(d,{modelValue:r.username,"onUpdate:modelValue":e[2]||(e[2]=n=>r.username=n),placeholder:"用户名或邮箱","prefix-icon":f(ee),size:"large",clearable:""},null,8,["modelValue","prefix-icon"])]),_:1}),o(u,{prop:"password"},{default:l(()=>[o(d,{modelValue:r.password,"onUpdate:modelValue":e[3]||(e[3]=n=>r.password=n),type:"password",placeholder:"密码","prefix-icon":f(q),size:"large","show-password":"",clearable:""},null,8,["modelValue","prefix-icon"])]),_:1}),a("div",pe,[o(L,{modelValue:k.value,"onUpdate:modelValue":e[4]||(e[4]=n=>k.value=n)},{default:l(()=>e[9]||(e[9]=[v("记住我")])),_:1,__:[9]},8,["modelValue"]),o(c,{type:"primary",text:"",onClick:j},{default:l(()=>e[10]||(e[10]=[v("忘记密码?")])),_:1,__:[10]})]),o(c,{type:"primary",size:"large",class:"submit-button",loading:_.value,onClick:I},{default:l(()=>e[11]||(e[11]=[v(" 登录 ")])),_:1,__:[11]},8,["loading"])]),_:1},8,["model"])):B("",!0),m.value==="code"?(E(),M(N,{key:1,ref_key:"codeFormRef",ref:V,model:t,rules:H,class:"form",onSubmit:h(z,["prevent"])},{default:l(()=>[o(u,{prop:"email"},{default:l(()=>[o(d,{modelValue:t.email,"onUpdate:modelValue":e[5]||(e[5]=n=>t.email=n),placeholder:"邮箱","prefix-icon":f(O),size:"large",clearable:""},null,8,["modelValue","prefix-icon"])]),_:1}),o(u,{prop:"code"},{default:l(()=>[a("div",fe,[o(d,{modelValue:t.code,"onUpdate:modelValue":e[6]||(e[6]=n=>t.code=n),placeholder:"验证码","prefix-icon":f(se),size:"large",clearable:""},null,8,["modelValue","prefix-icon"]),o(c,{type:"primary",loading:C.value,disabled:!T(t.email)||b.value>0,onClick:W,class:"send-code-btn"},{default:l(()=>[v(Y(b.value>0?`${b.value}s`:"获取验证码"),1)]),_:1},8,["loading","disabled"])])]),_:1}),o(c,{type:"primary",size:"large",class:"submit-button",loading:_.value,onClick:z},{default:l(()=>e[12]||(e[12]=[v(" 登录 ")])),_:1,__:[12]},8,["loading"])]),_:1},8,["model"])):B("",!0),a("div",ve,[e[14]||(e[14]=v(" 还没有账号? ")),o(c,{type:"primary",text:"",onClick:X},{default:l(()=>e[13]||(e[13]=[v("立即注册")])),_:1,__:[13]})])])]),a("div",_e,[a("div",be,[o(c,{type:"primary",text:""},{default:l(()=>[o(g,null,{default:l(()=>[o(f(oe))]),_:1})]),_:1})]),e[16]||(e[16]=a("div",{class:"copyright"},"© 2024 智圆社区 版本1.2.0",-1))])])}}}),Le=de(ye,[["__scopeId","data-v-b3a36247"]]);export{Le as default};
