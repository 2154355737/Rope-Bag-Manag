import{e as ae,u as le,x as ne,m as ie,X as re,f as ce,H as _,E as H}from"../chunks/element-plus-hGoKm610.js";import{_ as ue}from"../assets/index-C28i2SJl.js";import{c as de}from"../chunks/categories-BRHoYYyG.js";import{s as w}from"../chunks/subscriptions-Cah8BEmo.js";import{x as pe,r as u,X as _e,j as fe,y as z,A as l,Q as t,I as s,al as i,O as f,u as y,J,ar as me,H as L,M as m,K as be,P as ve,a6 as ge,z as k}from"../chunks/vue-vendor-BleHOoLr.js";import"../chunks/utils-Dq7h7Pqt.js";const we={class:"subscription-manage"},ye={class:"stat-content"},ke={class:"stat-number"},he={class:"stat-content"},Ce={class:"stat-number"},Ve={class:"stat-content"},xe={class:"stat-number"},Se={class:"stat-content"},$e={class:"stat-number"},Ue={class:"card-header"},Be={class:"card-actions"},Ne={class:"resource-count"},Re={class:"subscription-count"},ze={class:"rate-text"},Le={key:0},Te={class:"dialog-footer"},Me=pe({__name:"SubscriptionManage",setup(De){const S=u(!1),$=u(!1),U=u(!1),h=u(!1),B=u(!1),V=u(0),T=u(0),M=u(0),D=u(0),C=u([]),j=u([]),v=u(null),d=_e({category_id:0,title:"",content:""}),X={category_id:[{required:!0,message:"请选择目标分类",trigger:"change"}],title:[{required:!0,message:"请输入通知标题",trigger:"blur"}],content:[{required:!0,message:"请输入通知内容",trigger:"blur"}]},x=async()=>{S.value=!0;try{const a=await de.getCategories();if(a.code===0&&a.data){const e=a.data.list||[];M.value=e.length;const r=e.map(async n=>{try{const g=await w.getCategorySubscriptions(n.id);return{...n,subscription_count:g.data?.count||0,resource_count:0,subscription_locked:n.subscription_locked||!1}}catch{return{...n,subscription_count:0,resource_count:0,subscription_locked:n.subscription_locked||!1}}});C.value=await Promise.all(r),V.value=C.value.reduce((n,g)=>n+g.subscription_count,0);const p=new Set;for(const n of C.value)n.subscription_count>0&&p.add(n.subscription_count);T.value=1}}catch(a){console.error("加载订阅统计失败:",a),_.error("加载订阅统计失败")}finally{S.value=!1}},K=a=>{const e=["primary","success","warning","info","danger"];return e[a%e.length]},E=a=>V.value===0?0:Math.round(a/V.value*100),O=async a=>{v.value=a,U.value=!0,$.value=!0;try{const e=await w.getCategorySubscribers(a.id);e.code===0&&(j.value=e.data?.subscribers||[])}catch(e){console.error("获取订阅者失败:",e),_.error("获取订阅者失败")}finally{$.value=!1}},Q=async a=>{try{if(await H.confirm("确定要取消该用户的订阅吗？","确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),!v.value){_.error("未选择分类");return}(await w.adminUnsubscribe(a,v.value.id)).code===0&&(_.success("取消订阅成功"),O(v.value),x())}catch(e){e!=="cancel"&&(console.error("取消订阅失败:",e),_.error("取消订阅失败"))}},G=a=>{d.category_id=a.id,d.title=`${a.name} 分类更新通知`,d.content=`亲爱的用户，${a.name} 分类有新的内容更新，快来查看吧！`,h.value=!0},W=async()=>{try{B.value=!0,(await w.sendCategoryNotification(d)).code===0&&(_.success("通知发送成功"),h.value=!1,D.value+=1)}catch(a){console.error("发送通知失败:",a),_.error("发送通知失败")}finally{B.value=!1}},Y=async()=>{try{const a=await w.exportSubscriptions();if(a.code===0){const e=new Blob([JSON.stringify(a.data,null,2)],{type:"application/json"}),r=window.URL.createObjectURL(e),p=document.createElement("a");p.href=r,p.download=`subscriptions_${new Date().toISOString().split("T")[0]}.json`,p.click(),window.URL.revokeObjectURL(r),_.success("订阅数据导出成功")}}catch(a){console.error("导出失败:",a),_.error("导出失败")}},Z=async a=>{try{const e=a.subscription_locked?"解锁":"锁定";await H.confirm(`确定要${e}该分类的订阅功能吗？${e}后用户将${a.subscription_locked?"可以":"无法"}订阅/取消订阅该分类。`,`确认${e}`,{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await w.toggleCategoryLock(a.id,!a.subscription_locked)).code===0&&(_.success(`${e}成功`),x())}catch(e){e!=="cancel"&&(console.error("操作失败:",e),_.error("操作失败"))}};return fe(()=>{x()}),(a,e)=>{const r=i("el-icon"),p=i("el-card"),n=i("el-col"),g=i("el-row"),b=i("el-button"),q=i("el-tag"),c=i("el-table-column"),ee=i("el-progress"),A=i("el-table"),F=i("el-dialog"),te=i("el-option"),se=i("el-select"),N=i("el-form-item"),I=i("el-input"),oe=i("el-form"),P=me("loading");return k(),z("div",we,[e[18]||(e[18]=l("div",{class:"page-header"},[l("h2",null,"订阅管理"),l("p",{class:"page-description"},"管理用户的分类订阅和通知设置")],-1)),t(g,{gutter:20,class:"stats-row"},{default:s(()=>[t(n,{span:6},{default:s(()=>[t(p,{shadow:"hover",class:"stat-card"},{default:s(()=>[l("div",ye,[l("div",ke,f(V.value),1),e[6]||(e[6]=l("div",{class:"stat-label"},"总订阅数",-1))]),t(r,{class:"stat-icon"},{default:s(()=>[t(y(ae))]),_:1})]),_:1})]),_:1}),t(n,{span:6},{default:s(()=>[t(p,{shadow:"hover",class:"stat-card"},{default:s(()=>[l("div",he,[l("div",Ce,f(T.value),1),e[7]||(e[7]=l("div",{class:"stat-label"},"活跃订阅用户",-1))]),t(r,{class:"stat-icon"},{default:s(()=>[t(y(le))]),_:1})]),_:1})]),_:1}),t(n,{span:6},{default:s(()=>[t(p,{shadow:"hover",class:"stat-card"},{default:s(()=>[l("div",Ve,[l("div",xe,f(M.value),1),e[8]||(e[8]=l("div",{class:"stat-label"},"可订阅分类",-1))]),t(r,{class:"stat-icon"},{default:s(()=>[t(y(ne))]),_:1})]),_:1})]),_:1}),t(n,{span:6},{default:s(()=>[t(p,{shadow:"hover",class:"stat-card"},{default:s(()=>[l("div",Se,[l("div",$e,f(D.value),1),e[9]||(e[9]=l("div",{class:"stat-label"},"已发送通知",-1))]),t(r,{class:"stat-icon"},{default:s(()=>[t(y(ie))]),_:1})]),_:1})]),_:1})]),_:1}),t(p,{shadow:"hover",class:"action-card"},{header:s(()=>[l("div",Ue,[e[12]||(e[12]=l("span",null,"分类订阅统计",-1)),l("div",Be,[t(b,{type:"primary",size:"small",onClick:x},{default:s(()=>[t(r,null,{default:s(()=>[t(y(re))]),_:1}),e[10]||(e[10]=m(" 刷新统计 "))]),_:1,__:[10]}),t(b,{type:"success",size:"small",onClick:Y},{default:s(()=>[t(r,null,{default:s(()=>[t(y(ce))]),_:1}),e[11]||(e[11]=m(" 导出数据 "))]),_:1,__:[11]})])])]),default:s(()=>[J((k(),L(A,{data:C.value,style:{width:"100%"}},{default:s(()=>[t(c,{prop:"name",label:"分类名称","min-width":"120"},{default:s(({row:o})=>[t(q,{type:K(o.id)},{default:s(()=>[m(f(o.name),1)]),_:2},1032,["type"])]),_:1}),t(c,{prop:"description",label:"分类描述","show-overflow-tooltip":""}),t(c,{prop:"resource_count",label:"资源数量",width:"100",align:"center"},{default:s(({row:o})=>[l("span",Ne,f(o.resource_count),1)]),_:1}),t(c,{prop:"subscription_count",label:"订阅用户数",width:"120",align:"center"},{default:s(({row:o})=>[l("span",Re,f(o.subscription_count),1)]),_:1}),t(c,{label:"订阅率",width:"100",align:"center"},{default:s(({row:o})=>[t(ee,{percentage:E(o.subscription_count),"stroke-width":8,"show-text":!1},null,8,["percentage"]),l("span",ze,f(E(o.subscription_count))+"%",1)]),_:1}),t(c,{label:"订阅状态",width:"120",align:"center"},{default:s(({row:o})=>[t(q,{type:o.subscription_locked?"danger":"success",size:"small"},{default:s(()=>[m(f(o.subscription_locked?"已锁定":"可订阅"),1)]),_:2},1032,["type"])]),_:1}),t(c,{label:"操作",width:"280",align:"center"},{default:s(({row:o})=>[t(b,{type:"primary",size:"small",onClick:R=>O(o)},{default:s(()=>e[13]||(e[13]=[m(" 查看订阅者 ")])),_:2,__:[13]},1032,["onClick"]),t(b,{type:"warning",size:"small",onClick:R=>G(o)},{default:s(()=>e[14]||(e[14]=[m(" 发送通知 ")])),_:2,__:[14]},1032,["onClick"]),t(b,{type:o.subscription_locked?"success":"danger",size:"small",onClick:R=>Z(o)},{default:s(()=>[m(f(o.subscription_locked?"解锁":"锁定"),1)]),_:2},1032,["type","onClick"])]),_:1})]),_:1},8,["data"])),[[P,S.value]])]),_:1}),t(F,{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=o=>U.value=o),title:"订阅用户详情",width:"800px"},{default:s(()=>[v.value?(k(),z("div",Le,[l("h4",null,f(v.value.name)+" - 订阅用户列表",1),J((k(),L(A,{data:j.value,style:{width:"100%"}},{default:s(()=>[t(c,{prop:"username",label:"用户名",width:"150"}),t(c,{prop:"nickname",label:"昵称",width:"150"}),t(c,{prop:"email",label:"邮箱","show-overflow-tooltip":""}),t(c,{prop:"subscribed_at",label:"订阅时间",width:"180"}),t(c,{label:"操作",width:"100",align:"center"},{default:s(({row:o})=>[t(b,{type:"danger",size:"small",onClick:R=>Q(o.user_id)},{default:s(()=>e[15]||(e[15]=[m(" 取消订阅 ")])),_:2,__:[15]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[P,$.value]])])):be("",!0)]),_:1},8,["modelValue"]),t(F,{modelValue:h.value,"onUpdate:modelValue":e[5]||(e[5]=o=>h.value=o),title:"发送分类通知",width:"600px"},{footer:s(()=>[l("div",Te,[t(b,{onClick:e[4]||(e[4]=o=>h.value=!1)},{default:s(()=>e[16]||(e[16]=[m("取消")])),_:1,__:[16]}),t(b,{type:"primary",onClick:W,loading:B.value},{default:s(()=>e[17]||(e[17]=[m(" 发送通知 ")])),_:1,__:[17]},8,["loading"])])]),default:s(()=>[t(oe,{model:d,rules:X,ref:"notificationFormRef","label-width":"100px"},{default:s(()=>[t(N,{label:"目标分类",prop:"category_id"},{default:s(()=>[t(se,{modelValue:d.category_id,"onUpdate:modelValue":e[1]||(e[1]=o=>d.category_id=o),placeholder:"选择分类",style:{width:"100%"}},{default:s(()=>[(k(!0),z(ve,null,ge(C.value,o=>(k(),L(te,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(N,{label:"通知标题",prop:"title"},{default:s(()=>[t(I,{modelValue:d.title,"onUpdate:modelValue":e[2]||(e[2]=o=>d.title=o),placeholder:"请输入通知标题"},null,8,["modelValue"])]),_:1}),t(N,{label:"通知内容",prop:"content"},{default:s(()=>[t(I,{modelValue:d.content,"onUpdate:modelValue":e[3]||(e[3]=o=>d.content=o),type:"textarea",rows:4,placeholder:"请输入通知内容"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Ie=ue(Me,[["__scopeId","data-v-610e85cb"]]);export{Ie as default};
