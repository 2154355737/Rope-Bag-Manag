import{a7 as $e,U as He,j as Pe,a8 as Fe,i as Oe,a9 as Le,W as Re,q as je,a4 as We,L as ne,Y as oe,aa as Ee,H as d,E as V}from"../chunks/element-plus-hGoKm610.js";import{c as h}from"../chunks/comments-DzfIAI4A.js";import{a as q,j as Me,_ as Be}from"../assets/index-C28i2SJl.js";import{p as Ne}from"../chunks/packages-CAyrDzlu.js";import{x as qe,r as m,X as de,c as P,j as Ke,y as F,A as l,K,Q as t,I as s,u as f,al as v,M as r,O as i,J as Je,ar as Qe,H as O,P as Xe,a6 as Ye,z as k}from"../chunks/vue-vendor-BleHOoLr.js";import"../chunks/utils-Dq7h7Pqt.js";const J={getAll(){return q.get("/v1/forbidden-words")},add(U){return q.post("/v1/forbidden-words",{word:U})},delete(U){return q.delete(`/v1/forbidden-words/${U}`)}},Ge={class:"admin-page comment-manage"},Ze={class:"page-header"},et={class:"header-content"},tt={class:"header-left"},at={class:"header-icon"},lt={class:"header-actions"},st={class:"stats-section"},nt={class:"stats-grid"},ot={class:"stat-card"},dt={class:"stat-icon"},it={class:"stat-content"},rt={class:"stat-number"},ut={class:"stat-card"},ct={class:"stat-icon"},_t={class:"stat-content"},pt={class:"stat-number"},mt={class:"stat-card"},ft={class:"stat-icon"},vt={class:"stat-content"},gt={class:"stat-number"},bt={class:"stat-card"},yt={class:"stat-icon"},Ct={class:"stat-content"},wt={class:"stat-number"},ht={class:"search-section"},kt={class:"search-left"},Vt={class:"search-right"},Dt={class:"table-section"},At={class:"comment-content"},xt={class:"content-text"},zt={class:"content-meta"},Ut={class:"time"},St={class:"likes"},It={class:"dislikes"},Tt={class:"pagination-section"},$t={key:0,class:"batch-actions"},Ht={class:"selected-count"},Pt={key:0,class:"comment-detail"},Ft={class:"detail-item"},Ot={class:"detail-item"},Lt={class:"detail-item"},Rt={class:"detail-item"},jt={class:"detail-item"},Wt={class:"content-box"},Et={class:"detail-item"},Mt={class:"detail-item"},Bt={class:"detail-item"},Nt={class:"detail-item"},qt={class:"detail-item"},Kt={class:"mb-3"},Jt=qe({__name:"CommentManage",setup(U){const D=m([]),L=m(!1),R=m(0),A=m(1),S=m(10),g=m([]),_=de({status:"Active",target_type:"",user_id:"",date_range:[]}),b=m(null),I=m(!1),x=m(!1),p=de({content:"",resource_id:null,parent_id:null,target_type:"Package"}),Q=m([]),X=m(!1),j=m(!1),Y=m([]),z=m(""),ie=P(()=>R.value||0),re=P(()=>D.value.filter(a=>a.status==="Active").length),ue=P(()=>D.value.filter(a=>a.status==="Hidden").length),ce=P(()=>{const a=new Date;return a.setHours(0,0,0,0),D.value.filter(e=>new Date(e.created_at)>=a).length});async function G(a=!1){if(!(X.value&&!a))try{const e=await Ne.getPackages({pageSize:100});e.code===0&&e.data&&(Q.value=e.data.list||[],X.value=!0)}catch(e){console.error("加载资源列表失败:",e)}}const T={logResourceOperation(a,e,o,u,c){try{Me.logResourceAction(o,e).catch(w=>console.warn("记录操作失败:",w))}catch(w){console.error("记录操作失败:",w)}}};async function y(){L.value=!0;try{const a={page:A.value,size:S.value};Object.keys(_).forEach(o=>{const c=_[o];c!=null&&c!==""&&(a[o]=c)}),_.date_range&&_.date_range.length===2&&(a.start_date=_.date_range[0],a.end_date=_.date_range[1]);const e=await h.getAllComments(a);e.code===0&&e.data&&(D.value=e.data.list||[],R.value=e.data.total||0)}catch(a){console.error("加载评论失败:",a),d.error("加载评论失败")}finally{L.value=!1}}function Z(){A.value=1,y()}function _e(){Object.assign(_,{status:"Active",target_type:"",user_id:"",date_range:[]}),Z()}function pe(a){g.value=a}function me(a){S.value=a,y()}function fe(a){A.value=a,y()}function ve(a){b.value=a,I.value=!0}async function ge(a){try{await V.confirm("确定要隐藏这条评论吗？","确认操作"),(await h.updateComment(a.id,{status:"Hidden"})).code===0&&(d.success("评论已隐藏"),y(),T.logResourceOperation("Comment","hide",a.id,a.target_id,a.target_type))}catch(e){e!=="cancel"&&d.error("操作失败")}}async function be(a){try{await V.confirm("确定要显示这条评论吗？","确认操作"),(await h.updateComment(a.id,{status:"Active"})).code===0&&(d.success("评论已显示"),y(),T.logResourceOperation("Comment","show",a.id,a.target_id,a.target_type))}catch(e){e!=="cancel"&&d.error("操作失败")}}async function ye(a){try{await V.confirm("确定要删除这条评论吗？此操作不可恢复！","确认删除",{type:"warning"}),(await h.deleteComment(a.id)).code===0&&(d.success("评论已删除"),y(),T.logResourceOperation("Comment","delete",a.id,a.target_id,a.target_type))}catch(e){e!=="cancel"&&d.error("删除失败")}}async function Ce(){if(g.value.length===0){d.warning("请选择要操作的评论");return}try{await V.confirm(`确定要隐藏选中的 ${g.value.length} 条评论吗？`,"确认操作");const a=g.value.map(o=>o.id),e=await h.batchUpdateStatus(a,"Hidden");e.code===0?(d.success("批量隐藏成功"),y()):d.error(e.message||"操作失败")}catch(a){a!=="cancel"&&d.error("操作失败")}}async function we(){if(g.value.length===0){d.warning("请选择要操作的评论");return}try{await V.confirm(`确定要显示选中的 ${g.value.length} 条评论吗？`,"确认操作");const a=g.value.map(o=>o.id),e=await h.batchUpdateStatus(a,"Active");e.code===0?(d.success("批量显示成功"),y()):d.error(e.message||"操作失败")}catch(a){a!=="cancel"&&d.error("操作失败")}}async function ee(){if(g.value.length===0){d.warning("请选择要操作的评论");return}try{await V.confirm(`确定要删除选中的 ${g.value.length} 条评论吗？此操作不可恢复！`,"确认删除",{type:"warning"});const a=g.value.map(o=>o.id),e=await h.batchDeleteComments(a);e.code===0?(d.success("批量删除成功"),y()):d.error(e.message||"删除失败")}catch(a){a!=="cancel"&&d.error("删除失败")}}function he(){Object.assign(p,{content:"",resource_id:null,parent_id:null}),x.value=!0,G(!0)}async function ke(){if(!p.content||!p.resource_id){d.warning("请填写完整的评论信息");return}try{const a=await h.createComment({content:p.content,target_id:p.resource_id,target_type:"Package"});if(a.code===0){d.success("评论添加成功"),x.value=!1,y();const e=a.data?.id||0;T.logResourceOperation("Comment","add",e,p.resource_id,"Package")}else d.error(`添加失败: ${a.message}`)}catch(a){console.error("添加评论失败:",a),d.error("添加评论失败")}}function Ve(a){return{Package:"primary",User:"success",System:"info"}[a]||"info"}function te(a){return{Package:"绳包",User:"用户",System:"系统"}[a]||a}function ae(a){return{Active:"success",Hidden:"warning",Deleted:"danger"}[a]||"info"}function le(a){return{Active:"正常",Hidden:"隐藏",Deleted:"已删除"}[a]||a}function W(a){return a?new Date(a).toLocaleString():"-"}const De=async()=>{j.value=!0,await E()},E=async()=>{const a=await J.getAll();if(a.code===0){const e=(a.data||[]).map(o=>Array.isArray(o)&&o.length===2?{id:o[0],word:o[1]}:o);Y.value=e}},Ae=async()=>{if(!z.value.trim())return;(await J.add(z.value.trim())).code===0&&(d.success("添加成功"),z.value="",E())},xe=async a=>{(await J.delete(a)).code===0&&(d.success("已删除"),E())};return Ke(()=>{y()}),(a,e)=>{const o=v("el-icon"),u=v("el-button"),c=v("el-option"),w=v("el-select"),M=v("el-input"),ze=v("el-date-picker"),C=v("el-table-column"),B=v("el-tag"),se=v("el-table"),Ue=v("el-pagination"),N=v("el-dialog"),$=v("el-form-item"),Se=v("el-input-number"),Ie=v("el-form"),Te=Qe("loading");return k(),F("div",Ge,[l("div",Ze,[l("div",et,[l("div",tt,[l("div",at,[t(o,{size:32},{default:s(()=>[t(f($e))]),_:1})]),e[16]||(e[16]=l("div",{class:"header-info"},[l("h1",{class:"page-title"},"评论管理"),l("p",{class:"page-subtitle"},"管理系统中的用户评论，包括审核、删除、回复等功能")],-1))]),l("div",lt,[t(u,{type:"primary",onClick:he},{default:s(()=>[t(o,null,{default:s(()=>[t(f(He))]),_:1}),e[17]||(e[17]=r(" 添加评论 "))]),_:1,__:[17]}),t(u,{onClick:De},{default:s(()=>[t(o,null,{default:s(()=>[t(f(Pe))]),_:1}),e[18]||(e[18]=r(" 违禁词配置 "))]),_:1,__:[18]})])])]),l("div",st,[l("div",nt,[l("div",ot,[l("div",dt,[t(o,{size:24},{default:s(()=>[t(f(Fe))]),_:1})]),l("div",it,[l("div",rt,i(ie.value),1),e[19]||(e[19]=l("div",{class:"stat-label"},"总评论数",-1))])]),l("div",ut,[l("div",ct,[t(o,{size:24},{default:s(()=>[t(f(Oe))]),_:1})]),l("div",_t,[l("div",pt,i(re.value),1),e[20]||(e[20]=l("div",{class:"stat-label"},"正常评论",-1))])]),l("div",mt,[l("div",ft,[t(o,{size:24},{default:s(()=>[t(f(Le))]),_:1})]),l("div",vt,[l("div",gt,i(ue.value),1),e[21]||(e[21]=l("div",{class:"stat-label"},"隐藏评论",-1))])]),l("div",bt,[l("div",yt,[t(o,{size:24},{default:s(()=>[t(f(Re))]),_:1})]),l("div",Ct,[l("div",wt,i(ce.value),1),e[22]||(e[22]=l("div",{class:"stat-label"},"今日新增",-1))])])])]),l("div",ht,[l("div",kt,[t(w,{modelValue:_.status,"onUpdate:modelValue":e[0]||(e[0]=n=>_.status=n),placeholder:"评论状态",clearable:"",style:{width:"150px"}},{default:s(()=>[t(c,{label:"正常",value:"Active"}),t(c,{label:"隐藏",value:"Hidden"}),t(c,{label:"已删除",value:"Deleted"})]),_:1},8,["modelValue"]),t(w,{modelValue:_.target_type,"onUpdate:modelValue":e[1]||(e[1]=n=>_.target_type=n),placeholder:"目标类型",clearable:"",style:{width:"150px"}},{default:s(()=>[t(c,{label:"绳包",value:"Package"}),t(c,{label:"用户",value:"User"}),t(c,{label:"系统",value:"System"})]),_:1},8,["modelValue"]),t(M,{modelValue:_.user_id,"onUpdate:modelValue":e[2]||(e[2]=n=>_.user_id=n),placeholder:"输入用户ID",clearable:"",style:{width:"150px"}},null,8,["modelValue"]),t(ze,{modelValue:_.date_range,"onUpdate:modelValue":e[3]||(e[3]=n=>_.date_range=n),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",clearable:"",style:{width:"350px"}},null,8,["modelValue"])]),l("div",Vt,[t(u,{type:"primary",onClick:Z},{default:s(()=>[t(o,null,{default:s(()=>[t(f(je))]),_:1}),e[23]||(e[23]=r(" 筛选 "))]),_:1,__:[23]}),t(u,{onClick:_e},{default:s(()=>[t(o,null,{default:s(()=>[t(f(We))]),_:1}),e[24]||(e[24]=r(" 重置 "))]),_:1,__:[24]}),t(u,{type:"danger",onClick:ee,disabled:g.value.length===0},{default:s(()=>[t(o,null,{default:s(()=>[t(f(ne))]),_:1}),e[25]||(e[25]=r(" 批量删除 "))]),_:1,__:[25]},8,["disabled"])])]),l("div",Dt,[Je((k(),O(se,{data:D.value,style:{width:"100%"},"header-cell-style":{background:"var(--bg-secondary)",color:"var(--text-primary)"},"row-style":{background:"var(--bg-card)"},border:"",stripe:"",onSelectionChange:pe},{default:s(()=>[t(C,{type:"selection",width:"55"}),t(C,{prop:"id",label:"ID",width:"80"}),t(C,{prop:"user_id",label:"用户",width:"120"}),t(C,{prop:"target_type",label:"目标类型",width:"100"},{default:s(({row:n})=>[t(B,{type:Ve(n.target_type)},{default:s(()=>[r(i(te(n.target_type)),1)]),_:2},1032,["type"])]),_:1}),t(C,{prop:"target_id",label:"目标ID",width:"100"}),t(C,{prop:"content",label:"评论内容","min-width":"200"},{default:s(({row:n})=>[l("div",At,[l("p",xt,i(n.content),1),l("div",zt,[l("span",Ut,i(W(n.create_time)),1),l("span",St,"👍 "+i(n.likes),1),l("span",It,"👎 "+i(n.dislikes),1)])])]),_:1}),t(C,{prop:"status",label:"状态",width:"100"},{default:s(({row:n})=>[t(B,{type:ae(n.status)},{default:s(()=>[r(i(le(n.status)),1)]),_:2},1032,["type"])]),_:1}),t(C,{label:"操作",width:"200",fixed:"right"},{default:s(({row:n})=>[t(u,{size:"small",onClick:H=>ve(n)},{default:s(()=>[t(o,null,{default:s(()=>[t(f(oe))]),_:1}),e[26]||(e[26]=r(" 查看 "))]),_:2,__:[26]},1032,["onClick"]),n.status==="Active"?(k(),O(u,{key:0,size:"small",type:"warning",onClick:H=>ge(n)},{default:s(()=>[t(o,null,{default:s(()=>[t(f(Ee))]),_:1}),e[27]||(e[27]=r(" 隐藏 "))]),_:2,__:[27]},1032,["onClick"])):n.status==="Hidden"?(k(),O(u,{key:1,size:"small",type:"success",onClick:H=>be(n)},{default:s(()=>[t(o,null,{default:s(()=>[t(f(oe))]),_:1}),e[28]||(e[28]=r(" 显示 "))]),_:2,__:[28]},1032,["onClick"])):K("",!0),t(u,{size:"small",type:"danger",onClick:H=>ye(n)},{default:s(()=>[t(o,null,{default:s(()=>[t(f(ne))]),_:1}),e[29]||(e[29]=r(" 删除 "))]),_:2,__:[29]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Te,L.value]])]),l("div",Tt,[t(Ue,{"current-page":A.value,"onUpdate:currentPage":e[4]||(e[4]=n=>A.value=n),"page-size":S.value,"onUpdate:pageSize":e[5]||(e[5]=n=>S.value=n),"page-sizes":[10,20,50,100],total:R.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:me,onCurrentChange:fe},null,8,["current-page","page-size","total"])]),g.value.length>0?(k(),F("div",$t,[t(u,{type:"warning",onClick:Ce},{default:s(()=>e[30]||(e[30]=[r("批量隐藏")])),_:1,__:[30]}),t(u,{type:"success",onClick:we},{default:s(()=>e[31]||(e[31]=[r("批量显示")])),_:1,__:[31]}),t(u,{type:"danger",onClick:ee},{default:s(()=>e[32]||(e[32]=[r("批量删除")])),_:1,__:[32]}),l("span",Ht,"已选择 "+i(g.value.length)+" 条评论",1)])):K("",!0),t(N,{modelValue:I.value,"onUpdate:modelValue":e[7]||(e[7]=n=>I.value=n),title:"评论详情",width:"600px"},{footer:s(()=>[t(u,{onClick:e[6]||(e[6]=n=>I.value=!1)},{default:s(()=>e[43]||(e[43]=[r("关闭")])),_:1,__:[43]})]),default:s(()=>[b.value?(k(),F("div",Pt,[l("div",Ft,[e[33]||(e[33]=l("label",null,"评论ID:",-1)),l("span",null,i(b.value.id),1)]),l("div",Ot,[e[34]||(e[34]=l("label",null,"用户ID:",-1)),l("span",null,i(b.value.user_id),1)]),l("div",Lt,[e[35]||(e[35]=l("label",null,"目标类型:",-1)),l("span",null,i(te(b.value.target_type)),1)]),l("div",Rt,[e[36]||(e[36]=l("label",null,"目标ID:",-1)),l("span",null,i(b.value.target_id),1)]),l("div",jt,[e[37]||(e[37]=l("label",null,"评论内容:",-1)),l("div",Wt,i(b.value.content),1)]),l("div",Et,[e[38]||(e[38]=l("label",null,"创建时间:",-1)),l("span",null,i(W(b.value.created_at)),1)]),l("div",Mt,[e[39]||(e[39]=l("label",null,"更新时间:",-1)),l("span",null,i(W(b.value.updated_at)),1)]),l("div",Bt,[e[40]||(e[40]=l("label",null,"点赞数:",-1)),l("span",null,i(b.value.likes),1)]),l("div",Nt,[e[41]||(e[41]=l("label",null,"点踩数:",-1)),l("span",null,i(b.value.dislikes),1)]),l("div",qt,[e[42]||(e[42]=l("label",null,"状态:",-1)),t(B,{type:ae(b.value.status)},{default:s(()=>[r(i(le(b.value.status)),1)]),_:1},8,["type"])])])):K("",!0)]),_:1},8,["modelValue"]),t(N,{modelValue:x.value,"onUpdate:modelValue":e[13]||(e[13]=n=>x.value=n),title:"添加评论",width:"600px"},{footer:s(()=>[t(u,{onClick:e[12]||(e[12]=n=>x.value=!1)},{default:s(()=>e[44]||(e[44]=[r("取消")])),_:1,__:[44]}),t(u,{type:"primary",onClick:ke},{default:s(()=>e[45]||(e[45]=[r("确定")])),_:1,__:[45]})]),default:s(()=>[t(Ie,{model:p,"label-width":"100px"},{default:s(()=>[t($,{label:"评论内容"},{default:s(()=>[t(M,{type:"textarea",modelValue:p.content,"onUpdate:modelValue":e[8]||(e[8]=n=>p.content=n),rows:"4"},null,8,["modelValue"])]),_:1}),t($,{label:"评论身份"},{default:s(()=>[t(w,{modelValue:p.target_type,"onUpdate:modelValue":e[9]||(e[9]=n=>p.target_type=n),placeholder:"选择身份"},{default:s(()=>[t(c,{label:"管理员",value:"Admin"}),t(c,{label:"元老",value:"Elder"}),t(c,{label:"普通用户",value:"User"})]),_:1},8,["modelValue"])]),_:1}),t($,{label:"选择资源"},{default:s(()=>[t(w,{modelValue:p.resource_id,"onUpdate:modelValue":e[10]||(e[10]=n=>p.resource_id=n),filterable:"",placeholder:"选择资源",onVisibleChange:G},{default:s(()=>[(k(!0),F(Xe,null,Ye(Q.value,n=>(k(),O(c,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t($,{label:"父评论ID"},{default:s(()=>[t(Se,{modelValue:p.parent_id,"onUpdate:modelValue":e[11]||(e[11]=n=>p.parent_id=n),placeholder:"输入父评论ID"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(N,{modelValue:j.value,"onUpdate:modelValue":e[15]||(e[15]=n=>j.value=n),title:"违禁词列表",width:"500"},{default:s(()=>[l("div",Kt,[t(M,{modelValue:z.value,"onUpdate:modelValue":e[14]||(e[14]=n=>z.value=n),placeholder:"输入敏感词",style:{width:"300px"}},null,8,["modelValue"]),t(u,{type:"primary",class:"ml-2",onClick:Ae},{default:s(()=>e[46]||(e[46]=[r("添加")])),_:1,__:[46]})]),t(se,{data:Y.value,style:{width:"100%"}},{default:s(()=>[t(C,{prop:"id",label:"ID",width:"80"}),t(C,{prop:"word",label:"词语"}),t(C,{label:"操作",width:"120"},{default:s(({row:n})=>[t(u,{type:"danger",size:"small",onClick:H=>xe(n.id)},{default:s(()=>e[47]||(e[47]=[r("删除")])),_:2,__:[47]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])])}}}),ta=Be(Jt,[["__scopeId","data-v-9ab88784"]]);export{ta as default};
